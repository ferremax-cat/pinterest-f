<!DOCTYPE html>
<html lang="en">
     <!-- VersiÃ³n desarrollo - Ãšltima actualizaciÃ³n: 21/11/2023 -->
<head>
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Ferremax-Catalogo</title>
     <link rel="stylesheet" href="estilos-copia.css">
     <link rel="stylesheet" href="fontawesome/css/all.min.css">
     <link rel="shortcut icon" href="img/logo.png" type="image/x-icon">
     <!-- AGREGAR EN EL HEAD - DespuÃ©s de estilos-copia.css -->
     <link rel="stylesheet" href="css/estilos-busqueda-clientes.css"> 
     <!-- Agregamos la librerÃ­a XLSX -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
     <!-- Menu principal -->
     <nav>
          <div class="img-logo">
               <img class="logo" src="img/logo.png" alt="Logo" class="logo">
          </div>
          <a href="login.html" class="btn">Inicio</a>

          <div class="input-container">
               <input type="text" placeholder="Buscar">
               <i class="fas fa-search"></i>
          </div>

          <div class="iconos">
                <!-- <span class=""></span>
               <span class=""></span> -->
               <!-- <div class="perfil-container">
                    <img class="img-perfil" src="img/perfil.jpg" alt="">
               </div>-->
               <span class="fas fa-angle-down" id="menu-funcionalidades-trigger"></span>
          </div>
     </nav>

     <!-- Barra de Salud Financiera -->
     <div id="barra-salud-financiera" class="barra-salud-financiera" style="display: none;">
          <div class="barra-salud-content">
               <div class="cliente-info">
                    <div class="cliente-nombre">
                         ðŸ’° <span id="cliente-nombre">---</span>
                    </div>
                    
                    <!-- Cupo (siempre visible) -->
                    <div class="dato-item">
                         <span class="dato-label">Cupo:</span>
                         <span class="cupo-valor cupo-verde" id="cupo-valor">$0</span>
                    </div>
                    
                    <!-- Datos principales (ocultos en mÃ³vil colapsado) -->
                    <div class="cliente-datos">
                         <div class="dato-item">
                              <span class="dato-label">PG Prom 3M:</span>
                              <span class="dato-valor" id="pg-prom">$0</span>
                         </div>
                         <div class="dato-item">
                              <span class="dato-label">ComprÃ³ este mes:</span>
                              <span class="dato-valor" id="compro">$0</span>
                         </div>
                    </div>
               </div>
               
               <!-- BotÃ³n expandir (solo mÃ³vil) -->
               <button class="boton-expandir" id="btn-expandir-salud">
                    <span id="btn-expandir-texto">â–¼</span>
               </button>
               
               <!-- Datos expandidos (ocultos por defecto en mÃ³vil) -->
               <div class="datos-expandidos" id="datos-expandidos">
                    <div class="dato-row">
                         <span class="dato-label">Saldo Total:</span>
                         <span class="dato-valor" id="saldo-total">$0</span>
                    </div>
                    <div class="dato-row">
                         <span class="dato-label">Pago este mes:</span>
                         <span class="dato-valor" id="pago-mes">$0</span>
                    </div>
               </div>
          </div>
     </div>


     <!-- Barra de informaciÃ³n contextual -->
     <div id="barra-info-contextual" class="barra-info-contextual">
     <div class="barra-info-content">
          <!-- El contenido se inyectarÃ¡ dinÃ¡micamente -->
     </div>
     </div>

     <!-- MenÃº de Funcionalidades -->
     <div id="menu-funcionalidades" class="menu-funcionalidades-container" style="display: none;">
          <div class="menu-funcionalidades-content">
               <!-- Los iconos se generarÃ¡n dinÃ¡micamente aquÃ­ -->
          </div>
     </div>

     <!-- Seccion de imagenes -->
     <section class="gallery-container">



          <div class="gallery-item">
               <div class="container-img">
                    <!--<img src="img/image1.jpg" alt="">-->
                    <img alt="">


                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!-- Seccion de imagenes 
                              <a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                             -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!-- <img src="img/logo-f.png" alt="">
                              -->
                         <a href=""></a>
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji-alerta.svg" alt="">
                         <!--<img src="icons/emoji2.svg" alt="">
                              -->
                         <span></span>
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">

                    <!-- lo cambio para cargar desde google driver
                    <img src="img/image2.jpg" alt=""> -->
                    <img alt=""> <!-- Solo quitamos el src, mantenemos la etiqueta img -->

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span>evo115co</a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>720</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                   
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">
                    
                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span>PERFA0261</a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>



          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <img src="icons/emoji4.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>800</span>
                              -->
                    </div>
               </div>
          </div>



          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji4.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>2850</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span> </a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <span>1000</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span> </a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span> </a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <img src="icons/emoji4.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>321</span>
                              -->
                    </div>
               </div>
          </div>



          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span> </a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>128</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">
                    <!--<img src="img/image17.jpg" alt="">-->

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>367</span>
                              -->
                    </div>
               </div>
          </div>



          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">
                    

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">
                    

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji3.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <span>752</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji3.svg" alt="">
                              <img src="icons/emoji1.svg" alt="">
                              <span>120</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <img src="icons/emoji4.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>321</span>
                              -->
                    </div>
               </div>
          </div>



     </section>




     <!-- Botones inferioes -->
     <div class="btn-inferiores">
          <a href=""><span class="fas fa-plus"></span></a>
          <a href=""><span class="fas fa-question"></span></a>
     </div>


     <!--AÃ±ade esto al inicio de tu HTML, antes de cualquier otro script-->
          <script>
          window.addEventListener('error', function(event) {
          console.error('Error global capturado:', event.error);
          });
          </script>



     <!-- Agregar el nuevo script al final -->
     <script type="module">

          import MonitoringSystem from './js/MonitoringSystem.js';
          import FallbackManager from './js/FallbackManager.js';
          //import CacheManager from '../js/cacheManager.js';
          import ProductManager from './js/productManager.js';
          import {config} from './js/config.js';
          import ImageLoader from './js/imageLoader.js';

          async function cargarImagenes() {
    try {
        console.log('Iniciando carga de imÃ¡genes...');
        let imageMap;

        // 1. Intentar cargar desde localStorage primero
        const cachedData = localStorage.getItem('imageCatalog');
        if (cachedData) {
            try {
                const parsedCache = JSON.parse(cachedData);
                imageMap = parsedCache.images;
                console.log('ImÃ¡genes cargadas desde localStorage:', Object.keys(imageMap).length);
            } catch (e) {
                console.warn('Error al parsear datos del localStorage:', e);
            }
        }

        // 2. Si no hay datos en localStorage, cargar desde JSON
        if (!imageMap) {
            console.log('No hay datos en localStorage, cargando desde JSON...');
            const response = await fetch('./json/catalogo_imagenes.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const catalogoImagenes = await response.json();
            imageMap = catalogoImagenes.images;
            
            // Guardar en localStorage para prÃ³xima carga
            localStorage.setItem('imageCatalog', JSON.stringify(catalogoImagenes));
            console.log('Datos guardados en localStorage para futuro uso');
        }

        // 3. Actualizar las imÃ¡genes en la interfaz
        document.querySelectorAll('.gallery-item').forEach(item => {
            const bottomRow = item.querySelector('.bottom-row a');
            if (bottomRow) {
                const codigo = bottomRow.textContent.trim();
                const codigoLimpio = codigo.replace(/\s+/g, '');

                if (imageMap[codigoLimpio]) {
                    const imgUrl = `https://lh3.googleusercontent.com/d/${imageMap[codigoLimpio]}`;
                    const img = item.querySelector('img');
                    if (img) {
                        img.src = imgUrl;
                        console.log(`Imagen actualizada: ${codigoLimpio}`);
                    }
                } else {
                    console.log(`No se encontrÃ³ ID para el cÃ³digo: ${codigoLimpio}`);
                }
            }
        });

    } catch (error) {
        console.error('Error cargando imÃ¡genes:', error);
        // Si hay error total, podrÃ­amos implementar otro fallback aquÃ­
    }
}
          // En catalogo.html

          document.addEventListener('DOMContentLoaded', async function() {

               console.log('Verificando bandera de focus en localStorage:', localStorage.getItem('setFocusOnLoad'));
  
               // Verificar si necesitamos establecer el foco en el campo de bÃºsqueda
               if (localStorage.getItem('setFocusOnLoad') === 'true') {
               console.log('Bandera de foco detectada, estableciendo foco...');
               // Limpiar la bandera
               localStorage.removeItem('setFocusOnLoad');
               
               // Establecer el foco inmediatamente Y tambiÃ©n con un retraso para mayor seguridad
               const searchInput = document.querySelector('input[type="text"]');
               if (searchInput) {
                    searchInput.focus();
                    console.log('Primer intento de foco establecido');
                    
                    // TambiÃ©n intentarlo despuÃ©s de un retraso (mayor probabilidad de Ã©xito)
                    setTimeout(() => {
                    searchInput.focus();
                    console.log('Segundo intento de foco establecido despuÃ©s de 500ms');
                    }, 500);
               } else {
                    console.log('No se encontrÃ³ el campo de bÃºsqueda');
               }
               } else {
               console.log('No se encontrÃ³ la bandera de foco');
               }


               // 1. AGREGAR al inicio la creaciÃ³n del MonitoringSystem
               const monitoringSystem = new MonitoringSystem();
               const fallbackManager = new FallbackManager();
               const startTime = performance.now();

               // 2. LUEGO verificar y obtener clientData
               const clientData = localStorage.getItem('clientData');
               if (!clientData) {
               console.log('No hay datos de cliente, usando modo bÃ¡sico');
               window.location.href = 'login.html';
               return;
               }


               //-- agregue 19-3-25

               // Verificar coherencia entre usuario y cachÃ© de productos
               //const clientData = localStorage.getItem('clientData');
               const cacheProductsData = localStorage.getItem('cache_products_data');
               
               if (clientData && cacheProductsData) {
                    const clientInfo = JSON.parse(clientData);
                    const cacheInfo = JSON.parse(cacheProductsData);
                    
                    // Verificar si la cachÃ© corresponde al usuario actual (por ejemplo, usando ID de cliente)
                    if (clientInfo.id !== cacheInfo.clientId) {
                         console.log('Se detectÃ³ cachÃ© de productos de otro usuario, limpiando...');
                         localStorage.removeItem('cache_products_data');
                         sessionStorage.removeItem('managersInitialized');
                    }
               }
               //--fin agregue 19-3-25





               // 3. DESPUÃ‰S parsear clientConfig
               const clientConfig = JSON.parse(clientData);


               // 1. AGREGAR primero la obtenciÃ³n de instancias
               window.productManager = ProductManager.getInstance({ 
               monitoringSystem,
               clientData: clientConfig 
               });

               // AÃ‘ADIR ESTA LÃNEA para exponer la instancia globalmente
               window.productManagerInstance = productManager;

               window.imageLoader = ImageLoader.getInstance({ 
               monitoringSystem,
               sheetId: config.sheetId
               });
               
               // Agregar al inicio del DOMContentLoaded

               

               //--agregue 19-3-25

               const managersInitialized = sessionStorage.getItem('managersInitialized') === 'true';
               

               // Agregar el control de inicializaciÃ³n - CAMBIAR ESTA LÃ“GICA
                    if (!managersInitialized || sessionStorage.getItem('needsReinitialization') === 'true') {
                    console.log('Necesaria inicializaciÃ³n de managers (primera vez o cambio de usuario)');
                    
                    // Limpiar la bandera de reinicializaciÃ³n si existe
                    sessionStorage.removeItem('needsReinitialization');
                    
                    try {
                         await Promise.all([
                              window.productManager.initialize(clientConfig),
                              window.imageLoader.initialize()
                         ]);
                         sessionStorage.setItem('managersInitialized', 'true');
                         console.log('Managers inicializados correctamente');
                    } catch (error) {
                         console.error('Error en inicializaciÃ³n de managers:', error);
                         throw error;
                    }
                    } else {
                    console.log('Managers ya inicializados, procediendo con la carga de galerÃ­a');
                    }

               //--fin agregue 19-3-25

               // Agregar el control de inicializaciÃ³n
               if (!managersInitialized) {
               console.log('Primera inicializaciÃ³n de managers');
               try {
                    await Promise.all([
                         window.productManager.initialize(clientConfig),
                         window.imageLoader.initialize()
                    ]);
                    sessionStorage.setItem('managersInitialized', 'true');
               } catch (error) {
                    console.error('Error en inicializaciÃ³n de managers:', error);
                    throw error;
               }
               } else {
               console.log('Managers ya inicializados, procediendo con la carga de galerÃ­a');
               }     


               //-----

               // Parte 2.1: Verificar estado y forzar inicializaciÃ³n si es necesario

               console.log('[DEBUG-INIT] Verificando estado de productManager...');
               console.log('[DEBUG-INIT] TamaÃ±o actual del mapa de productos:', window.productManager.products.size);

               // Comprobar si el sessionStorage estÃ¡ marcando una inicializaciÃ³n exitosa
               // pero en realidad no hay productos cargados
               //const managersInitialized = sessionStorage.getItem('managersInitialized') === 'true';
               const needsReinitialization = managersInitialized && window.productManager.products.size === 0;

               if (needsReinitialization) {
               console.log('[DEBUG-INIT] ADVERTENCIA: sessionStorage indica inicializaciÃ³n pero el mapa estÃ¡ vacÃ­o');
               console.log('[DEBUG-INIT] Forzando reinicializaciÃ³n...');
               
               // Borrar la marca de inicializaciÃ³n
               sessionStorage.removeItem('managersInitialized');
               
               // Intentar reinicializar manualmente
               try {
                    const clientConfig = JSON.parse(localStorage.getItem('clientData'));
                    console.log('[DEBUG-INIT] Reinicializando con clientConfig:', clientConfig);
                    
                    // Llamar a initialize directamente
                    await window.productManager.initialize(clientConfig);
                    
                    // Verificar nuevamente
                    console.log('[DEBUG-INIT] DespuÃ©s de reinicializaciÃ³n:', {
                         productsSize: window.productManager.products.size,
                         primeros3: Array.from(window.productManager.products.keys()).slice(0, 3)
                    });
                    
                    // Restaurar la marca de inicializaciÃ³n
                    sessionStorage.setItem('managersInitialized', 'true');
               } catch (error) {
                    console.error('[DEBUG-INIT] Error al reinicializar:', error);
               }
               }

              


               //-----




               try {

                    const monitoringSystem = new MonitoringSystem();
                    const fallbackManager = new FallbackManager();
                    const startTime = performance.now();

               // 1. Verificar autenticaciÃ³n
               const clientData = localStorage.getItem('clientData');
               if (!clientData) {
                    console.log('No hay datos de cliente, usando modo bÃ¡sico');
                    window.location.href = 'login.html';
                    return;
               }

               const clientConfig = JSON.parse(clientData);
               

               // 2. Obtener instancias Ãºnicas de los managers
               /* window.productManager = ProductManager.getInstance({ 
                    monitoringSystem,
                    clientData: clientConfig 
               });
        
               window.imageLoader = ImageLoader.getInstance({ 
               monitoringSystem,
               sheetId: config.sheetId
               }); */




               // 3. Inicializar en orden correcto

               /* await window.productManager.initialize(clientConfig);
               await window.imageLoader.initialize();
               const productManager = window.productManager;
               const imageLoader = window.imageLoader; */

               // 4. Implementar bÃºsqueda
               const searchInput = document.querySelector('input[type="text"]');

               if (searchInput) {
                    searchInput.addEventListener('input', debounce(async function(e) {
                         const searchTerm = e.target.value.toLowerCase();
                         monitoringSystem.trackUsage('search', { term: searchTerm });
                         const items = document.querySelectorAll('.gallery-item');

                         items.forEach(async item => {
                              const bottomRow = item.querySelector('.bottom-row a');
                              if (!bottomRow) return;

                              const codigo = bottomRow.textContent.trim().replace(/\s+/g, '');

                              const codigoMayus = codigo.toUpperCase();
                              console.log('[catalogo-html DEBUG-Precio 1]', {
                              codigoOriginal: codigo,
                              codigoMayus,
                              precio: await productManager.getPrice(codigoMayus)
                              });
                              

                              if (productManager) {
                              // Si existe ProductManager, usar su bÃºsqueda
                              const producto = productManager.getProduct(codigo);
                              if (producto) {
                                   const matchesBusqueda = 
                                        producto.codigo.toLowerCase().includes(searchTerm) ||
                                        producto.nombre.toLowerCase().includes(searchTerm) ||
                                        producto.categoria.toLowerCase().includes(searchTerm);

                                   item.style.display = matchesBusqueda ? '' : 'none';
                              }
                              } else {
                              // BÃºsqueda bÃ¡sica por cÃ³digo
                              const matchesBusqueda = codigo.toLowerCase().includes(searchTerm);
                              item.style.display = matchesBusqueda ? '' : 'none';
                              }
                         });
                    }, 300));
               }

               // 5. FunciÃ³n original de carga de imÃ¡genes
               async function cargarImagenes() {
                    try {

                         console.log('[catalogo.html- cargargarImagenes Precios 1]...metodo cargarImagenes');

                         const sheetId = '1IKRA31nI8N5dABByDoRWen5NbqiNFl2d';
                         const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

                         const response = await fetch(sheetUrl);
                         const text = await response.text();
                         const json = JSON.parse(text.substr(47).slice(0, -2));

                         const imageMap = {};
                         const priceMap = {};
                         json.table.rows.forEach(row => {
                              if (row.c[0]?.v && row.c[1]?.v) {
                              const nombreArchivo = row.c[0].v;
                              const codigo = nombreArchivo.replace(/\.(jpg|webp|png)$/, '');
                              const id = row.c[1].v;
                              const precio = row.c[5]?.v;
                              imageMap[codigo] = id;
                              if (precio) {
                                   priceMap[codigo] = precio;
                              }
                              }
                         });

                         console.log('Items encontrados:', document.querySelectorAll('.gallery-item').length);

                         document.querySelectorAll('.gallery-item').forEach(item => {
                              const bottomRow = item.querySelector('.bottom-row a');

                              console.log('[catalogo.html- cargargarImagenes Precios 1a] [Debug-bottomRow]', {
                              bottomRow,
                              item,
                              tieneBottomRow: !!bottomRow
                              });



                              if (bottomRow) {
                              const codigo = bottomRow.textContent.trim();

                              

                              const codigoLimpio = codigo.replace(/\s+/g, '');

                              if (imageMap[codigoLimpio]) {
                                   const imgUrl = `https://lh3.googleusercontent.com/d/${imageMap[codigoLimpio]}`;
                                   const img = item.querySelector('img');
                                   if (img) {
                                        img.src = imgUrl;
                                   }
                              }

                              //const precio = priceMap[codigoLimpio]; // VIEJO
                              console.log('[catalogo.html- cargargarImagenes Precios 2] Debug precio:', codigoLimpio, productManager.getPrice(codigoLimpio));
                              
                              if (priceMap[codigoLimpio]) {
                                   const precio = productManager.getPrice(codigoLimpio); // NUEVO
                                   const bottomRowDiv = item.querySelector('.bottom-row');
                                   let precioElement = bottomRowDiv.querySelector('.price-tag');
                                   if (!precioElement) {
                                        precioElement = document.createElement('span');
                                        precioElement.className = 'price-tag';
                                        bottomRowDiv.appendChild(precioElement);
                                   }
                                   precioElement.textContent = `$${precio.toLocaleString('es-AR')}`;

                                   console.log('[catalogo.html- cargargarImagenes Precios 3]', {
                                   precio,
                                   elementoCreado: precioElement.textContent,
                                   padreVisible: bottomRowDiv.offsetParent !== null,
                                   elementoVisible: precioElement.offsetParent !== null
                                   });

                              }
                              }
                         });
                    } catch (error) {
                         console.error('Error en carga bÃ¡sica:', error);
                    }
               }

               // 5. Nueva implementaciÃ³n usando managers

               // FunciÃ³n para cargar la galerÃ­a
               const galleryItems = document.querySelectorAll('.gallery-item');
                    console.log('[Debug-Gallery]', {
                    itemsEncontrados: galleryItems.length,
                    primerItem: galleryItems[0]
                    });
               



               async function cargarGaleria() {
                    try {
                         console.log('Iniciando cargarGaleria');

                         console.log('URL base para imÃ¡genes:', 'https://lh3.googleusercontent.com/d/');
                         console.log('Cache actual:', localStorage.getItem('imageCatalog'));

                         // 1. Obtener los cÃ³digos permitidos del clientData
                         const clientData = JSON.parse(localStorage.getItem('clientData'));
                         console.log('=== Datos del Cliente ===', {
                         tieneProductCodes: !!clientData?.productCodes,
                         listaPrecio: clientData?.priceList,
                         cantidadProductos: clientData?.productCodes?.length
                         });
                         

                         // 2. Cargar catÃ¡logo de imÃ¡genes
                         const response = await fetch('./json/catalogo_imagenes.json');
                         const catalogoImagenes = await response.json();
                         console.log('CatÃ¡logo de imÃ¡genes cargado:', catalogoImagenes);

                         console.log('ClientData en cargarGaleria:', clientData);
                         console.log('Productos permitidos:', clientData?.productCodes);

                         if (!clientData || !clientData.productCodes) {
                         console.error('No hay datos de productos permitidos para el cliente');
                         return;
                         }



                         //parte 1-producto. Obtener los cÃ³digos de productos
                         // Solo continuar con los productos permitidos
                         const productosPermitidos = new Set(clientData?.productCodes || []);
                         console.log('Set de productos permitidos:', Array.from(productosPermitidos));

                         // -producto. Obtener todos los elementos de galerÃ­a
                         const galleryItems = document.querySelectorAll('.gallery-item');
                         console.log(`[DEBUG-P1] Total de elementos en galerÃ­a: ${galleryItems.length}`);

                         // Convertir el Set a Array para poder iterar por Ã­ndice
                         const productosPermitidosArray = Array.from(productosPermitidos);

                         // Iterar sobre los elementos de la galerÃ­a y asignar cÃ³digos
                         for (let i = 0; i < galleryItems.length; i++) {
                         const item = galleryItems[i];
                         
                         // Si ya no quedan productos permitidos, ocultar este elemento
                         if (i >= productosPermitidosArray.length) {
                              item.style.display = 'none';
                              continue;
                         }
                         
                         // Obtener el cÃ³digo del producto permitido correspondiente
                         const codigo = productosPermitidosArray[i];
                         const codigoMayus = codigo.toUpperCase();
                         
                         // Marcar el elemento con el cÃ³digo para futuras referencias
                         item.setAttribute('data-product-code', codigo);
                         item.style.display = ''; // Asegurarse de que sea visible
                         
                         // Actualizar el cÃ³digo en bottom-row
                         const bottomRow = item.querySelector('.bottom-row a');
                         if (bottomRow) {
                              // Establecer el cÃ³digo manteniendo el Ã­cono
                              //bottomRow.innerHTML = `<span class="icon fas fa-arrow-up"></span>${codigoMayus}`;
                              // Establecer el cÃ³digo SIN el Ã­cono
                              bottomRow.innerHTML = `${codigoMayus}`;
                              console.log(`[DEBUG-P1] Asignado cÃ³digo ${codigoMayus} al elemento #${i}`);
                         }
                         }

                         console.log(`[DEBUG-P1] AsignaciÃ³n de cÃ³digos completada.`);
                         


                         // Parte producto: DiagnÃ³stico de productManager
                         console.log('[DEBUG-DIAGNÃ“STICO] Estado de productManager:', {
                         existe: !!window.productManager,
                         tieneGetProduct: typeof window.productManager.getProduct === 'function',
                         tieneProducts: !!window.productManager.products,
                         productosSize: window.productManager.products instanceof Map ? window.productManager.products.size : 'No es Map'
                         });

                         // Verificar si podemos acceder a los productos directamente
                         if (window.productManager.products instanceof Map) {
                         console.log('[DEBUG-DIAGNÃ“STICO] Primeros 3 productos en Map:');
                         let contador = 0;
                         for (const [key, value] of window.productManager.products.entries()) {
                              console.log(`  - ${key}:`, value);
                              contador++;
                              if (contador >= 3) break;
                         }
                         
                         // Verificar especÃ­ficamente si existe un producto
                         const primerCodigo = Array.from(productosPermitidos)[0].toUpperCase();
                         console.log(`[DEBUG-DIAGNÃ“STICO] Verificando si existe ${primerCodigo} en Map:`, window.productManager.products.has(primerCodigo));
                         console.log(`[DEBUG-DIAGNÃ“STICO] Producto ${primerCodigo} en Map:`, window.productManager.products.get(primerCodigo));
                         }

                         // Prueba con getProduct para el primer cÃ³digo
                         if (productosPermitidosArray.length > 0) {
                         const primerCodigo = productosPermitidosArray[0].toUpperCase();
                         console.log(`[DEBUG-DIAGNÃ“STICO] Intentando getProduct('${primerCodigo}'):`);
                         try {
                              const producto = window.productManager.getProduct(primerCodigo);
                              console.log(`  - Resultado:`, producto);
                         } catch (e) {
                              console.log(`  - Error:`, e);
                         }
                         }

                         console.log('[DEBUG-DIAGNÃ“STICO] DiagnÃ³stico completado.');

                         // Parte 1 producto:-fin








                         // Parte 2 producto: Agregar nombres de productos usando getProduct

                         // Iterar sobre los elementos que ya tienen cÃ³digos asignados
                         for (let i = 0; i < galleryItems.length; i++) {
                         const item = galleryItems[i];
                         
                         // Si el elemento estÃ¡ oculto, ignorarlo
                         if (item.style.display === 'none') continue;
                         
                         // Obtener el cÃ³digo asignado anteriormente
                         const codigo = item.getAttribute('data-product-code');
                         if (!codigo) continue;
                         
                         const codigoMayus = codigo.toUpperCase();
                         
                         // Intentar obtener el producto usando getProduct
                         const producto = window.productManager.getProduct(codigoMayus);
                         console.log(`[DEBUG-P2] Resultado getProduct(${codigoMayus}):`, producto);
                         
                         // Actualizar el nombre en top-row
                         const topRowLink = item.querySelector('.top-row a');
                         if (topRowLink) {
                              if (producto && producto.nombre) {
                                   topRowLink.textContent = producto.nombre.toLowerCase();
                                   console.log(`[DEBUG-P2] Actualizado nombre para ${codigoMayus} desde getProduct: ${producto.nombre}`);
                              } else {
                                   console.log(`[DEBUG-P2] No se pudo obtener nombre para ${codigoMayus} desde getProduct`);
                              }
                         }
                         }

                         console.log(`[DEBUG-P2] Intento de asignaciÃ³n de nombres completado.`);

                         // Parte 2 producto :-fin

                        




                         // Parte 3: Agregar precios a los productos

                         // Iterar sobre los elementos que ya tienen cÃ³digos y nombres asignados
                         for (let i = 0; i < galleryItems.length; i++) {
                         const item = galleryItems[i];
                         
                         // Si el elemento estÃ¡ oculto, ignorarlo
                         if (item.style.display === 'none') continue;
                         
                         // Obtener el cÃ³digo asignado anteriormente
                         const codigo = item.getAttribute('data-product-code');
                         if (!codigo) continue;
                         
                         const codigoMayus = codigo.toUpperCase();
                         
                         // Intentar obtener el precio del producto
                         try {
                              // Intentar primero con getPrice (mÃ©todo oficial)
                              const precio = await window.productManager.getPrice(codigoMayus);
                              console.log(`[DEBUG-PRECIOS] Precio obtenido para ${codigoMayus}:`, precio);
                              
                              if (precio !== null && precio !== undefined) {
                                   // Obtener o crear el elemento para el precio
                                   const bottomRowDiv = item.querySelector('.bottom-row');
                                   if (bottomRowDiv) {
                                        let precioElement = bottomRowDiv.querySelector('.price-tag');
                                        
                                        // Si no existe el elemento para el precio, crearlo
                                        if (!precioElement) {
                                             precioElement = document.createElement('span');
                                             precioElement.className = 'price-tag';
                                             bottomRowDiv.appendChild(precioElement);
                                        }
                                        
                                        // Actualizar el texto del precio
                                        precioElement.textContent = `$${precio.toLocaleString('es-AR')}`;
                                        console.log(`[DEBUG-PRECIOS] Precio mostrado para ${codigoMayus}: $${precio.toLocaleString('es-AR')}`);
                                   }
                              } else {
                                   console.log(`[DEBUG-PRECIOS] No se pudo obtener precio para ${codigoMayus}`);
                                   
                                   // Intentar obtener el precio directamente del producto como alternativa
                                   const producto = window.productManager.products.get(codigoMayus);
                                   if (producto && producto.precio) {
                                        const bottomRowDiv = item.querySelector('.bottom-row');
                                        if (bottomRowDiv) {
                                             let precioElement = bottomRowDiv.querySelector('.price-tag');
                                             if (!precioElement) {
                                             precioElement = document.createElement('span');
                                             precioElement.className = 'price-tag';
                                             bottomRowDiv.appendChild(precioElement);
                                             }
                                             precioElement.textContent = `$${producto.precio.toLocaleString('es-AR')}`;
                                             console.log(`[DEBUG-PRECIOS] Precio (alternativo) mostrado para ${codigoMayus}: $${producto.precio}`);
                                        }
                                   }
                              }
                         } catch (error) {
                              console.log(`[DEBUG-PRECIOS] Error al obtener precio para ${codigoMayus}:`, error);
                         }
                         }

                         console.log(`[DEBUG-PRECIOS] Proceso de asignaciÃ³n de precios completado.`);


                         // Parte 3 producto :-fin




                         // Parte 4: Cargar imÃ¡genes de productos

                         async function cargarImagenesProductos() {
                                   console.log('[DEBUG-IMAGENES] Iniciando carga de imÃ¡genes...');
                                   
                                   try {
                                        // 1. Intentar cargar el catÃ¡logo de imÃ¡genes desde JSON
                                        const response = await fetch('./json/catalogo_imagenes.json');
                                        if (!response.ok) {
                                             throw new Error(`Error al cargar catÃ¡logo de imÃ¡genes: ${response.status}`);
                                        }
                                        
                                        const catalogoImagenes = await response.json();
                                        console.log('[DEBUG-IMAGENES] CatÃ¡logo cargado:', {
                                             totalImagenes: Object.keys(catalogoImagenes.images || {}).length,
                                             ejemploImagen: Object.entries(catalogoImagenes.images || {}).slice(0, 1)
                                        });
                                        
                                        // 2. Iterar sobre los elementos de la galerÃ­a
                                        for (const item of galleryItems) {
                                             // Si el elemento estÃ¡ oculto, saltar
                                             if (item.style.display === 'none') continue;
                                             
                                             // Obtener el cÃ³digo del producto
                                             const codigo = item.getAttribute('data-product-code');
                                             if (!codigo) continue;
                                             
                                             const codigoMayus = codigo.toUpperCase();
                                             const codigoLower = codigo.toLowerCase();
                                             
                                             // Buscar la imagen en el catÃ¡logo (probar varias variantes del cÃ³digo)
                                             let imageId = null;
                                             if (catalogoImagenes.images) {
                                                  // Intentar con diferentes formatos de cÃ³digo
                                                  const variantes = [codigo, codigoMayus, codigoLower];
                                                  for (const variante of variantes) {
                                                       if (catalogoImagenes.images[variante]) {
                                                       imageId = catalogoImagenes.images[variante];
                                                       console.log(`[DEBUG-IMAGENES] ID encontrado para ${codigo}:`, imageId);
                                                       break;
                                                       }
                                                  }
                                             }
                                             
                                             // Si encontramos un ID de imagen, actualizar la imagen
                                             if (imageId) {
                                                  const imgElement = item.querySelector('img');
                                                  if (imgElement) {
                                                       // Usar URL directa de Google Drive
                                                       const imgUrl = `https://lh3.googleusercontent.com/d/${imageId}`;
                                                       imgElement.src = imgUrl;
                                                       imgElement.onload = () => console.log(`[DEBUG-IMAGENES] Imagen cargada para ${codigo}`);
                                                       imgElement.onerror = () => console.log(`[DEBUG-IMAGENES] Error al cargar imagen para ${codigo}`);
                                                  }
                                             } else {
                                                  console.log(`[DEBUG-IMAGENES] No se encontrÃ³ ID para ${codigo}`);
                                             }
                                        }
                                   } catch (error) {
                                        console.error('[DEBUG-IMAGENES] Error al cargar imÃ¡genes:', error);
                                        
                                        // Intentar plan B: usar imageLoader si estÃ¡ disponible
                                        if (window.imageLoader) {
                                             console.log('[DEBUG-IMAGENES] Intentando con imageLoader...');
                                             
                                             for (const item of galleryItems) {
                                                  if (item.style.display === 'none') continue;
                                                  
                                                  const codigo = item.getAttribute('data-product-code');
                                                  if (!codigo) continue;
                                                  
                                                  const imgElement = item.querySelector('img');
                                                  if (imgElement) {
                                                       try {
                                                       const url = await window.imageLoader.getImageUrl(codigo, 'desktop');
                                                       if (url) {
                                                            imgElement.src = url;
                                                            console.log(`[DEBUG-IMAGENES] Imagen cargada con imageLoader para ${codigo}`);
                                                       }
                                                       } catch (e) {
                                                       console.log(`[DEBUG-IMAGENES] Error con imageLoader para ${codigo}:`, e);
                                                       }
                                                  }
                                             }
                                        }
                                   }
                                   
                                   console.log('[DEBUG-IMAGENES] Proceso de carga de imÃ¡genes completado.');
                         }

                                   // Ejecutar la carga de imÃ¡genes
                                   cargarImagenesProductos();     

                         // Parte 4 producto :-fin



                        

                        
                    } catch (error) {
                         console.error('Error general en cargarGaleria:', error);
                    }
               }
               
               
               // 6. FunciÃ³n de precarga de imÃ¡genes
               //--- agrego 19-3-25

                    // ModificaciÃ³n de la funciÃ³n precargarSiguientesPaginas para implementar scroll infinito completo
               async function precargarSiguientesPaginas() {
                    if (!imageLoader) return;
                    
                    // â­ BLOQUEAR si estamos en modo bÃºsqueda de clientes
                    if (window.scrollPreloadBlocked || document.body.classList.contains('modo-busqueda-clientes')) {
                         console.log('[Precarga] âœ… BLOQUEADA - modo bÃºsqueda de clientes activo');
                         return;
                    }
                    console.log('Ejecutando precargarSiguientesPaginas para scroll infinito');
                    
                    try {
                         // 1. Obtener lista completa de productos disponibles (si aÃºn no la tenemos)
                         if (!window.allProducts || window.allProducts.length === 0) {
                              console.log('Cargando lista completa de productos...');
                              const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
                              
                              if (clientData?.productCodes && Array.isArray(clientData.productCodes)) {
                                   window.allProducts = clientData.productCodes;
                                   console.log(`Se cargaron ${window.allProducts.length} productos del clientData`);
                              } 
                              // Si tenemos productManager, intentar obtener productos de allÃ­
                              else if (window.productManager && window.productManager.products instanceof Map) {
                                   window.allProducts = Array.from(window.productManager.products.keys());
                                   console.log(`Se cargaron ${window.allProducts.length} productos del productManager`);
                              } else {
                                   console.log('No se pudo obtener lista de productos');
                                   return;
                              }
                         }

                         // 2. Determinar cuÃ¡ntos elementos ya tenemos cargados
                         const container = document.querySelector('.gallery-container');
                         const existingItems = container.querySelectorAll('.gallery-item');
                         const loadedCount = existingItems.length;
                         
                         console.log(`Elementos actuales: ${loadedCount}`);
                         
                         // 3. Determinar cuÃ¡ntos y cuÃ¡les cargar ahora
                         const batchSize = 10; // NÃºmero de elementos a cargar cada vez
                         const maxItems = 200; // LÃ­mite mÃ¡ximo de elementos
                         
                         // Verificar si ya alcanzamos el lÃ­mite o no hay mÃ¡s productos disponibles
                         if (loadedCount >= maxItems || loadedCount >= window.allProducts.length) {
                              console.log('Se alcanzÃ³ el lÃ­mite de elementos o no hay mÃ¡s productos disponibles');
                              return;
                         }
                         
                         // Calcular cuÃ¡ntos nuevos elementos cargar
                         const startIndex = loadedCount;
                         const endIndex = Math.min(startIndex + batchSize, window.allProducts.length, maxItems);
                         
                         if (startIndex >= endIndex) {
                              console.log('No hay mÃ¡s elementos para cargar');
                              return;
                         }
                         
                         // 4. Obtener los prÃ³ximos productos a cargar
                         const nextBatch = window.allProducts.slice(startIndex, endIndex);
                         console.log(`Cargando lote de ${nextBatch.length} productos (${startIndex} a ${endIndex-1})`);
                         
                         // 5. Mostrar indicador de carga
                         showLoadingIndicator();
                         
                         // 6. Crear y aÃ±adir los nuevos elementos
                         for (const codigo of nextBatch) {
                              if (!codigo) continue;
                              
                              const codigoMayus = codigo.toUpperCase();
                              
                              // Crear nuevo elemento clonando uno existente
                              const template = existingItems[0].cloneNode(true);
                              
                              // Establecer el cÃ³digo del producto como atributo
                              template.setAttribute('data-product-code', codigoMayus);
                              
                              // Actualizar cÃ³digo en bottom-row
                              const bottomRow = template.querySelector('.bottom-row a');
                              if (bottomRow) {
                                   //bottomRow.innerHTML = `<span class="icon fas fa-arrow-up"></span>${codigoMayus}`;
                                   // Establecer el cÃ³digo SIN el Ã­cono
                                   bottomRow.innerHTML = `${codigoMayus}`;
                              }
                              
                              // Actualizar nombre si estÃ¡ disponible
                              if (window.productManager) {
                                   try {
                                        const producto = window.productManager.getProduct(codigoMayus);

                                        // Limpiar el elemento del nombre antes de establecer un nuevo valor
                                        const topRowLink = template.querySelector('.top-row a');
                                        
                                        if (producto && producto.nombre) {
                                        //const topRowLink = template.querySelector('.top-row a');
                                        if (topRowLink) {
                                             topRowLink.textContent = ''; // Limpiar primero

                                             // Convertir a minÃºsculas aquÃ­, cuando se estÃ¡ cargando inicialmente
                                             topRowLink.textContent = producto.nombre.toLowerCase();
                                             console.log(`[DEBUG] Actualizado nombre para ${codigoMayus}: ${producto.nombre.toLowerCase()}`);
                                        }
                                        }else {
                                             // Si el producto no existe, mostrar "producto fuera de lista"
                                             topRowLink.textContent = "producto fuera de lista";
                                             console.log(`Producto no encontrado: ${codigoMayus}, usando texto genÃ©rico`);
                                        }

                                        



                                        
                                        // Agregar precio si estÃ¡ disponible
                                        if (producto && producto.precio) {
                                             const bottomRowDiv = template.querySelector('.bottom-row');
                                        
                                             if (bottomRowDiv) {
                                                  let precioElement = bottomRowDiv.querySelector('.price-tag');

                                                  if (precioElement) {
                                                       precioElement.textContent = ''; // Limpiar primero
                                                  }
                                                  
                                                  if (!precioElement) {
                                                       precioElement = document.createElement('span');
                                                       precioElement.className = 'price-tag';
                                                       bottomRowDiv.appendChild(precioElement);
                                                  }
                                                  
                                                  precioElement.textContent = `$${producto.precio.toLocaleString('es-AR')}`;
                                             }

                                        }else {
                                             // Si el producto no existe, mostrar "$0.00"
                                             const bottomRowDiv = template.querySelector('.bottom-row');
                                             let precioElement = bottomRowDiv.querySelector('.price-tag');
                                             precioElement.textContent = "$0.00";
                                             console.log(`Precio no encontrado para ${codigoMayus}, usando $0.00`);
                                        }




                                   } catch (error) {
                                        
                                        console.log(`Error al obtener datos para ${codigoMayus}:`, error);
                                   }
                              }
                              



                              // Limpiar la imagen para que no herede la del template
                              const imgElement = template.querySelector('img');
                              if (imgElement) {
                                   imgElement.src = '';
                                   imgElement.alt = codigoMayus;
                              }
                              
                              // AÃ±adir el nuevo elemento al contenedor
                              container.appendChild(template);
                              
                              // Cargar la imagen del producto
                              loadProductImage(template, codigoMayus);
                         }
                         
                         // 7. Ocultar indicador de carga despuÃ©s de un breve retraso
                         setTimeout(() => {
                              hideLoadingIndicator();
                         }, 500);
                         
                         console.log(`Se agregaron ${nextBatch.length} nuevos elementos.`);
                         
                         } catch (error) {
                         console.error('Error en precargarSiguientesPaginas:', error);
                         hideLoadingIndicator();
                    }
               }

               // AÃ±adir esto despuÃ©s de la funciÃ³n precargarSiguientesPaginas
               window.addEventListener('resetCatalogo', function(event) {
                    console.log('Evento resetCatalogo recibido, recargando catÃ¡logo inicial');
                    
                    try {
                    // Verificar si hay elementos de galerÃ­a para usar como plantilla
                    const existingItems = document.querySelectorAll('.gallery-item');
                    
                    if (existingItems.length === 0) {
                         console.log("No hay elementos de galerÃ­a existentes. Recargando la pÃ¡gina...");
                         window.location.reload(); // SoluciÃ³n nuclear: recargar la pÃ¡gina
                         return;
                    }
                    
                    // Restablecer variables de seguimiento
                    if (window.allProducts) {
                         window.currentProductIndex = 0;
                    }
                    
                    // IMPORTANTE: Resetear la variable isLoading para el scroll
                    window.isLoading = false;
                    
                    // Cargar los productos iniciales con un pequeÃ±o retraso
                    setTimeout(() => {
                         try {
                         precargarSiguientesPaginas(0);
                         console.log("CatÃ¡logo recargado exitosamente");
                         
                         // IMPORTANTE: Asegurarse de que el scroll infinite estÃ© funcionando
                         // Simular un pequeÃ±o scroll para activar el evento
                         setTimeout(() => {
                              window.scrollBy(0, 10);
                              console.log("Scroll infinito reactivado");
                         }, 1000);
                         
                         } catch (error) {
                         console.error("Error al recargar el catÃ¡logo:", error);
                         window.location.reload(); // Si hay error, recargar la pÃ¡gina
                         }
                    }, 100);
                    
                    } catch (error) {
                    console.error("Error en el manejador de resetCatalogo:", error);
                    window.location.reload(); // Si hay error, recargar la pÃ¡gina
                    }
                    });



               // FunciÃ³n auxiliar para cargar la imagen de un producto
               async function loadProductImage(element, codigo) {
               try {
                    const imgElement = element.querySelector('img');
                    if (!imgElement) return;
                    
                    // Intentar cargar desde catalogoImagenes
                    try {
                         const response = await fetch('./json/catalogo_imagenes.json');
                         
                         if (response.ok) {
                              const catalogoImagenes = await response.json();
                              
                              // Intentar con diferentes variantes del cÃ³digo
                              const variantes = [codigo, codigo.toLowerCase(), codigo.toUpperCase()];
                              let imageId = null;
                              
                              for (const variante of variantes) {
                                   if (catalogoImagenes.images && catalogoImagenes.images[variante]) {
                                   imageId = catalogoImagenes.images[variante];
                                   break;
                                   }
                              }
                              
                              if (imageId) {
                                   imgElement.src = `https://lh3.googleusercontent.com/d/${imageId}`;
                                   return;
                              }
                         }
                    } catch (error) {
                         console.log(`Error al cargar imagen de catÃ¡logo para ${codigo}:`, error);
                    }
                    
                    // Alternativa: usar imageLoader si estÃ¡ disponible
                    if (window.imageLoader) {
                         try {
                              const url = await window.imageLoader.getImageUrl(codigo, 'desktop');
                              if (url) {
                                   imgElement.src = url;
                              }
                         } catch (error) {
                              console.log(`Error al cargar imagen con imageLoader para ${codigo}:`, error);
                         }
                    }
               } catch (error) {
                    console.error(`Error general al cargar imagen para ${codigo}:`, error);
               }
               }

               // Funciones auxiliares para el indicador de carga
               function showLoadingIndicator() {
               let loadingIndicator = document.querySelector('.infinite-scroll-loading');
               
               if (!loadingIndicator) {
                    loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'infinite-scroll-loading';
                    loadingIndicator.innerHTML = `
                         <div class="loading-spinner">
                              <i class="fas fa-spinner fa-spin"></i>
                              <span>Cargando mÃ¡s productos...</span>
                         </div>
                    `;
                    loadingIndicator.style.textAlign = 'center';
                    loadingIndicator.style.padding = '20px';
                    loadingIndicator.style.color = '#666';
                    
                    const container = document.querySelector('.gallery-container');
                    container.parentNode.insertBefore(loadingIndicator, container.nextSibling);
               } else {
                    loadingIndicator.style.display = 'block';
               }
               }

               function hideLoadingIndicator() {
               const loadingIndicator = document.querySelector('.infinite-scroll-loading');
               if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
               }
               }

               // Agregar estilos para el indicador de carga y el precio
               function addInfiniteScrollStyles() {
               if (document.querySelector('#infinite-scroll-styles')) return;
               
               const style = document.createElement('style');
               style.id = 'infinite-scroll-styles';
               style.textContent = `
                    .loading-spinner {
                         display: flex;
                         align-items: center;
                         justify-content: center;
                         gap: 10px;
                         padding: 15px;
                    }
                    
                    .price-tag {
                         background-color: rgba(0, 0, 0, 0.7);
                         color: white;
                         padding: 3px 8px;
                         border-radius: 4px;
                         margin-left: 10px;
                         font-weight: bold;
                    }
               `;
               document.head.appendChild(style);
               }

               // Inicializar estilos cuando se carga la pÃ¡gina
               document.addEventListener('DOMContentLoaded', function() {
               addInfiniteScrollStyles();
               });

               //--- fin agrego 19-3-25





               
               // 7. Scroll infinito
               let isLoading = false;
               window.addEventListener('scroll', debounce(async function() {
                    if (isLoading) return;

                    const lastItem = document.querySelector('.gallery-item:last-child');
                    if (!lastItem) return;

                    const lastItemRect = lastItem.getBoundingClientRect();

                    // Cambio aquÃ­: de 1.5 a 3 veces la altura de la ventana
                    // Esto inicia la carga cuando el usuario estÃ¡ mÃ¡s lejos del final
                    if (lastItemRect.bottom < window.innerHeight * 3) {
                         isLoading = true;
                         // CAMBIO CLAVE: Verificar si hay una bÃºsqueda activa
                         const searchInput = document.querySelector('input[type="text"]');
                         if (searchInput && searchInput.value.trim() !== '') {
                              console.log("[search-engine] Cargando mÃ¡s resultados de bÃºsqueda por scroll");
                              await cargarMasResultadosBusqueda();
                         } else {
                              console.log("[catalogo] Cargando siguiente pÃ¡gina del catÃ¡logo por scroll");
                              await precargarSiguientesPaginas();
                         }
                         
                         isLoading = false;
                         }
               }, 200));


               // AÃ±adir esta funciÃ³n despuÃ©s de performSearch
                    async function cargarMasResultadosBusqueda() {
                    const loadMoreButton = document.getElementById('load-more-button');
                    if (loadMoreButton) {
                    loadMoreButton.click(); // Reutiliza la lÃ³gica existente del botÃ³n
                    }
                    }

              // 6. Sistemas principal y fallback
               const primarySystem = async () => {
                    try {
                         monitoringSystem.trackPerformance('loadTime', performance.now() - startTime);

                    if (!window.productManager || !window.imageLoader) {
                    throw new Error('Componentes no inicializados');
                    }

               await cargarGaleria();
               monitoringSystem.trackUsage('pageView', { page: 'catalogo' });

               } catch (error) {
               monitoringSystem.trackError(error, 'primarySystem');
               throw error;
               }
               };

               const fallbackSystem = async () => {
                    try {
                         await cargarImagenes();
                         monitoringSystem.trackUsage('pageView', { page: 'catalogo-fallback' });
                    } catch (error) {
                         monitoringSystem.trackError(error, 'fallbackSystem');
                         throw error;
                    }
               };

               // 7. Iniciar carga
               await fallbackManager.manageSystems(primarySystem, fallbackSystem);
                              // 8. Limpieza al cerrar
                              window.addEventListener('beforeunload', () => {
                                   if (window.imageLoader) {
                                        window.imageLoader.cleanup();
                                   }
                                   monitoringSystem.trackUsage('pageClose', {
                                        duration: performance.now() - startTime
                              });
                         });
                         


               } catch (error) {
               console.error('Error en inicializaciÃ³n:', error);
               // Si todo falla, intentar carga bÃ¡sica
               await cargarImagenes();
                }


                // ================================================
               // SISTEMA DE MÃRGENES - CÃ“DIGO COMPLETAMENTE MODULAR
               // ================================================

               // FUNCIÃ“N PRINCIPAL - Agregar al final del DOMContentLoaded existente
               function initializeMarginSystem() {
               console.log('ðŸŽ¯ Inicializando sistema de mÃ¡rgenes...');
               
               // 0. Restaurar estado despuÃ©s de recarga (si aplica)
               restoreMarginStateAfterReload();
               
               // 1. Cargar configuraciÃ³n del cliente
               loadMarginConfiguration();
               
               // 2. Crear UI del toggle
               createPriceToggleUI();
               
               // 3. Configurar interceptores
               setupPriceInterceptors();

               
               
               console.log('âœ… Sistema de mÃ¡rgenes inicializado');
               }

               // ================================================
               // CONFIGURACIÃ“N DE MÃRGENES
               // ================================================

               function loadMarginConfiguration() {
                    try {
                         console.log('ðŸ“‹ Cargando configuraciÃ³n de mÃ¡rgenes...');
                         
                         // Obtener ID del cliente actual
                         const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
                         const clientId = clientData.account || clientData.id || clientData.cuenta;
                         
                         if (!clientId) {
                              console.log('âš ï¸ No se encontrÃ³ ID de cliente');
                              setDefaultMarginConfig();
                              return;
                         }

                         // AGREGAR AQUÃ - VerificaciÃ³n de cambio de cliente
                         const lastClientId = localStorage.getItem('lastLoggedClientId');
                         if (lastClientId && lastClientId !== clientId) {
                         console.log('ðŸ”„ Detectado cambio de cliente, limpiando configuraciÃ³n anterior');
                         localStorage.removeItem('margenCliente');
                         localStorage.removeItem('precioModo');
                         localStorage.removeItem('margenTimestamp'); // AGREGAR ESTA LÃNEA
                         }

                         // Guardar el cliente actual para futuras verificaciones
                         localStorage.setItem('lastLoggedClientId', clientId);
                         
                         // Intentar cargar desde JSON de mÃ¡rgenes
                         fetch('./json/margenes_clientes.json')
                              .then(response => response.json())
                              .then(margenes => {
                                   console.log('ðŸ“‹ JSON completo cargado:', margenes);
                                   console.log('ðŸ” Buscando cliente:', clientId);
                                   console.log('ðŸ” Datos del cliente:', margenes[clientId]);
                                   if (margenes[clientId]) {
                                        console.log(`âœ… ConfiguraciÃ³n encontrada para cliente ${clientId}`);
                                        console.log('ðŸ“Š Margen del cliente:', margenes[clientId].margen);
                                        console.log('ðŸ‘ï¸ Modo del cliente:', margenes[clientId].mostrar);
                                        
                                        // Guardar en localStorage con prioridad sobre JSON
                                        // PRIORIDAD: localStorage primero, JSON como backup
                                        const currentMargen = localStorage.getItem('margenCliente');
                                        const currentModo = localStorage.getItem('precioModo');

                                        if (!currentMargen) {
                                        localStorage.setItem('margenCliente', margenes[clientId].margen || 0);
                                        }

                                        if (!currentModo) {
                                        localStorage.setItem('precioModo', margenes[clientId].mostrar || 'lista');
                                        }

                                        // Actualizar el input visual con el nuevo margen
                                        setTimeout(() => {
                                        const marginInput = document.getElementById('marginInput');
                                        if (marginInput) {
                                             marginInput.value = margenes[clientId].margen || 0;
                                             console.log('ðŸ“± Input actualizado con margen:', margenes[clientId].margen);
                                        }
                                        
                                        // TambiÃ©n actualizar el toggle
                                        setInitialToggleState();
                                        // AGREGAR ESTA LÃNEA: Recalcular todos los precios
                                        recalculateAllVisiblePrices();

                                        }, 500);
                                   } else {
                                        console.log(`âš ï¸ No se encontrÃ³ configuraciÃ³n para cliente ${clientId}`);
                                        setDefaultMarginConfig();
                                   }
                              })
                              .catch(error => {
                                   console.log('âš ï¸ Error cargando mÃ¡rgenes, usando valores por defecto:', error);
                                   setDefaultMarginConfig();
                              });
                              
                    } catch (error) {
                         console.error('âŒ Error en loadMarginConfiguration:', error);
                         setDefaultMarginConfig();
                    }
               }

               function setDefaultMarginConfig() {
               if (!localStorage.getItem('margenCliente')) {
                    localStorage.setItem('margenCliente', '0');
               }
               if (!localStorage.getItem('precioModo')) {
                    localStorage.setItem('precioModo', 'lista');
               }
               }

               // ================================================
               // INTERFAZ DE USUARIO - TOGGLE
               // ================================================

               function createPriceToggleUI() {
               try {
                    console.log('ðŸŽ¨ Creando toggle de precios...');
                    
                    // Buscar el contenedor de la navbar
                    const navbar = document.querySelector('nav');
                    const inputContainer = document.querySelector('.input-container');
                    const iconos = document.querySelector('.iconos');
                    
                    if (!navbar || !inputContainer || !iconos) {
                         console.log('âš ï¸ No se encontraron elementos de navbar');
                         return;
                    }
                    
                    // Crear toggle container
                    const toggleContainer = document.createElement('div');
                    toggleContainer.className = 'price-toggle-container';
                    toggleContainer.innerHTML = `
                         <div class="price-toggle">
                              <span class="toggle-label">P.L</span>
                              <label class="toggle-switch">
                                   <input type="checkbox" id="priceToggle">
                                   <span class="slider"></span>
                              </label>
                              <span class="toggle-label">P.V</span>
                         </div>
                         <div class="margin-input-container" style="display: none;">
                              <input type="number" id="marginInput" placeholder="%" min="0" max="100" step="1">
                              <button id="marginSaveBtn">OK</button>
                         </div>
                    `;
                    
                    // Insertar entre input y iconos
                    navbar.insertBefore(toggleContainer, iconos);
                    
                    // Aplicar estilos
                    addToggleStyles();
                    
                    // Configurar eventos
                    setupToggleEvents();
                    
                    // Establecer estado inicial
                    setInitialToggleState();
                    
                    console.log('âœ… Toggle de precios creado');
                    
               } catch (error) {
                    console.error('âŒ Error en createPriceToggleUI:', error);
               }
               }

               function addToggleStyles() {
               if (document.querySelector('#price-toggle-styles')) return;
               
               const style = document.createElement('style');
               style.id = 'price-toggle-styles';
               style.textContent = `
                    .price-toggle-container {
                         display: flex;
                         align-items: center;
                         gap: 10px;
                         margin: 0 20px;
                    }


                    /* Media query especÃ­fica para dispositivos mÃ³viles */
                    @media screen and (max-width: 768px) {
                    .price-toggle-container {
                         display: flex !important;
                         align-items: center !important;
                         gap: 5px !important;
                         margin: 0 10px !important;
                         flex-wrap: nowrap !important;
                         flex-shrink: 0 !important;
                    }
                    
                    .price-toggle {
                         
                         min-height: 35px !important;
                         display: flex !important;
                         align-items: center !important;
                    }
                    
                    .toggle-label {
                         font-size: 15px !important;
                    }
                    
                    .toggle-switch {
                         width: 30px !important;
                         height: 16px !important;
                    }
                    
                    .slider:before {
                         height: 12px !important;
                         width: 12px !important;
                    }
                    
                    input:checked + .slider:before {
                         transform: translateX(14px) !important;
                    }
                    
                    .margin-input-container {
                         padding: 3px 6px !important;
                         min-height: 35px !important;
                         display: flex !important;
                         align-items: center !important;
                    }
                    
                    #marginInput {
                         width: 35px !important;
                         font-size: 15px !important;
                    }
                    
                    #marginSaveBtn {
                         width: 23px !important;
                         height: 23px !important;
                         font-size: 11px !important;
                    }
                    }
                    
                    .price-toggle {
                         display: flex;
                         align-items: center;
                         gap: 8px;
                         background: white;
                         padding: 5px 10px;
                         border-radius: 20px;
                         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    }
                    
                    .toggle-label {
                         font-size: 12px;
                         font-weight: bold;
                         color: #666;
                    }
                    
                    .toggle-switch {
                         position: relative;
                         display: inline-block;
                         width: 40px;
                         height: 20px;
                    }
                    
                    .toggle-switch input {
                         opacity: 0;
                         width: 0;
                         height: 0;
                    }
                    
                    .slider {
                         position: absolute;
                         cursor: pointer;
                         top: 0;
                         left: 0;
                         right: 0;
                         bottom: 0;
                         background-color: #ccc;
                         transition: .4s;
                         border-radius: 20px;
                    }
                    
                    .slider:before {
                         position: absolute;
                         content: "";
                         height: 16px;
                         width: 16px;
                         left: 2px;
                         bottom: 2px;
                         background-color: white;
                         transition: .4s;
                         border-radius: 50%;
                    }
                    
                    input:checked + .slider {
                         background-color: #ff8c00;
                    }
                    
                    input:checked + .slider:before {
                         transform: translateX(20px);
                    }
                    
                    .margin-input-container {
                         display: flex;
                         align-items: center;
                         gap: 5px;
                         background: white;
                         padding: 3px 8px;
                         border-radius: 15px;
                         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                         overflow: visible;         /* AGREGAR esta lÃ­nea */
                    }
                    
                    #marginInput {
                         width: 60px;               /* MANTENER en 60px */
                         min-width: 60px;           /* Asegurar ancho mÃ­nimo */
                         min-height: 25px;          /* Asegurar altura mÃ­nima */
                         border: none;
                         outline: none;
                         text-align: center;
                         font-size: 12px;
                         padding: 0 2px;            /* Padding mÃ­nimo */
                         box-sizing: content-box;   /* No incluir padding en el ancho */
                         overflow: visible;         /* Permitir que el contenido sea visible */
                    }
                    
                    #marginSaveBtn {
                         background: #ff8c00;
                         color: white;
                         border: none;
                         border-radius: 50%;
                         width: 20px;
                         height: 20px;
                         cursor: pointer;
                         font-size: 10px;
                    }
                    
                    .price-tag.lista {
                         background-color: rgba(0, 0, 0, 0.7);
                         color: white !important;  /* Agregar !important para forzar el color */
                    }
                    
                    .price-tag.venta {
                         background-color: rgba(255, 140, 0, 0.9);
                         color: white;
                         border-radius: 10px;  /* NUEVA LÃNEA: esquinas redondeadas */
                    }
                    
                    .price-tag {
                         padding: 3px 8px;
                         border-radius: 10px;  /* Aumentar de 4px a 6px para mÃ¡s redondeo */
                         margin-left: 10px;
                         font-weight: bold;
                         transition: all 0.3s ease;
                    }

                    /* Reducir ancho del campo de bÃºsqueda para dar espacio al toggle */
                    .input-container {
                    flex: 0.8 !important; /* Reducir de tamaÃ±o completo a 80% */
                    }

                    .input-container input[type="text"] {
                    width: 100% !important; /* Mantener responsive dentro del contenedor reducido */
                    }
               `;
               
               document.head.appendChild(style);
               }

               function setupToggleEvents() {
                    const toggle = document.getElementById('priceToggle');
                    const marginContainer = document.querySelector('.margin-input-container');
                    const marginInput = document.getElementById('marginInput');
                    const marginSaveBtn = document.getElementById('marginSaveBtn');
                    
                    if (!toggle) return;
                    
                    // Toggle entre P.L y P.V
                    toggle.addEventListener('change', function() {
                         const nuevoModo = this.checked ? 'venta' : 'lista';
                         localStorage.setItem('precioModo', nuevoModo);
                         
                         console.log(`ðŸ”„ Cambio a modo: ${nuevoModo}`);
                         
                         if (nuevoModo === 'venta') {
                              marginContainer.style.display = 'flex';
                              marginInput.value = localStorage.getItem('margenCliente') || '0';
                         } else {
                              marginContainer.style.display = 'none';
                         }
                         
                         // Recalcular todos los precios
                         recalculateAllVisiblePrices();

                         // Forzar procesamiento de elementos no procesados
                         setTimeout(() => {
                         const unprocessedElements = document.querySelectorAll('.price-tag:not([data-processed])');
                         if (unprocessedElements.length > 0) {
                              console.log(`Procesando ${unprocessedElements.length} elementos no interceptados`);
                              unprocessedElements.forEach(el => {
                                   const precio = parseInt(el.textContent.replace(/[^0-9]/g, ''));
                                   if (precio) {
                                        el.dataset.originalPrice = precio;
                                        el.dataset.processed = 'true';
                                   }
                              });
                              recalculateAllVisiblePrices();
                         }
                         }, 100);

                         

                         // NUEVA LÃNEA: Enfocar campo de bÃºsqueda
                         focusSearchInput();
                    });
                    
                    // Guardar margen
                    if (marginSaveBtn) {
                         marginSaveBtn.addEventListener('click', function() {
                              const nuevoMargen = parseInt(marginInput.value) || 0;
                              
                              if (nuevoMargen >= 0 && nuevoMargen <= 100) {
                                   localStorage.setItem('margenCliente', nuevoMargen.toString());
                                   console.log(`ðŸ’¾ Margen guardado: ${nuevoMargen}%`);


                                   // 1. Cambiar el modo local a venta
                                        localStorage.setItem('precioModo', 'venta');

                                        // 2. Actualizar el toggle visualmente
                                        const toggle = document.getElementById('priceToggle');
                                        if (toggle) {
                                        toggle.checked = true; // Marcar como P.V
                                        }

                                        // 3. Mostrar el contenedor de margen
                                        const marginContainer = document.querySelector('.margin-input-container');
                                        if (marginContainer) {
                                        marginContainer.style.display = 'flex';
                                        }
                                   
                                   // Enviar a Google Form
                                   sendMarginToGoogleForm(nuevoMargen);
                                   
                                   // Recalcular precios
                                   recalculateAllVisiblePrices();
                                   
                                   // Feedback visual
                                   // Cambiar color del botÃ³n en lugar de sÃ­mbolo
                                   marginSaveBtn.textContent = 'OK!';
                                   marginSaveBtn.style.backgroundColor = 'green';
                                   setTimeout(() => {
                                   marginSaveBtn.textContent = 'OK';
                                   marginSaveBtn.style.backgroundColor = '#ff8c00'; // Volver al naranja original
                                   }, 1000);

                                   // NUEVA LÃNEA: Enfocar campo de bÃºsqueda
                                   focusSearchInput();
                              }
                         });
                    }
                    
                    // Enter en input de margen
                    if (marginInput) {
                         marginInput.addEventListener('keypress', function(e) {
                              if (e.key === 'Enter') {
                                   marginSaveBtn.click();
                              }
                         });
                    }
               }

               

               function setInitialToggleState() {
               const toggle = document.getElementById('priceToggle');
               const marginContainer = document.querySelector('.margin-input-container');
               const marginInput = document.getElementById('marginInput');
               
               if (!toggle) return;
               
               const modoActual = localStorage.getItem('precioModo') || 'lista';
               const margenActual = localStorage.getItem('margenCliente') || '0';
               
               // Establecer toggle
               toggle.checked = (modoActual === 'venta');
               
               // Mostrar/ocultar input de margen
               if (modoActual === 'venta') {
                    marginContainer.style.display = 'flex';
                    marginInput.value = margenActual;
               } else {
                    marginContainer.style.display = 'none';
               }
               
               console.log(`ðŸŽ¯ Estado inicial: ${modoActual}, margen: ${margenActual}%`);
               }

               // ================================================
               // CÃLCULO DE PRECIOS
               // ================================================

               function calculateDisplayPrice(precioOriginal, margen, modo) {
               if (modo === 'lista') {
                    return precioOriginal;
               } else if (modo === 'venta') {
                    return Math.round(precioOriginal * (1 + margen / 100));
               }
               return precioOriginal;
               }

               function recalculateAllVisiblePrices() {
                    const modoActual = localStorage.getItem('precioModo') || 'lista';
                    const margenActual = parseFloat(localStorage.getItem('margenCliente') || '0');
                    
                    // Obtener datos de productos desde cache_products_data
                    const productosRaw = JSON.parse(localStorage.getItem('cache_products_data') || '{}')?.value?.products || {};
                    
                    console.log(`ðŸ”„ Recalculando con cache_products_data - Modo: ${modoActual}, Margen: ${margenActual}%`);
                    
                    document.querySelectorAll('.price-tag').forEach(el => {
                         try {
                              const bottomRow = el.closest('.bottom-row');
                              let codigo = bottomRow?.querySelector('a')?.textContent || '';
                              codigo = codigo.trim();
                              
                              const producto = productosRaw[codigo];
                              if (producto && !isNaN(producto.precio)) {
                                   const precioOriginal = producto.precio;
                                   const precioFinal = modoActual === 'venta'
                                        ? Math.round(precioOriginal * (1 + margenActual / 100))
                                        : precioOriginal;
                                   
                                   el.textContent = `$${precioFinal.toLocaleString('es-AR')}`;
                                   el.className = `price-tag ${modoActual}`;
                                   el.dataset.originalPrice = precioOriginal;
                                   el.dataset.processed = 'true';
                                   
                                   console.log(`âœ… ${codigo}: ${precioOriginal} â†’ ${precioFinal}`);
                              }  else{
                                        // FALLBACK para elementos de bÃºsqueda: usar data-original-price
                                        const precioOriginal = parseFloat(el.dataset.originalPrice);
                                        if (precioOriginal && !isNaN(precioOriginal)) {
                                             const precioFinal = modoActual === 'venta'
                                                  ? Math.round(precioOriginal * (1 + margenActual / 100))
                                                  : precioOriginal;
                                             
                                             el.textContent = `$${precioFinal.toLocaleString('es-AR')}`;
                                             el.className = `price-tag ${modoActual}`;
                                             el.dataset.processed = 'true';
                                             
                                             console.log(`ðŸ”„ Fallback: ${precioOriginal} â†’ ${precioFinal} (${modoActual})`);
                                        } else {
                                                  console.log(`âŒ No se encontrÃ³ precio para ${codigo}`);
                                               }
                              }
                         } catch (error) {
                              console.log('âš ï¸ Error procesando elemento:', error);
                         }
                    });
                    
                    console.log('âœ… Recalculado usando cache_products_data');
               }

               // INMEDIATAMENTE DESPUÃ‰S DE DEFINIR LA FUNCIÃ“N:
               window.recalculateAllVisiblePrices = recalculateAllVisiblePrices;

               // ================================================
               // INTERCEPTORES DE CARGA DE PRECIOS
               // ================================================

               function setupPriceInterceptors() {
               console.log('ðŸ•µï¸ Configurando interceptores de precios...');
               
               // Interceptor para carga inicial
               interceptInitialPriceLoad();

               // NUEVO: Interceptor especÃ­fico para precarga inicial
               interceptInitialPreload();
               
               // Interceptor para bÃºsquedas
               interceptSearchPriceLoad();
               
               // NUEVO: Interceptor para botones de limpieza
               interceptCleanupActions();

               // AGREGAR al final de setupPriceInterceptors(), despuÃ©s de todos los otros interceptores:

               // Interceptor continuo para elementos que aparecen dinÃ¡micamente
               const continuousObserver = new MutationObserver(function(mutations) {
               let newPriceElements = [];
               
               mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                         if (node.nodeType === 1) {
                              // Buscar price-tags en el nuevo nodo
                              const priceElements = node.querySelectorAll ? 
                                   node.querySelectorAll('.price-tag:not([data-processed])') : [];
                              
                              newPriceElements.push(...priceElements);
                              
                              // Si el nodo mismo es un price-tag no procesado
                              if (node.classList && node.classList.contains('price-tag') && !node.dataset.processed) {
                                   newPriceElements.push(node);
                              }
                         }
                    });
               });
               
               if (newPriceElements.length > 0) {
                    console.log(`ðŸ”„ Interceptor continuo: ${newPriceElements.length} elementos nuevos detectados`);
                    setTimeout(() => {
                         processNewPriceElements(newPriceElements);
                    }, 100);
               }
               });

               // Observar todo el documento para capturar elementos dinÃ¡micos
               continuousObserver.observe(document.body, {
               childList: true,
               subtree: true
               });

               console.log('ðŸ‘ï¸ Interceptor continuo configurado para elementos dinÃ¡micos');
               
               console.log('âœ… Interceptores configurados');
               }

               function interceptCleanupActions() {
               console.log('ðŸ§¹ Configurando interceptores de limpieza...');
               
               // 1. Interceptar evento resetCatalogo
               window.addEventListener('resetCatalogo', function(event) {
                    console.log('ðŸ”„ Interceptado evento resetCatalogo');
                    
                    // Esperar a que se carguen los productos iniciales
                    setTimeout(() => {
                         console.log('ðŸŽ¯ Aplicando configuraciÃ³n de mÃ¡rgenes despuÃ©s de resetCatalogo');
                         recalculateAllVisiblePrices();
                    }, 1000); // Dar tiempo a que se carguen los productos
               });
               
               // 2. Interceptar botÃ³n X de bÃºsqueda (cuando se cree dinÃ¡micamente)
               const searchContainer = document.querySelector('.input-container');
               if (searchContainer) {
                    // Usar MutationObserver para detectar cuando se crea el botÃ³n X
                    const observer = new MutationObserver(function(mutations) {
                         mutations.forEach(function(mutation) {
                              mutation.addedNodes.forEach(function(node) {
                                   if (node.classList && node.classList.contains('search-clear-btn')) {
                                   console.log('ðŸ§¹ Interceptando botÃ³n X de bÃºsqueda');
                                   
                                   // Guardar el evento original
                                   const originalClick = node.onclick;
                                   
                                   // Reemplazar con nuestro interceptor
                                   node.addEventListener('click', function(e) {
                                        console.log('ðŸ”„ BotÃ³n X clickeado - aplicando mÃ¡rgenes despuÃ©s');
                                        
                                        // Esperar a que se complete la limpieza
                                        setTimeout(() => {
                                             recalculateAllVisiblePrices();
                                        }, 500);
                                   });
                                   }
                              });
                         });
                    });
                    
                    observer.observe(searchContainer, { childList: true, subtree: true });
               }
               
               // 3. Interceptar tecla ESC
               document.addEventListener('keydown', function(e) {
                    if (e.keyCode === 27 || e.key === 'Escape') {
                         const searchInput = document.querySelector('input[type="text"]');
                         if (searchInput && searchInput === document.activeElement) {
                              console.log('ðŸ”„ Tecla ESC presionada en bÃºsqueda');
                              
                              // Esperar a que se complete la limpieza
                              setTimeout(() => {
                                   recalculateAllVisiblePrices();
                              }, 500);
                         }
                    }
               });
               
               // 4. Interceptar el botÃ³n "Limpiar" del search-engine.js
               // Como se crea dinÃ¡micamente, usar MutationObserver
               const bodyObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                         mutation.addedNodes.forEach(function(node) {
                              if (node.nodeType === 1) { // Element node
                                   // Buscar el botÃ³n limpiar
                                   const limpiarBtn = node.id === 'boton-limpiar-busqueda' ? 
                                   node : node.querySelector ? node.querySelector('#boton-limpiar-busqueda') : null;
                                   
                                   if (limpiarBtn) {
                                   console.log('ðŸ§¹ Interceptando botÃ³n "Limpiar" de search-engine');
                                   
                                   // Agregar nuestro interceptor al evento click
                                   limpiarBtn.addEventListener('click', function(e) {
                                        console.log('ðŸ”„ BotÃ³n "Limpiar" clickeado - esperando recarga...');
                                        
                                        // Este botÃ³n hace window.location.reload(), asÃ­ que no podemos interceptar despuÃ©s
                                        // En su lugar, guardar el estado en localStorage antes de la recarga
                                        const modoActual = localStorage.getItem('precioModo') || 'lista';
                                        const margenActual = localStorage.getItem('margenCliente') || '0';
                                        
                                        localStorage.setItem('restoreMarginAfterReload', JSON.stringify({
                                             modo: modoActual,
                                             margen: margenActual,
                                             timestamp: Date.now()
                                        }));
                                        
                                        console.log('ðŸ’¾ Estado de mÃ¡rgenes guardado para restaurar despuÃ©s de recarga');
                                   });
                                   }
                              }
                         });
                    });
               });
               
               // Observar cambios en todo el documento
               bodyObserver.observe(document.body, { childList: true, subtree: true });
               
               console.log('ðŸ§¹ Interceptores de limpieza configurados');
               }

               // NUEVA FUNCIÃ“N: Restaurar estado despuÃ©s de recarga de pÃ¡gina
               function restoreMarginStateAfterReload() {
               try {
                    const savedState = localStorage.getItem('restoreMarginAfterReload');
                    
                    if (savedState) {
                         const state = JSON.parse(savedState);
                         const now = Date.now();
                         
                         // Solo restaurar si el guardado fue reciente (menos de 10 segundos)
                         if (now - state.timestamp < 10000) {
                              console.log('ðŸ”„ Restaurando estado de mÃ¡rgenes despuÃ©s de recarga');
                              
                              // Restaurar configuraciÃ³n
                              localStorage.setItem('precioModo', state.modo);
                              localStorage.setItem('margenCliente', state.margen);
                              
                              // Actualizar toggle UI cuando estÃ© disponible
                              setTimeout(() => {
                                   setInitialToggleState();
                              }, 500);
                              
                              console.log(`âœ… Estado restaurado: modo=${state.modo}, margen=${state.margen}%`);
                         }
                         
                         // Limpiar el estado guardado
                         localStorage.removeItem('restoreMarginAfterReload');
                    }
               } catch (error) {
                    console.log('âš ï¸ Error restaurando estado despuÃ©s de recarga:', error);
                    localStorage.removeItem('restoreMarginAfterReload');
               }
               }

               function interceptInitialPriceLoad() {
               // Observar cuando se agregan nuevos elementos price-tag
               const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                         mutation.addedNodes.forEach(function(node) {
                              if (node.nodeType === 1) { // Element node
                                   // Buscar price-tags en el nodo agregado
                                   const priceElements = node.querySelectorAll ? 
                                   node.querySelectorAll('.price-tag') : [];
                                   
                                   if (priceElements.length > 0) {
                                   console.log(`ðŸŽ¯ Detectados ${priceElements.length} nuevos precios en carga inicial`);
                                   setTimeout(() => {
                                        processNewPriceElements(priceElements);
                                   }, 100);
                                   }
                                   
                                   // Si el nodo mismo es un price-tag
                                   if (node.classList && node.classList.contains('price-tag')) {
                                   console.log('ðŸŽ¯ Detectado nuevo price-tag individual');
                                   setTimeout(() => {
                                        processNewPriceElements([node]);
                                   }, 100);
                                   }
                              }
                         });
                    });
               });
               
               // Observar el contenedor de la galerÃ­a
               const galleryContainer = document.querySelector('.gallery-container');
               if (galleryContainer) {
                    observer.observe(galleryContainer, {
                         childList: true,
                         subtree: true
                    });
               }
               }

               // NUEVA FUNCIÃ“N: Interceptar precarga inicial de 25 elementos
               function interceptInitialPreload() {
               console.log('ðŸŽ¯ Configurando interceptor para precarga inicial...');
               
               // FunciÃ³n para procesar elementos ya existentes
               function processExistingElements() {
                    const existingPriceElements = document.querySelectorAll('.price-tag:not([data-processed])');
                    
                    if (existingPriceElements.length > 0) {
                         console.log(`ðŸ”„ Procesando ${existingPriceElements.length} elementos de precarga inicial`);
                         processNewPriceElements(existingPriceElements);
                    }
               }
               
               // Ejecutar inmediatamente para elementos ya presentes
               setTimeout(processExistingElements, 100);
               
               // TambiÃ©n ejecutar despuÃ©s de un delay mayor para capturar elementos que se cargan ligeramente despuÃ©s
               setTimeout(processExistingElements, 1000);
               setTimeout(processExistingElements, 2000);
               
               // Observador especÃ­fico para la funciÃ³n cargarGaleria()
               const galleryContainer = document.querySelector('.gallery-container');
               if (galleryContainer) {
                    
                    // Crear observador que detecte cuando se completa la precarga inicial
                    const preloadObserver = new MutationObserver(function(mutations) {
                         let shouldProcess = false;
                         
                         mutations.forEach(function(mutation) {
                              mutation.addedNodes.forEach(function(node) {
                                   if (node.nodeType === 1) {
                                   // Si se agregÃ³ un elemento con data-product-code, es de la precarga inicial
                                   if (node.getAttribute && node.getAttribute('data-product-code')) {
                                        shouldProcess = true;
                                   }
                                   
                                   // O si se agregÃ³ un elemento que contiene price-tag
                                   if (node.querySelector && node.querySelector('.price-tag')) {
                                        shouldProcess = true;
                                   }
                                   }
                              });
                         });
                         
                         if (shouldProcess) {
                              console.log('ðŸ“¦ Detectada precarga inicial, procesando elementos...');
                              setTimeout(() => {
                                   const newPriceElements = document.querySelectorAll('.price-tag:not([data-processed])');
                                   if (newPriceElements.length > 0) {
                                   processNewPriceElements(newPriceElements);
                                   }
                              }, 200);
                         }
                    });
                    
                    preloadObserver.observe(galleryContainer, {
                         childList: true,
                         subtree: true,
                         attributes: true,
                         attributeFilter: ['data-product-code']
                    });
               }
               
               console.log('âœ… Interceptor de precarga inicial configurado');
               }

               // FunciÃ³n para enfocar el campo de bÃºsqueda
               function focusSearchInput() {
               const searchInput = document.querySelector('input[type="text"]');
               if (searchInput) {
                    searchInput.focus();
                    console.log('ðŸŽ¯ Foco movido al campo de bÃºsqueda');
               }
               }


               function interceptSearchPriceLoad() {
               // Interceptar eventos de bÃºsqueda
               const searchInput = document.querySelector('input[type="text"]');
               
               if (searchInput) {
                    // Override del evento input existente
                    const originalInputHandler = searchInput.oninput;
                    
                    searchInput.addEventListener('input', function(e) {
                         // DespuÃ©s de que se procese la bÃºsqueda, interceptar resultados
                         setTimeout(() => {
                              const newPriceElements = document.querySelectorAll('.price-tag:not([data-processed])');
                              if (newPriceElements.length > 0) {
                                   console.log(`ðŸ” Detectados ${newPriceElements.length} precios en resultados de bÃºsqueda`);
                                   processNewPriceElements(newPriceElements);
                              }
                         }, 500);
                    });
               }
               }

               function processNewPriceElements(priceElements) {
               const modoActual = localStorage.getItem('precioModo') || 'lista';
               const margenActual = parseInt(localStorage.getItem('margenCliente') || '0');
               
               priceElements.forEach(priceElement => {
                    if (priceElement.dataset.processed) return;
                    
                    try {
                         // Obtener precio original del texto
                         const textoOriginal = priceElement.textContent.replace(/[^0-9]/g, '');
                         const precioOriginal = parseInt(textoOriginal);
                         
                         if (precioOriginal) {
                              // Guardar precio original
                              priceElement.dataset.originalPrice = precioOriginal;
                              
                              // Calcular precio segÃºn configuraciÃ³n actual
                              const precioFinal = calculateDisplayPrice(precioOriginal, margenActual, modoActual);
                              
                              // Actualizar elemento
                              priceElement.textContent = `$${precioFinal.toLocaleString('es-AR')}`;
                              priceElement.className = `price-tag ${modoActual}`;
                              
                              // Marcar como procesado
                              priceElement.dataset.processed = 'true';
                              
                              console.log(`âœ… Procesado precio: ${precioOriginal} â†’ ${precioFinal} (${modoActual})`);
                         }
                         
                    } catch (error) {
                         console.log('âš ï¸ Error procesando precio:', priceElement, error);
                    }
               });
               }
               window.processNewPriceElements = processNewPriceElements;
               // ================================================
               // ENVÃO A GOOGLE FORM - MÃ‰TODO ALTERNATIVO
               // ================================================

               function sendMarginToGoogleForm(margen) {
               try {
                    const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
                    const clientId = clientData.account || clientData.id || clientData.cuenta;
                    const clientName = clientData.name || clientData.nombre || 'Cliente';
                    const modoActual = localStorage.getItem('precioModo') || 'lista';
                    const fechaActual = new Date().toLocaleString('es-AR');
                    const dispositivo = /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Web';
                    

                    console.log('DEBUG - Datos que se envÃ­an:');
                    console.log('clientId:', clientId);
                    console.log('clientName:', clientName);
                    console.log('margen:', margen);
                    console.log('modoActual:', modoActual);

                    const formData = new FormData();
                    formData.append('entry.438339081', clientId);
                    formData.append('entry.498070512', clientName);
                    formData.append('entry.1412196668', margen);
                    formData.append('entry.1089276059', 'venta');
                    //formData.append('entry.1089276059', modoActual);


                    // MÃ‰TODO 1: Usar URL directa del Google Form con parÃ¡metros
                    const baseURL = 'https://docs.google.com/forms/d/e/1FAIpQLSfAO6Ag-9r6Mi10H-MiVVkCCzbgd0nG4L3cfXVMPIPeZnPUVQ/formResponse';
                    
                    
                    // MÃ‰TODO 2: EnvÃ­o en background sin redirecciÃ³n
                    fetch(`${baseURL}`, {
                         method: 'POST',
                         body: formData,
                         mode: 'no-cors'
                    }).then(() => {
                         console.log(`Datos enviados - Cliente: ${clientId}, Nombre: ${clientName}, Margen: ${margen}%, Modo: ${modoActual}`);
                    }).catch(error => {
                         console.log('Error en envÃ­o automÃ¡tico, usando mÃ©todo de respaldo');
                         
                         // MÃ‰TODO 3: Respaldo usando imagen invisible
                         const img = new Image();
                         img.src = `${baseURL}?entry.438339801=${encodeURIComponent(clientId)}&entry.498070512=${encodeURIComponent(clientName)}&entry.1412196668=${encodeURIComponent(margen)}&entry.1089276059=${encodeURIComponent(modoActual)}`;
                    });
                    
                    // MÃ‰TODO 4: Almacenar para envÃ­o manual posterior
                    const pendingData = {
                         cliente: clientId,
                         nombre: clientName,
                         margen: margen,
                         mostrar: modoActual,
                         fecha: fechaActual,
                         dispositivo: dispositivo,
                         timestamp: Date.now()
                    };
                    
                    // Guardar en localStorage para que puedas procesarlo despuÃ©s
                    let pendingSubmissions = JSON.parse(localStorage.getItem('pendingMarginSubmissions') || '[]');
                    pendingSubmissions.push(pendingData);
                    
                    // Mantener solo los Ãºltimos 50 envÃ­os
                    if (pendingSubmissions.length > 50) {
                         pendingSubmissions = pendingSubmissions.slice(-50);
                    }
                    
                    localStorage.setItem('pendingMarginSubmissions', JSON.stringify(pendingSubmissions));
                    
                    console.log('Cambio de margen guardado localmente para procesamiento posterior');
                    
               } catch (error) {
                    console.error('Error en sendMarginToGoogleForm:', error);
               }
               }

               // FunciÃ³n para obtener envÃ­os pendientes (para debug/verificaciÃ³n)
               function getPendingSubmissions() {
               return JSON.parse(localStorage.getItem('pendingMarginSubmissions') || '[]');
               }

               // FunciÃ³n para limpiar envÃ­os pendientes
               function clearPendingSubmissions() {
               localStorage.removeItem('pendingMarginSubmissions');
               console.log('EnvÃ­os pendientes limpiados');
               }

               // PEGAR AQUÃ LA FUNCIÃ“N
               function debugPrices() {
                    const allPrices = document.querySelectorAll('.price-tag');
                    console.log(`Total elementos: ${allPrices.length}`);
                    
                    let withOriginal = 0;
                    allPrices.forEach((el, i) => {
                         if (el.dataset.originalPrice) withOriginal++;
                         if (i < 3) {
                              console.log(`Elemento ${i}: "${el.textContent}" - Original: ${el.dataset.originalPrice}`);
                         }
                    });
                    
                    console.log(`Con precio original: ${withOriginal}/${allPrices.length}`);
               }


               // ================================================
               // FUNCIONES DE UTILIDAD
               // ================================================

               function getClientCurrentMargin() {
               return parseInt(localStorage.getItem('margenCliente') || '0');
               }

               function getClientCurrentMode() {
               return localStorage.getItem('precioModo') || 'lista';
               }

               function updateMarginConfig(margen, modo) {
               localStorage.setItem('margenCliente', margen.toString());
               localStorage.setItem('precioModo', modo);
               
               // Actualizar UI
               const toggle = document.getElementById('priceToggle');
               if (toggle) {
                    toggle.checked = (modo === 'venta');
               }
               
               // Enviar a Google Form
               sendMarginToGoogleForm(margen);

               // Recalcular precios
               recalculateAllVisiblePrices();
               
               
               }

               // ================================================
               // INICIALIZACIÃ“N
               // ================================================

               // Esta funciÃ³n se debe agregar al final del DOMContentLoaded existente
               initializeMarginSystem();




               });

          // Utilidad debounce
               function debounce(func, wait) {
               let timeout;
               return function executedFunction(...args) {
               const later = () => {
                    clearTimeout(timeout);
                    func(...args);
               };
               clearTimeout(timeout);
               timeout = setTimeout(later, wait);
               };
               }

               </script>
     
               <script>

          // FunciÃ³n para aplicar posicionamiento estilo Pinterest con diseÃ±o responsive
          (function() {
          console.log('Aplicando posicionamiento estilo Pinterest responsive a la galerÃ­a existente...');
  
           // FunciÃ³n para crear la utilidad debounce si no existe
           if (typeof window.debounce !== 'function') {
               window.debounce = function(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                    const later = () => {
                         clearTimeout(timeout);
                         func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    };
               };
          }
  
           // 1. Crear estilos necesarios
           function addPinterestStyles() {
               if (document.querySelector('#pinterest-layout-styles')) return;
               
               const styleEl = document.createElement('style');
               styleEl.id = 'pinterest-layout-styles';
               styleEl.textContent = `
               /* Ocultar inicialmente todos los elementos de la galerÃ­a hasta que se posicionen */
               .gallery-container.loading .gallery-item {
                    opacity: 0;
                    visibility: hidden;
               }
               
               /* Indicador de carga mientras se posicionan las imÃ¡genes */
               .gallery-loader {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                    z-index: 100;
               }
               
               .gallery-loader i {
                    font-size: 2rem;
                    color: #666;
               }
               
               /* Estilos base para todos los tamaÃ±os */
               .gallery-container {
                    position: relative;
                    width: 100%;
                    padding: 10px;
                    background: white;
               }
               
               .gallery-item {
                    position: absolute;
                    width: calc(20% - 20px); /* 5 columnas por defecto */
                    box-sizing: border-box;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    overflow: hidden;
                    z-index: 1; /* Base z-index */
                    transition: opacity 0.3s ease;
               }
               
               .gallery-item.active {
                    z-index: 10; /* Mayor z-index para el activo */
               }
               
               .gallery-item .container-img {
                    width: 100%;
                    overflow: hidden;
                    background: white;
               }
               
               /* CorrecciÃ³n del pseudo-elemento ::before */
               .gallery-item .container-img::before,
               .container-img::before,
               div.container-img::before,
               [class*="container-img"]::before {
                    background: white !important;
                    background-color: white !important;
                    content: '' !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    opacity: 0 !important; /* Hacer invisible el elemento */
                    border-radius: 15px !important;
                    transition: all .3s !important;
               }
               
               .gallery-item .container-img img {
                    width: 100%;
                    display: block;
                    background: white;
               }
               
               .gallery-item .top-row {
                    background-color: white;
                    padding: 8px;
                    padding-left: 5px; /* Nuevo padding-left */
                    padding-bottom: 0px; /* Nuevo padding-bottom */
                    margin: 5px 0;
                    position: relative;
               }
               
               .gallery-item .bottom-row {
                    background-color: white;
                    padding: 8px;
                    margin: 5px 0;
                    position: relative;
               }
               
               /* Permitir que el texto ocupe mÃºltiples lÃ­neas */
               .gallery-item .top-row a,
               .gallery-item .bottom-row a {
                    display: block;
                    word-wrap: break-word; /* Permitir romper palabras largas */
                    overflow: visible; /* Mostrar todo el texto */
                    white-space: normal; /* Permitir saltos de lÃ­nea */
                    line-height: 1.4; /* Espaciado adecuado entre lÃ­neas */
                    font-size: 14px;
               }
               
               /* Eliminar fondos grises */
               .gallery-item > div,
               .gallery-item > div > div {
                    background: white !important;
               }
               
               /* Eliminar fondos grises en Ã¡reas especÃ­ficas */
               .info-img {
                    background: white !important;
               }
               
               /* Ajustar posiciÃ³n de bottom-row con margin-left */
               .gallery-item .container-img .bottom-row,
               .gallery-item .bottom-row,
               .container-img .bottom-row {
                    bottom: 80px !important;
                    position: absolute !important;
                    margin-left: 5% !important;
               }
               
               /* Media queries en orden descendente de tamaÃ±o */
               @media screen and (max-width: 1200px) {
                    .gallery-item {
                    width: calc(25% - 20px); /* 4 columnas */
                    }
               }
               
               @media screen and (max-width: 1000px) {
                    .gallery-item {
                    width: calc(25% - 20px); /* 4 columnas */
                    }
               }
               
               @media screen and (max-width: 920px) {
                    .gallery-item {
                    width: calc(33.333% - 20px); /* 3 columnas */
                    }
               }
               
               /* Estilos para dispositivos con 2 columnas */
               @media screen and (max-width: 770px) {
                    .gallery-container {
                    width: 130% !important;
                    margin-left: 2% !important;
                    overflow: visible !important;
                    }
                    .gallery-item {
                    width: calc(33.333% - 20px) !important;
                    }
                    .btn-inferiores {
                    display: none !important;
                    }
               }
               
               /* Estos estilos se aplicarÃ¡n a TODOS los dispositivos de 576px o menos */
               @media screen and (max-width: 576px) {
                    html body .gallery-container {
                    width: 130% !important;
                    margin-left: 2% !important;
                    overflow: visible !important;
                    }
                    html body .gallery-item {
                    width: calc(50% - 10px) !important;
                    }
               }
               
               /* Estos estilos se aplicarÃ¡n a TODOS los dispositivos de 480px o menos */
               @media screen and (max-width: 480px) {
                    html body .gallery-container {
                    width: 130% !important;
                    margin-left: 2% !important;
                    overflow: visible !important;
                    }
                    html body .gallery-item {
                    width: calc(50% - 10px) !important;
                    }
               }
               `;
               
               document.head.appendChild(styleEl);
               console.log('Estilos de Pinterest responsive agregados');
          }

           // 2. FunciÃ³n para posicionar elementos
          function positionPinterestLayout() {
               console.log('Aplicando posicionamiento estilo Pinterest...');
               
               

               // â­ BLOQUEAR si estamos en modo bÃºsqueda de clientes
               const tieneModoClientes = document.body.classList.contains('modo-busqueda-clientes');
               console.log('[Pinterest Layout] Verificando modo clientes:', tieneModoClientes);
               console.log('[Pinterest Layout] Clases del body:', document.body.className);

               if (tieneModoClientes) {
               console.log('[Pinterest Layout] âœ… BLOQUEADO - modo bÃºsqueda de clientes activo');
               return;
               } else {
               console.log('[Pinterest Layout] âš ï¸ NO BLOQUEADO - modo productos activo');
               }

               const container = document.querySelector('.gallery-container');

               if (!container) {
                    console.log('No se encontrÃ³ el contenedor de la galerÃ­a');
                    return;
               }
               
               // ConfiguraciÃ³n de columnas basada en el ancho de la ventana
               let columnCount = 5; // Por defecto 5 columnas
               
               // Ajustar el nÃºmero de columnas segÃºn el ancho de la ventana
               const windowWidth = window.innerWidth;
               
               if (windowWidth <= 480) {
                    columnCount = 2;
               } else if (windowWidth <= 576) {
                    columnCount = 2;
               } else if (windowWidth <= 770) {
                    columnCount = 3;
                    } else if (windowWidth <= 920) {
                    columnCount = 3; // 3 columnas entre 771px y 920px
                    } else if (windowWidth <= 1000) {
                    columnCount = 4; // 4 columnas entre 921px y 1000px
                    } else {
                    columnCount = 5; // 5 columnas a partir de 1000px
                    }
               
               console.log(`Ancho de ventana: ${windowWidth}px, usando ${columnCount} columnas`);
               
               // Usar un gap mÃ¡s pequeÃ±o para dispositivos con 2 columnas
                    const gap = (windowWidth <= 770) ? 10 : 20;
               
               // Obtener todos los elementos visibles
               const items = Array.from(document.querySelectorAll('.gallery-item'))
                    .filter(item => item.style.display !== 'none');
               
               console.log(`Posicionando ${items.length} elementos en layout Pinterest...`);
               
               // Inicializar alturas de columnas
               const columnHeights = Array(columnCount).fill(0);
               
               // Posicionar cada elemento
               items.forEach((item, index) => {
                    // Encontrar la columna mÃ¡s corta
                    const shortestColumnIndex = columnHeights.indexOf(Math.min(...columnHeights));
                    
                    // Calcular posiciÃ³n
                    const leftPos = `calc(${shortestColumnIndex * (100 / columnCount)}% + ${gap/2}px)`;
                    const topPos = `${columnHeights[shortestColumnIndex]}px`;
                    
                    // Aplicar posiciÃ³n
                    item.style.position = 'absolute';
                    item.style.left = leftPos;
                    item.style.top = topPos;
                    
                    // Ajustar el ancho segÃºn el nÃºmero de columnas actual (responsive)
                    item.style.width = `calc(${100 / columnCount}% - ${gap}px)`;
                    
                    // Hacer visible
                    item.style.opacity = '1';
                    
                    // Asegurarse de que los textos se muestren correctamente
                    const textElements = item.querySelectorAll('a');
                    textElements.forEach(el => {
                    el.style.whiteSpace = 'normal';
                    el.style.overflow = 'visible';
                    el.style.textOverflow = 'clip';
                    });
                    
                    // Obtener altura real o estimada
                    let itemHeight = item.offsetHeight;
                    if (!itemHeight || itemHeight < 100) {
                    const img = item.querySelector('img');
                    itemHeight = img && img.complete ? img.offsetHeight + 180 : 380; // Altura extra para textos
                    }
      
                    // Actualizar altura de columna
                    columnHeights[shortestColumnIndex] += itemHeight + gap;
                    
                    // Guardar posiciÃ³n para referencia
                    item.dataset.column = shortestColumnIndex.toString();
                    item.dataset.topPosition = columnHeights[shortestColumnIndex].toString();
               });
               
               // Actualizar altura del contenedor
               const maxHeight = Math.max(...columnHeights);
               container.style.height = `${maxHeight + 50}px`;
               
               console.log('Posicionamiento estilo Pinterest completado');
          }
  
          // El resto del cÃ³digo continÃºa igual...
          




          // 3. FunciÃ³n para observar cambios en el DOM
          function setupMutationObserver() {
               console.log('Configurando observador de mutaciones...');
               
               const targetNode = document.querySelector('.gallery-container');
               if (!targetNode) {
                    console.log('No se encontrÃ³ el contenedor para observar');
                    return;
               }
               
               // Opciones para el observador
               const config = { childList: true, subtree: true };
               
               // Callback para cuando ocurren cambios
               const callback = function(mutationsList, observer) {
                    let needsRepositioning = false;
                    
                    for (let mutation of mutationsList) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                         needsRepositioning = true;
                         break;
                    }
                    }
                    
                    if (needsRepositioning) {
                    console.log('Detectados nuevos elementos, reposicionando...');
                    
                    // â­ NO reposicionar si estamos en modo bÃºsqueda de clientes
                    if (document.body.classList.contains('modo-busqueda-clientes')) {
                         console.log('[MutationObserver] Bloqueado - modo bÃºsqueda de clientes activo');
                         return;
                    }
                    
                    // PequeÃ±o retraso para asegurar que los elementos estÃ©n completamente cargados
                    setTimeout(positionPinterestLayout, 200);
                    }
               };
               
               // Crear y iniciar el observador
               const observer = new MutationObserver(callback);
               observer.observe(targetNode, config);
               
               console.log('Observador de mutaciones configurado');
          }
          
          // 4. FunciÃ³n para interceptar la carga en scroll
          function setupScrollInterception() {
               console.log('Configurando intercepciÃ³n de scroll...');
               
               if (typeof window.precargarSiguientesPaginas === 'function') {
                    const originalFn = window.precargarSiguientesPaginas;
                    
                    window.precargarSiguientesPaginas = async function() {
                         console.log('Interceptando carga por scroll...');
                         
                         // Ejecutar funciÃ³n original
                         await originalFn.apply(this, arguments);
                         
                         // â­ NO reposicionar si estamos en modo bÃºsqueda de clientes
                         if (document.body.classList.contains('modo-busqueda-clientes')) {
                              console.log('[ScrollInterception] Bloqueado - modo bÃºsqueda de clientes activo');
                              return;
                         }
                         
                         // Reposicionar despuÃ©s de un retraso
                         setTimeout(positionPinterestLayout, 500);
                    };
                    
                    console.log('IntercepciÃ³n de scroll configurada');
               } else {
                    console.log('FunciÃ³n precargarSiguientesPaginas no encontrada');
               }
          }
          
          // 5. Inicializar cuando el DOM estÃ© listo
          function init() {
               // Evitar mÃºltiples inicializaciones
               if (window.pinterestLayoutInitialized) {
                    console.log('Layout Pinterest ya inicializado, omitiendo');
                    return;
               }
               
               window.pinterestLayoutInitialized = true;
               console.log('Inicializando layout Pinterest...');
               
               // Agregar estilos
               addPinterestStyles();
          
               // Marcar el contenedor como "cargando"
               const container = document.querySelector('.gallery-container');
               if (container) {
                    container.classList.add('loading');
                    
                    // AÃ±adir loader mientras se posicionan las imÃ¡genes
                    const loader = document.createElement('div');
                    loader.className = 'gallery-loader';
                    loader.innerHTML = `<i class="fas fa-spinner fa-spin"></i><p>Organizando productos...</p>`;
                    container.appendChild(loader);
               }
          
               // Ejecutar posicionamiento lo antes posible, sin esperar a que todas las imÃ¡genes carguen
               const galleryItems = document.querySelectorAll('.gallery-item');
               if (galleryItems.length > 0) {
                    console.log(`GalerÃ­a encontrada con ${galleryItems.length} elementos, posicionando inmediatamente...`);
                    
                    // Breve retraso para permitir que los estilos se apliquen
                    setTimeout(() => {
                    // Posicionar elementos
                    positionPinterestLayout();
                    
                    // Configurar observador
                    setupMutationObserver();
                    
                    // Interceptar scroll
                    setupScrollInterception();
                    
                    // Ejecutar periÃ³dicamente para asegurar el layout (solo si no estamos en modo clientes)
                    window.pinterestLayoutInterval = setInterval(() => {
                    if (!document.body.classList.contains('modo-busqueda-clientes')) {
                         positionPinterestLayout();
                    }
                    }, 5000);
                    
                    // Eliminar clase de carga y mostrar los elementos
                    if (container) {
                         container.classList.remove('loading');
                         const loader = container.querySelector('.gallery-loader');
                         if (loader) loader.remove();
                    }
                    }, 50);
               } else {
                    // Si aÃºn no hay elementos, esperar a que se carguen
                    const waitForGallery = setInterval(() => {
                    const items = document.querySelectorAll('.gallery-item');
                    
                    if (items.length > 0) {
                         clearInterval(waitForGallery);
                         console.log(`GalerÃ­a encontrada con ${items.length} elementos`);
                         
                         // Posicionar elementos
                         positionPinterestLayout();
                         
                         // Configurar observador
                         setupMutationObserver();
                         
                         // Interceptar scroll
                         setupScrollInterception();
                         
                         // Ejecutar periÃ³dicamente para asegurar el layout (solo si no estamos en modo clientes)
                         window.pinterestLayoutInterval = setInterval(() => {
                         if (!document.body.classList.contains('modo-busqueda-clientes')) {
                              positionPinterestLayout();
                         }
                         }, 5000);
                         
                         // Eliminar clase de carga y mostrar los elementos
                         if (container) {
                         container.classList.remove('loading');
                         const loader = container.querySelector('.gallery-loader');
                         if (loader) loader.remove();
                         }
                    }
                    }, 100);
               }
          }
          
          // AÃ±adir event listener para redimensionamiento de ventana
          window.addEventListener('resize', debounce(function() {
          if (window.pinterestLayoutInitialized) {
               console.log('Ventana redimensionada, reposicionando elementos...');
               positionPinterestLayout();
          }
          }, 200));
          
          // Ejecutar lo mÃ¡s pronto posible
          // Intentar inicializar inmediatamente si el DOM ya estÃ¡ disponible
          if (document.readyState === 'loading') {
          // Si el DOM aÃºn estÃ¡ cargando, configurar event listeners para diferentes estados
          document.addEventListener('readystatechange', function() {
               if (document.readyState === 'interactive' || document.readyState === 'complete') {
               init();
               }
          });
          document.addEventListener('DOMContentLoaded', init);
          } else {
          // Si el DOM ya estÃ¡ disponible, inicializar inmediatamente
          init();
          }
          
          // Backup: inicializar tambiÃ©n cuando la ventana estÃ© completamente cargada
          window.addEventListener('load', function() {
          if (!window.pinterestLayoutInitialized) {
               console.log('Inicializando layout desde evento load');
               init();
          }
          });
          
          // Exponer funciÃ³n para uso manual
          window.applyPinterestLayout = positionPinterestLayout;
          
          // Variable para evitar mÃºltiples inicializaciones
          window.pinterestLayoutInitialized = false;
          
          console.log('MÃ³dulo de layout Pinterest configurado');
          })();

                // Agregar la funcionalidad de limpieza con ESC
               const searchInput = document.querySelector('input[type="text"]');

               if (searchInput) {
               searchInput.addEventListener('keydown', function(e) {
                    // El cÃ³digo de la tecla ESC es 27
                    if (e.keyCode === 27 || e.key === 'Escape') {
                         // Limpiar el campo de bÃºsqueda
                         this.value = '';
                         
                         // Ocultar todos los elementos de la galerÃ­a
                         const galleryItems = document.querySelectorAll('.gallery-item');
                         galleryItems.forEach(item => {
                              item.style.display = 'none';
                         });
                         
                         // Reajustar la altura del contenedor de la galerÃ­a
                         const container = document.querySelector('.gallery-container');
                         if (container) {
                              container.style.height = '100px'; // Altura mÃ­nima para que se vea vacÃ­o
                         }
                         
                         console.log('Campo de bÃºsqueda limpiado y pantalla de imÃ¡genes vaciada');
                    }
               });
              
                    // AÃ±adir el botÃ³n X
                    const searchContainer = document.querySelector('.input-container');
                    
                    if (searchContainer) {
                         // Crear el botÃ³n X
                         const clearButton = document.createElement('span');
                         clearButton.className = 'fas fa-times search-clear-btn';
                         clearButton.style.display = 'none'; // Oculto por defecto
                         clearButton.style.position = 'absolute';
                         clearButton.style.right = '40px'; // Posicionar a la derecha del Ã­cono de bÃºsqueda
                         clearButton.style.top = '50%';
                         clearButton.style.transform = 'translateY(-50%)';
                         clearButton.style.cursor = 'pointer';
                         clearButton.style.color = '#666';
                         
                         // AÃ±adirlo al contenedor
                         searchContainer.appendChild(clearButton);
                         
                         // Mostrar/ocultar el botÃ³n segÃºn haya texto
                         searchInput.addEventListener('input', function() {
                              clearButton.style.display = this.value ? 'block' : 'none';
                         });
                         
                         // Verificar el estado inicial (por si ya hay texto en el campo)
                         if (searchInput.value) {
                              clearButton.style.display = 'block';
                         }
                         
                         // Funcionalidad para limpiar cuando se hace clic en X
                         clearButton.addEventListener('click', function() {
                              searchInput.value = '';
                              this.style.display = 'none';
                              
                              // Ocultar los resultados de bÃºsqueda
                              const galleryItems = document.querySelectorAll('.gallery-item');
                              galleryItems.forEach(item => {
                                   item.style.display = 'none';
                              });
                              
                              // Reajustar la altura del contenedor de la galerÃ­a
                              const container = document.querySelector('.gallery-container');
                              if (container) {
                                   container.style.height = '100px'; // Altura mÃ­nima para que se vea vacÃ­o
                              }
                              
                              // Dar foco de nuevo al campo de bÃºsqueda
                              searchInput.focus();
                              
                              console.log('Campo de bÃºsqueda limpiado y pantalla de imÃ¡genes vaciada (botÃ³n X)');
                         });
                    }
                    }     

                    // Dar foco de nuevo al campo de bÃºsqueda
                    searchInput.focus();
          </script>

     <!-- ImplementaciÃ³n de bÃºsqueda mejorada -->
     <!--<script src="./js/search/busqueda-override.js"></script>-->
     <script type="module" src="./js/search/search-engine.js"></script>

     <!-- AGREGAR AQUÃ - Script para posicionar bottom-row en catÃ¡logo inicial -->
     <script>
     // FunciÃ³n para posicionar bottom-row desde JSON (copiada de search-engine.js)
     async function adjustBottomRowPositions() {
     try {
          console.log('ðŸ”§ EJECUTANDO adjustBottomRowPositions en catalogo...');
          
          // 1. Cargar JSON
          const response = await fetch('./json/catalogo_dimensiones.json');
          const catalogoDimensiones = await response.json();
          
          // 2. Detectar breakpoint
          const screenWidth = window.innerWidth;
          const currentBreakpoint = screenWidth <= 768 ? 'mobile' : 
                                   screenWidth <= 1200 ? 'tablet' : 'desktop';
          
          console.log(`ðŸ“± Breakpoint: ${currentBreakpoint} (${screenWidth}px)`);
          
          // 3. Aplicar a todos los elementos
          const elementosBottomRow = document.querySelectorAll('.container-img .bottom-row');
          console.log(`ðŸ” Encontrados ${elementosBottomRow.length} elementos bottom-row`);
          
          elementosBottomRow.forEach(bottomRow => {
               const galleryItem = bottomRow.closest('.gallery-item');
               if (!galleryItem) return;
               
               const codigo = galleryItem.getAttribute('data-product-code');
               if (!codigo) return;
               
               const dimensiones = catalogoDimensiones.images_dimensions[codigo];
               if (dimensiones && dimensiones.bottomPosition) {
                    const nuevoValor = dimensiones.bottomPosition[currentBreakpoint];
                    bottomRow.style.setProperty('bottom', nuevoValor + 'px', 'important');
                    console.log(`âœ… ${codigo}: ${nuevoValor}px aplicado`);
               }
          });
          
          console.log('ðŸŽ‰ adjustBottomRowPositions COMPLETADO en catÃ¡logo');
          
     } catch (error) {
          console.error('âŒ Error en adjustBottomRowPositions:', error);
     }
     }

     // Ejecutar despuÃ©s de que se cargue todo el contenido
     window.addEventListener('load', () => {
     setTimeout(() => {
          adjustBottomRowPositions();
     }, 3000); // Esperar 3 segundos para que se carguen todos los productos
     });
     </script>

     

     <!-- Salud Financiera (barra) -->
     <script src="./js/salud-financiera.js"></script>

     <!-- Sistema de Funcionalidades -->
     <script src="./js/funcionalidades-menu.js"></script>

     <!-- BÃºsqueda de Clientes -->
     <script src="./js/busqueda-clientes.js"></script>

     <!--<script type="module" src="./js/search/search-integration-enhanced.js"></script>-->
     <!--<script type="module" src="./js/search/search-diagnostics.js"></script>-->
     <!--<script type="module" src="./js/search/diagnostico-activacion.js"></script>-->
</body>

</html>