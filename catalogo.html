<!DOCTYPE html>
<html lang="en">
     <!-- Versión desarrollo - Última actualización: 21/11/2023 -->
<head>
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Ferremax-Catalogo</title>
     <link rel="stylesheet" href="estilos-copia.css">
     <link rel="stylesheet" href="fontawesome/css/all.min.css">
     <link rel="shortcut icon" href="img/logo.png" type="image/x-icon">
     <!-- Agregamos la librería XLSX -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
     <!-- Menu principal -->
     <nav>
          <div class="img-logo">
               <img class="logo" src="img/logo.png" alt="Logo" class="logo">
          </div>
          <a href="login.html" class="btn">Inicio</a>

          <div class="input-container">
               <input type="text" placeholder="Buscar">
               <i class="fas fa-search"></i>
          </div>

          <div class="iconos">
               <span class=""></span>
               <span class=""></span>
               <div class="perfil-container">
                    <!--<img class="img-perfil" src="img/perfil.jpg" alt="">-->
               </div>
               <span class="fas fa-angle-down"></span>
          </div>
     </nav>



     <!-- Seccion de imagenes -->
     <section class="gallery-container">



          <div class="gallery-item">
               <div class="container-img">
                    <!--<img src="img/image1.jpg" alt="">-->
                    <img alt="">


                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!-- Seccion de imagenes 
                              <a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                             -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!-- <img src="img/logo-f.png" alt="">
                              -->
                         <a href=""></a>
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji-alerta.svg" alt="">
                         <!--<img src="icons/emoji2.svg" alt="">
                              -->
                         <span></span>
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">

                    <!-- lo cambio para cargar desde google driver
                    <img src="img/image2.jpg" alt=""> -->
                    <img alt=""> <!-- Solo quitamos el src, mantenemos la etiqueta img -->

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span>evo115co</a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>720</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                   
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">
                    
                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span>PERFA0261</a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>



          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <img src="icons/emoji4.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>800</span>
                              -->
                    </div>
               </div>
          </div>



          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji4.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>2850</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span> </a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <span>1000</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span> </a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span> </a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <img src="icons/emoji4.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>321</span>
                              -->
                    </div>
               </div>
          </div>



          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""><span class="icon fas fa-arrow-up"></span> </a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>128</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">
                    <!--<img src="img/image17.jpg" alt="">-->

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>367</span>
                              -->
                    </div>
               </div>
          </div>



          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">
                    

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">
                    

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji3.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <span>752</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img  alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji3.svg" alt="">
                              <img src="icons/emoji1.svg" alt="">
                              <span>120</span>
                              -->
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                    </div>

                    <div class="reactions">
                    </div>
               </div>
          </div>

          <div class="gallery-item">
               <div class="container-img">
                    <img alt="">

                    <div class="top-row">
                         <a href=""></a>
                         <!--<span class="fas fa-chevron-down"></span>
                              <a href="" class="btn">Guardar</a>
                              -->
                    </div>

                    <div class="bottom-row">
                         <a href=""></a>
                         <!--<a href=""><span class="fas fa-upload"></span></a>
                              <a href=""><span class="fas fa-ellipsis-h"></span></a>
                              -->
                    </div>
               </div>
               <div class="info-img">
                    <div class="info">
                         <!--<img src="img/perfil.jpg" alt="">
                              <a href="">Jorge Durand</a>
                              -->
                    </div>

                    <div class="reactions">
                         <!--<img src="icons/emoji1.svg" alt="">
                              <img src="icons/emoji2.svg" alt="">
                              <img src="icons/emoji4.svg" alt="">
                              <img src="icons/emoji5.svg" alt="">
                              <span>321</span>
                              -->
                    </div>
               </div>
          </div>



     </section>




     <!-- Botones inferioes -->
     <div class="btn-inferiores">
          <a href=""><span class="fas fa-plus"></span></a>
          <a href=""><span class="fas fa-question"></span></a>
     </div>


     <!--Añade esto al inicio de tu HTML, antes de cualquier otro script-->
          <script>
          window.addEventListener('error', function(event) {
          console.error('Error global capturado:', event.error);
          });
          </script>



     <!-- Agregar el nuevo script al final -->
     <script type="module">

          import MonitoringSystem from './js/MonitoringSystem.js';
          import FallbackManager from './js/FallbackManager.js';
          //import CacheManager from '../js/cacheManager.js';
          import ProductManager from './js/productManager.js';
          import {config} from './js/config.js';
          import ImageLoader from './js/imageLoader.js';

          async function cargarImagenes() {
    try {
        console.log('Iniciando carga de imágenes...');
        let imageMap;

        // 1. Intentar cargar desde localStorage primero
        const cachedData = localStorage.getItem('imageCatalog');
        if (cachedData) {
            try {
                const parsedCache = JSON.parse(cachedData);
                imageMap = parsedCache.images;
                console.log('Imágenes cargadas desde localStorage:', Object.keys(imageMap).length);
            } catch (e) {
                console.warn('Error al parsear datos del localStorage:', e);
            }
        }

        // 2. Si no hay datos en localStorage, cargar desde JSON
        if (!imageMap) {
            console.log('No hay datos en localStorage, cargando desde JSON...');
            const response = await fetch('./json/catalogo_imagenes.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const catalogoImagenes = await response.json();
            imageMap = catalogoImagenes.images;
            
            // Guardar en localStorage para próxima carga
            localStorage.setItem('imageCatalog', JSON.stringify(catalogoImagenes));
            console.log('Datos guardados en localStorage para futuro uso');
        }

        // 3. Actualizar las imágenes en la interfaz
        document.querySelectorAll('.gallery-item').forEach(item => {
            const bottomRow = item.querySelector('.bottom-row a');
            if (bottomRow) {
                const codigo = bottomRow.textContent.trim();
                const codigoLimpio = codigo.replace(/\s+/g, '');

                if (imageMap[codigoLimpio]) {
                    const imgUrl = `https://lh3.googleusercontent.com/d/${imageMap[codigoLimpio]}`;
                    const img = item.querySelector('img');
                    if (img) {
                        img.src = imgUrl;
                        console.log(`Imagen actualizada: ${codigoLimpio}`);
                    }
                } else {
                    console.log(`No se encontró ID para el código: ${codigoLimpio}`);
                }
            }
        });

    } catch (error) {
        console.error('Error cargando imágenes:', error);
        // Si hay error total, podríamos implementar otro fallback aquí
    }
}
          // En catalogo.html

          document.addEventListener('DOMContentLoaded', async function() {

               console.log('Verificando bandera de focus en localStorage:', localStorage.getItem('setFocusOnLoad'));
  
               // Verificar si necesitamos establecer el foco en el campo de búsqueda
               if (localStorage.getItem('setFocusOnLoad') === 'true') {
               console.log('Bandera de foco detectada, estableciendo foco...');
               // Limpiar la bandera
               localStorage.removeItem('setFocusOnLoad');
               
               // Establecer el foco inmediatamente Y también con un retraso para mayor seguridad
               const searchInput = document.querySelector('input[type="text"]');
               if (searchInput) {
                    searchInput.focus();
                    console.log('Primer intento de foco establecido');
                    
                    // También intentarlo después de un retraso (mayor probabilidad de éxito)
                    setTimeout(() => {
                    searchInput.focus();
                    console.log('Segundo intento de foco establecido después de 500ms');
                    }, 500);
               } else {
                    console.log('No se encontró el campo de búsqueda');
               }
               } else {
               console.log('No se encontró la bandera de foco');
               }


               // 1. AGREGAR al inicio la creación del MonitoringSystem
               const monitoringSystem = new MonitoringSystem();
               const fallbackManager = new FallbackManager();
               const startTime = performance.now();

               // 2. LUEGO verificar y obtener clientData
               const clientData = localStorage.getItem('clientData');
               if (!clientData) {
               console.log('No hay datos de cliente, usando modo básico');
               window.location.href = 'login.html';
               return;
               }


               //-- agregue 19-3-25

               // Verificar coherencia entre usuario y caché de productos
               //const clientData = localStorage.getItem('clientData');
               const cacheProductsData = localStorage.getItem('cache_products_data');
               
               if (clientData && cacheProductsData) {
                    const clientInfo = JSON.parse(clientData);
                    const cacheInfo = JSON.parse(cacheProductsData);
                    
                    // Verificar si la caché corresponde al usuario actual (por ejemplo, usando ID de cliente)
                    if (clientInfo.id !== cacheInfo.clientId) {
                         console.log('Se detectó caché de productos de otro usuario, limpiando...');
                         localStorage.removeItem('cache_products_data');
                         sessionStorage.removeItem('managersInitialized');
                    }
               }
               //--fin agregue 19-3-25





               // 3. DESPUÉS parsear clientConfig
               const clientConfig = JSON.parse(clientData);


               // 1. AGREGAR primero la obtención de instancias
               window.productManager = ProductManager.getInstance({ 
               monitoringSystem,
               clientData: clientConfig 
               });

               // AÑADIR ESTA LÍNEA para exponer la instancia globalmente
               window.productManagerInstance = productManager;

               window.imageLoader = ImageLoader.getInstance({ 
               monitoringSystem,
               sheetId: config.sheetId
               });
               
               // Agregar al inicio del DOMContentLoaded

               

               //--agregue 19-3-25

               const managersInitialized = sessionStorage.getItem('managersInitialized') === 'true';
               

               // Agregar el control de inicialización - CAMBIAR ESTA LÓGICA
                    if (!managersInitialized || sessionStorage.getItem('needsReinitialization') === 'true') {
                    console.log('Necesaria inicialización de managers (primera vez o cambio de usuario)');
                    
                    // Limpiar la bandera de reinicialización si existe
                    sessionStorage.removeItem('needsReinitialization');
                    
                    try {
                         await Promise.all([
                              window.productManager.initialize(clientConfig),
                              window.imageLoader.initialize()
                         ]);
                         sessionStorage.setItem('managersInitialized', 'true');
                         console.log('Managers inicializados correctamente');
                    } catch (error) {
                         console.error('Error en inicialización de managers:', error);
                         throw error;
                    }
                    } else {
                    console.log('Managers ya inicializados, procediendo con la carga de galería');
                    }

               //--fin agregue 19-3-25

               // Agregar el control de inicialización
               if (!managersInitialized) {
               console.log('Primera inicialización de managers');
               try {
                    await Promise.all([
                         window.productManager.initialize(clientConfig),
                         window.imageLoader.initialize()
                    ]);
                    sessionStorage.setItem('managersInitialized', 'true');
               } catch (error) {
                    console.error('Error en inicialización de managers:', error);
                    throw error;
               }
               } else {
               console.log('Managers ya inicializados, procediendo con la carga de galería');
               }     


               //-----

               // Parte 2.1: Verificar estado y forzar inicialización si es necesario

               console.log('[DEBUG-INIT] Verificando estado de productManager...');
               console.log('[DEBUG-INIT] Tamaño actual del mapa de productos:', window.productManager.products.size);

               // Comprobar si el sessionStorage está marcando una inicialización exitosa
               // pero en realidad no hay productos cargados
               //const managersInitialized = sessionStorage.getItem('managersInitialized') === 'true';
               const needsReinitialization = managersInitialized && window.productManager.products.size === 0;

               if (needsReinitialization) {
               console.log('[DEBUG-INIT] ADVERTENCIA: sessionStorage indica inicialización pero el mapa está vacío');
               console.log('[DEBUG-INIT] Forzando reinicialización...');
               
               // Borrar la marca de inicialización
               sessionStorage.removeItem('managersInitialized');
               
               // Intentar reinicializar manualmente
               try {
                    const clientConfig = JSON.parse(localStorage.getItem('clientData'));
                    console.log('[DEBUG-INIT] Reinicializando con clientConfig:', clientConfig);
                    
                    // Llamar a initialize directamente
                    await window.productManager.initialize(clientConfig);
                    
                    // Verificar nuevamente
                    console.log('[DEBUG-INIT] Después de reinicialización:', {
                         productsSize: window.productManager.products.size,
                         primeros3: Array.from(window.productManager.products.keys()).slice(0, 3)
                    });
                    
                    // Restaurar la marca de inicialización
                    sessionStorage.setItem('managersInitialized', 'true');
               } catch (error) {
                    console.error('[DEBUG-INIT] Error al reinicializar:', error);
               }
               }

              


               //-----




               try {

                    const monitoringSystem = new MonitoringSystem();
                    const fallbackManager = new FallbackManager();
                    const startTime = performance.now();

               // 1. Verificar autenticación
               const clientData = localStorage.getItem('clientData');
               if (!clientData) {
                    console.log('No hay datos de cliente, usando modo básico');
                    window.location.href = 'login.html';
                    return;
               }

               const clientConfig = JSON.parse(clientData);
               

               // 2. Obtener instancias únicas de los managers
               /* window.productManager = ProductManager.getInstance({ 
                    monitoringSystem,
                    clientData: clientConfig 
               });
        
               window.imageLoader = ImageLoader.getInstance({ 
               monitoringSystem,
               sheetId: config.sheetId
               }); */




               // 3. Inicializar en orden correcto

               /* await window.productManager.initialize(clientConfig);
               await window.imageLoader.initialize();
               const productManager = window.productManager;
               const imageLoader = window.imageLoader; */

               // 4. Implementar búsqueda
               const searchInput = document.querySelector('input[type="text"]');

               if (searchInput) {
                    searchInput.addEventListener('input', debounce(async function(e) {
                         const searchTerm = e.target.value.toLowerCase();
                         monitoringSystem.trackUsage('search', { term: searchTerm });
                         const items = document.querySelectorAll('.gallery-item');

                         items.forEach(async item => {
                              const bottomRow = item.querySelector('.bottom-row a');
                              if (!bottomRow) return;

                              const codigo = bottomRow.textContent.trim().replace(/\s+/g, '');

                              const codigoMayus = codigo.toUpperCase();
                              console.log('[catalogo-html DEBUG-Precio 1]', {
                              codigoOriginal: codigo,
                              codigoMayus,
                              precio: await productManager.getPrice(codigoMayus)
                              });
                              

                              if (productManager) {
                              // Si existe ProductManager, usar su búsqueda
                              const producto = productManager.getProduct(codigo);
                              if (producto) {
                                   const matchesBusqueda = 
                                        producto.codigo.toLowerCase().includes(searchTerm) ||
                                        producto.nombre.toLowerCase().includes(searchTerm) ||
                                        producto.categoria.toLowerCase().includes(searchTerm);

                                   item.style.display = matchesBusqueda ? '' : 'none';
                              }
                              } else {
                              // Búsqueda básica por código
                              const matchesBusqueda = codigo.toLowerCase().includes(searchTerm);
                              item.style.display = matchesBusqueda ? '' : 'none';
                              }
                         });
                    }, 300));
               }

               // 5. Función original de carga de imágenes
               async function cargarImagenes() {
                    try {

                         console.log('[catalogo.html- cargargarImagenes Precios 1]...metodo cargarImagenes');

                         const sheetId = '1IKRA31nI8N5dABByDoRWen5NbqiNFl2d';
                         const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

                         const response = await fetch(sheetUrl);
                         const text = await response.text();
                         const json = JSON.parse(text.substr(47).slice(0, -2));

                         const imageMap = {};
                         const priceMap = {};
                         json.table.rows.forEach(row => {
                              if (row.c[0]?.v && row.c[1]?.v) {
                              const nombreArchivo = row.c[0].v;
                              const codigo = nombreArchivo.replace(/\.(jpg|webp|png)$/, '');
                              const id = row.c[1].v;
                              const precio = row.c[5]?.v;
                              imageMap[codigo] = id;
                              if (precio) {
                                   priceMap[codigo] = precio;
                              }
                              }
                         });

                         console.log('Items encontrados:', document.querySelectorAll('.gallery-item').length);

                         document.querySelectorAll('.gallery-item').forEach(item => {
                              const bottomRow = item.querySelector('.bottom-row a');

                              console.log('[catalogo.html- cargargarImagenes Precios 1a] [Debug-bottomRow]', {
                              bottomRow,
                              item,
                              tieneBottomRow: !!bottomRow
                              });



                              if (bottomRow) {
                              const codigo = bottomRow.textContent.trim();

                              

                              const codigoLimpio = codigo.replace(/\s+/g, '');

                              if (imageMap[codigoLimpio]) {
                                   const imgUrl = `https://lh3.googleusercontent.com/d/${imageMap[codigoLimpio]}`;
                                   const img = item.querySelector('img');
                                   if (img) {
                                        img.src = imgUrl;
                                   }
                              }

                              //const precio = priceMap[codigoLimpio]; // VIEJO
                              console.log('[catalogo.html- cargargarImagenes Precios 2] Debug precio:', codigoLimpio, productManager.getPrice(codigoLimpio));
                              
                              if (priceMap[codigoLimpio]) {
                                   const precio = productManager.getPrice(codigoLimpio); // NUEVO
                                   const bottomRowDiv = item.querySelector('.bottom-row');
                                   let precioElement = bottomRowDiv.querySelector('.price-tag');
                                   if (!precioElement) {
                                        precioElement = document.createElement('span');
                                        precioElement.className = 'price-tag';
                                        bottomRowDiv.appendChild(precioElement);
                                   }
                                   precioElement.textContent = `$${precio.toLocaleString('es-AR')}`;

                                   console.log('[catalogo.html- cargargarImagenes Precios 3]', {
                                   precio,
                                   elementoCreado: precioElement.textContent,
                                   padreVisible: bottomRowDiv.offsetParent !== null,
                                   elementoVisible: precioElement.offsetParent !== null
                                   });

                              }
                              }
                         });
                    } catch (error) {
                         console.error('Error en carga básica:', error);
                    }
               }

               // 5. Nueva implementación usando managers

               // Función para cargar la galería
               const galleryItems = document.querySelectorAll('.gallery-item');
                    console.log('[Debug-Gallery]', {
                    itemsEncontrados: galleryItems.length,
                    primerItem: galleryItems[0]
                    });
               



               async function cargarGaleria() {
                    try {
                         console.log('Iniciando cargarGaleria');

                         console.log('URL base para imágenes:', 'https://lh3.googleusercontent.com/d/');
                         console.log('Cache actual:', localStorage.getItem('imageCatalog'));

                         // 1. Obtener los códigos permitidos del clientData
                         const clientData = JSON.parse(localStorage.getItem('clientData'));
                         console.log('=== Datos del Cliente ===', {
                         tieneProductCodes: !!clientData?.productCodes,
                         listaPrecio: clientData?.priceList,
                         cantidadProductos: clientData?.productCodes?.length
                         });
                         

                         // 2. Cargar catálogo de imágenes
                         const response = await fetch('./json/catalogo_imagenes.json');
                         const catalogoImagenes = await response.json();
                         console.log('Catálogo de imágenes cargado:', catalogoImagenes);

                         console.log('ClientData en cargarGaleria:', clientData);
                         console.log('Productos permitidos:', clientData?.productCodes);

                         if (!clientData || !clientData.productCodes) {
                         console.error('No hay datos de productos permitidos para el cliente');
                         return;
                         }



                         //parte 1-producto. Obtener los códigos de productos
                         // Solo continuar con los productos permitidos
                         const productosPermitidos = new Set(clientData?.productCodes || []);
                         console.log('Set de productos permitidos:', Array.from(productosPermitidos));

                         // -producto. Obtener todos los elementos de galería
                         const galleryItems = document.querySelectorAll('.gallery-item');
                         console.log(`[DEBUG-P1] Total de elementos en galería: ${galleryItems.length}`);

                         // Convertir el Set a Array para poder iterar por índice
                         const productosPermitidosArray = Array.from(productosPermitidos);

                         // Iterar sobre los elementos de la galería y asignar códigos
                         for (let i = 0; i < galleryItems.length; i++) {
                         const item = galleryItems[i];
                         
                         // Si ya no quedan productos permitidos, ocultar este elemento
                         if (i >= productosPermitidosArray.length) {
                              item.style.display = 'none';
                              continue;
                         }
                         
                         // Obtener el código del producto permitido correspondiente
                         const codigo = productosPermitidosArray[i];
                         const codigoMayus = codigo.toUpperCase();
                         
                         // Marcar el elemento con el código para futuras referencias
                         item.setAttribute('data-product-code', codigo);
                         item.style.display = ''; // Asegurarse de que sea visible
                         
                         // Actualizar el código en bottom-row
                         const bottomRow = item.querySelector('.bottom-row a');
                         if (bottomRow) {
                              // Establecer el código manteniendo el ícono
                              //bottomRow.innerHTML = `<span class="icon fas fa-arrow-up"></span>${codigoMayus}`;
                              // Establecer el código SIN el ícono
                              bottomRow.innerHTML = `${codigoMayus}`;
                              console.log(`[DEBUG-P1] Asignado código ${codigoMayus} al elemento #${i}`);
                         }
                         }

                         console.log(`[DEBUG-P1] Asignación de códigos completada.`);
                         


                         // Parte producto: Diagnóstico de productManager
                         console.log('[DEBUG-DIAGNÓSTICO] Estado de productManager:', {
                         existe: !!window.productManager,
                         tieneGetProduct: typeof window.productManager.getProduct === 'function',
                         tieneProducts: !!window.productManager.products,
                         productosSize: window.productManager.products instanceof Map ? window.productManager.products.size : 'No es Map'
                         });

                         // Verificar si podemos acceder a los productos directamente
                         if (window.productManager.products instanceof Map) {
                         console.log('[DEBUG-DIAGNÓSTICO] Primeros 3 productos en Map:');
                         let contador = 0;
                         for (const [key, value] of window.productManager.products.entries()) {
                              console.log(`  - ${key}:`, value);
                              contador++;
                              if (contador >= 3) break;
                         }
                         
                         // Verificar específicamente si existe un producto
                         const primerCodigo = Array.from(productosPermitidos)[0].toUpperCase();
                         console.log(`[DEBUG-DIAGNÓSTICO] Verificando si existe ${primerCodigo} en Map:`, window.productManager.products.has(primerCodigo));
                         console.log(`[DEBUG-DIAGNÓSTICO] Producto ${primerCodigo} en Map:`, window.productManager.products.get(primerCodigo));
                         }

                         // Prueba con getProduct para el primer código
                         if (productosPermitidosArray.length > 0) {
                         const primerCodigo = productosPermitidosArray[0].toUpperCase();
                         console.log(`[DEBUG-DIAGNÓSTICO] Intentando getProduct('${primerCodigo}'):`);
                         try {
                              const producto = window.productManager.getProduct(primerCodigo);
                              console.log(`  - Resultado:`, producto);
                         } catch (e) {
                              console.log(`  - Error:`, e);
                         }
                         }

                         console.log('[DEBUG-DIAGNÓSTICO] Diagnóstico completado.');

                         // Parte 1 producto:-fin








                         // Parte 2 producto: Agregar nombres de productos usando getProduct

                         // Iterar sobre los elementos que ya tienen códigos asignados
                         for (let i = 0; i < galleryItems.length; i++) {
                         const item = galleryItems[i];
                         
                         // Si el elemento está oculto, ignorarlo
                         if (item.style.display === 'none') continue;
                         
                         // Obtener el código asignado anteriormente
                         const codigo = item.getAttribute('data-product-code');
                         if (!codigo) continue;
                         
                         const codigoMayus = codigo.toUpperCase();
                         
                         // Intentar obtener el producto usando getProduct
                         const producto = window.productManager.getProduct(codigoMayus);
                         console.log(`[DEBUG-P2] Resultado getProduct(${codigoMayus}):`, producto);
                         
                         // Actualizar el nombre en top-row
                         const topRowLink = item.querySelector('.top-row a');
                         if (topRowLink) {
                              if (producto && producto.nombre) {
                                   topRowLink.textContent = producto.nombre.toLowerCase();
                                   console.log(`[DEBUG-P2] Actualizado nombre para ${codigoMayus} desde getProduct: ${producto.nombre}`);
                              } else {
                                   console.log(`[DEBUG-P2] No se pudo obtener nombre para ${codigoMayus} desde getProduct`);
                              }
                         }
                         }

                         console.log(`[DEBUG-P2] Intento de asignación de nombres completado.`);

                         // Parte 2 producto :-fin

                        




                         // Parte 3: Agregar precios a los productos

                         // Iterar sobre los elementos que ya tienen códigos y nombres asignados
                         for (let i = 0; i < galleryItems.length; i++) {
                         const item = galleryItems[i];
                         
                         // Si el elemento está oculto, ignorarlo
                         if (item.style.display === 'none') continue;
                         
                         // Obtener el código asignado anteriormente
                         const codigo = item.getAttribute('data-product-code');
                         if (!codigo) continue;
                         
                         const codigoMayus = codigo.toUpperCase();
                         
                         // Intentar obtener el precio del producto
                         try {
                              // Intentar primero con getPrice (método oficial)
                              const precio = await window.productManager.getPrice(codigoMayus);
                              console.log(`[DEBUG-PRECIOS] Precio obtenido para ${codigoMayus}:`, precio);
                              
                              if (precio !== null && precio !== undefined) {
                                   // Obtener o crear el elemento para el precio
                                   const bottomRowDiv = item.querySelector('.bottom-row');
                                   if (bottomRowDiv) {
                                        let precioElement = bottomRowDiv.querySelector('.price-tag');
                                        
                                        // Si no existe el elemento para el precio, crearlo
                                        if (!precioElement) {
                                             precioElement = document.createElement('span');
                                             precioElement.className = 'price-tag';
                                             bottomRowDiv.appendChild(precioElement);
                                        }
                                        
                                        // Actualizar el texto del precio
                                        precioElement.textContent = `$${precio.toLocaleString('es-AR')}`;
                                        console.log(`[DEBUG-PRECIOS] Precio mostrado para ${codigoMayus}: $${precio.toLocaleString('es-AR')}`);
                                   }
                              } else {
                                   console.log(`[DEBUG-PRECIOS] No se pudo obtener precio para ${codigoMayus}`);
                                   
                                   // Intentar obtener el precio directamente del producto como alternativa
                                   const producto = window.productManager.products.get(codigoMayus);
                                   if (producto && producto.precio) {
                                        const bottomRowDiv = item.querySelector('.bottom-row');
                                        if (bottomRowDiv) {
                                             let precioElement = bottomRowDiv.querySelector('.price-tag');
                                             if (!precioElement) {
                                             precioElement = document.createElement('span');
                                             precioElement.className = 'price-tag';
                                             bottomRowDiv.appendChild(precioElement);
                                             }
                                             precioElement.textContent = `$${producto.precio.toLocaleString('es-AR')}`;
                                             console.log(`[DEBUG-PRECIOS] Precio (alternativo) mostrado para ${codigoMayus}: $${producto.precio}`);
                                        }
                                   }
                              }
                         } catch (error) {
                              console.log(`[DEBUG-PRECIOS] Error al obtener precio para ${codigoMayus}:`, error);
                         }
                         }

                         console.log(`[DEBUG-PRECIOS] Proceso de asignación de precios completado.`);


                         // Parte 3 producto :-fin




                         // Parte 4: Cargar imágenes de productos

                         async function cargarImagenesProductos() {
                                   console.log('[DEBUG-IMAGENES] Iniciando carga de imágenes...');
                                   
                                   try {
                                        // 1. Intentar cargar el catálogo de imágenes desde JSON
                                        const response = await fetch('./json/catalogo_imagenes.json');
                                        if (!response.ok) {
                                             throw new Error(`Error al cargar catálogo de imágenes: ${response.status}`);
                                        }
                                        
                                        const catalogoImagenes = await response.json();
                                        console.log('[DEBUG-IMAGENES] Catálogo cargado:', {
                                             totalImagenes: Object.keys(catalogoImagenes.images || {}).length,
                                             ejemploImagen: Object.entries(catalogoImagenes.images || {}).slice(0, 1)
                                        });
                                        
                                        // 2. Iterar sobre los elementos de la galería
                                        for (const item of galleryItems) {
                                             // Si el elemento está oculto, saltar
                                             if (item.style.display === 'none') continue;
                                             
                                             // Obtener el código del producto
                                             const codigo = item.getAttribute('data-product-code');
                                             if (!codigo) continue;
                                             
                                             const codigoMayus = codigo.toUpperCase();
                                             const codigoLower = codigo.toLowerCase();
                                             
                                             // Buscar la imagen en el catálogo (probar varias variantes del código)
                                             let imageId = null;
                                             if (catalogoImagenes.images) {
                                                  // Intentar con diferentes formatos de código
                                                  const variantes = [codigo, codigoMayus, codigoLower];
                                                  for (const variante of variantes) {
                                                       if (catalogoImagenes.images[variante]) {
                                                       imageId = catalogoImagenes.images[variante];
                                                       console.log(`[DEBUG-IMAGENES] ID encontrado para ${codigo}:`, imageId);
                                                       break;
                                                       }
                                                  }
                                             }
                                             
                                             // Si encontramos un ID de imagen, actualizar la imagen
                                             if (imageId) {
                                                  const imgElement = item.querySelector('img');
                                                  if (imgElement) {
                                                       // Usar URL directa de Google Drive
                                                       const imgUrl = `https://lh3.googleusercontent.com/d/${imageId}`;
                                                       imgElement.src = imgUrl;
                                                       imgElement.onload = () => console.log(`[DEBUG-IMAGENES] Imagen cargada para ${codigo}`);
                                                       imgElement.onerror = () => console.log(`[DEBUG-IMAGENES] Error al cargar imagen para ${codigo}`);
                                                  }
                                             } else {
                                                  console.log(`[DEBUG-IMAGENES] No se encontró ID para ${codigo}`);
                                             }
                                        }
                                   } catch (error) {
                                        console.error('[DEBUG-IMAGENES] Error al cargar imágenes:', error);
                                        
                                        // Intentar plan B: usar imageLoader si está disponible
                                        if (window.imageLoader) {
                                             console.log('[DEBUG-IMAGENES] Intentando con imageLoader...');
                                             
                                             for (const item of galleryItems) {
                                                  if (item.style.display === 'none') continue;
                                                  
                                                  const codigo = item.getAttribute('data-product-code');
                                                  if (!codigo) continue;
                                                  
                                                  const imgElement = item.querySelector('img');
                                                  if (imgElement) {
                                                       try {
                                                       const url = await window.imageLoader.getImageUrl(codigo, 'desktop');
                                                       if (url) {
                                                            imgElement.src = url;
                                                            console.log(`[DEBUG-IMAGENES] Imagen cargada con imageLoader para ${codigo}`);
                                                       }
                                                       } catch (e) {
                                                       console.log(`[DEBUG-IMAGENES] Error con imageLoader para ${codigo}:`, e);
                                                       }
                                                  }
                                             }
                                        }
                                   }
                                   
                                   console.log('[DEBUG-IMAGENES] Proceso de carga de imágenes completado.');
                         }

                                   // Ejecutar la carga de imágenes
                                   cargarImagenesProductos();     

                         // Parte 4 producto :-fin



                        

                        
                    } catch (error) {
                         console.error('Error general en cargarGaleria:', error);
                    }
               }
               
               
               // 6. Función de precarga de imágenes
               //--- agrego 19-3-25

                    // Modificación de la función precargarSiguientesPaginas para implementar scroll infinito completo
               async function precargarSiguientesPaginas() {
                    if (!imageLoader) return;
                    
                    console.log('Ejecutando precargarSiguientesPaginas para scroll infinito');
                    
                    try {
                         // 1. Obtener lista completa de productos disponibles (si aún no la tenemos)
                         if (!window.allProducts || window.allProducts.length === 0) {
                              console.log('Cargando lista completa de productos...');
                              const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
                              
                              if (clientData?.productCodes && Array.isArray(clientData.productCodes)) {
                                   window.allProducts = clientData.productCodes;
                                   console.log(`Se cargaron ${window.allProducts.length} productos del clientData`);
                              } 
                              // Si tenemos productManager, intentar obtener productos de allí
                              else if (window.productManager && window.productManager.products instanceof Map) {
                                   window.allProducts = Array.from(window.productManager.products.keys());
                                   console.log(`Se cargaron ${window.allProducts.length} productos del productManager`);
                              } else {
                                   console.log('No se pudo obtener lista de productos');
                                   return;
                              }
                         }

                         // 2. Determinar cuántos elementos ya tenemos cargados
                         const container = document.querySelector('.gallery-container');
                         const existingItems = container.querySelectorAll('.gallery-item');
                         const loadedCount = existingItems.length;
                         
                         console.log(`Elementos actuales: ${loadedCount}`);
                         
                         // 3. Determinar cuántos y cuáles cargar ahora
                         const batchSize = 10; // Número de elementos a cargar cada vez
                         const maxItems = 200; // Límite máximo de elementos
                         
                         // Verificar si ya alcanzamos el límite o no hay más productos disponibles
                         if (loadedCount >= maxItems || loadedCount >= window.allProducts.length) {
                              console.log('Se alcanzó el límite de elementos o no hay más productos disponibles');
                              return;
                         }
                         
                         // Calcular cuántos nuevos elementos cargar
                         const startIndex = loadedCount;
                         const endIndex = Math.min(startIndex + batchSize, window.allProducts.length, maxItems);
                         
                         if (startIndex >= endIndex) {
                              console.log('No hay más elementos para cargar');
                              return;
                         }
                         
                         // 4. Obtener los próximos productos a cargar
                         const nextBatch = window.allProducts.slice(startIndex, endIndex);
                         console.log(`Cargando lote de ${nextBatch.length} productos (${startIndex} a ${endIndex-1})`);
                         
                         // 5. Mostrar indicador de carga
                         showLoadingIndicator();
                         
                         // 6. Crear y añadir los nuevos elementos
                         for (const codigo of nextBatch) {
                              if (!codigo) continue;
                              
                              const codigoMayus = codigo.toUpperCase();
                              
                              // Crear nuevo elemento clonando uno existente
                              const template = existingItems[0].cloneNode(true);
                              
                              // Establecer el código del producto como atributo
                              template.setAttribute('data-product-code', codigoMayus);
                              
                              // Actualizar código en bottom-row
                              const bottomRow = template.querySelector('.bottom-row a');
                              if (bottomRow) {
                                   //bottomRow.innerHTML = `<span class="icon fas fa-arrow-up"></span>${codigoMayus}`;
                                   // Establecer el código SIN el ícono
                                   bottomRow.innerHTML = `${codigoMayus}`;
                              }
                              
                              // Actualizar nombre si está disponible
                              if (window.productManager) {
                                   try {
                                        const producto = window.productManager.getProduct(codigoMayus);

                                        // Limpiar el elemento del nombre antes de establecer un nuevo valor
                                        const topRowLink = template.querySelector('.top-row a');
                                        
                                        if (producto && producto.nombre) {
                                        //const topRowLink = template.querySelector('.top-row a');
                                        if (topRowLink) {
                                             topRowLink.textContent = ''; // Limpiar primero

                                             // Convertir a minúsculas aquí, cuando se está cargando inicialmente
                                             topRowLink.textContent = producto.nombre.toLowerCase();
                                             console.log(`[DEBUG] Actualizado nombre para ${codigoMayus}: ${producto.nombre.toLowerCase()}`);
                                        }
                                        }else {
                                             // Si el producto no existe, mostrar "producto fuera de lista"
                                             topRowLink.textContent = "producto fuera de lista";
                                             console.log(`Producto no encontrado: ${codigoMayus}, usando texto genérico`);
                                        }

                                        



                                        
                                        // Agregar precio si está disponible
                                        if (producto && producto.precio) {
                                             const bottomRowDiv = template.querySelector('.bottom-row');
                                        
                                             if (bottomRowDiv) {
                                                  let precioElement = bottomRowDiv.querySelector('.price-tag');

                                                  if (precioElement) {
                                                       precioElement.textContent = ''; // Limpiar primero
                                                  }
                                                  
                                                  if (!precioElement) {
                                                       precioElement = document.createElement('span');
                                                       precioElement.className = 'price-tag';
                                                       bottomRowDiv.appendChild(precioElement);
                                                  }
                                                  
                                                  precioElement.textContent = `$${producto.precio.toLocaleString('es-AR')}`;
                                             }

                                        }else {
                                             // Si el producto no existe, mostrar "$0.00"
                                             const bottomRowDiv = template.querySelector('.bottom-row');
                                             let precioElement = bottomRowDiv.querySelector('.price-tag');
                                             precioElement.textContent = "$0.00";
                                             console.log(`Precio no encontrado para ${codigoMayus}, usando $0.00`);
                                        }




                                   } catch (error) {
                                        
                                        console.log(`Error al obtener datos para ${codigoMayus}:`, error);
                                   }
                              }
                              



                              // Limpiar la imagen para que no herede la del template
                              const imgElement = template.querySelector('img');
                              if (imgElement) {
                                   imgElement.src = '';
                                   imgElement.alt = codigoMayus;
                              }
                              
                              // Añadir el nuevo elemento al contenedor
                              container.appendChild(template);
                              
                              // Cargar la imagen del producto
                              loadProductImage(template, codigoMayus);
                         }
                         
                         // 7. Ocultar indicador de carga después de un breve retraso
                         setTimeout(() => {
                              hideLoadingIndicator();
                         }, 500);
                         
                         console.log(`Se agregaron ${nextBatch.length} nuevos elementos.`);
                         
                         } catch (error) {
                         console.error('Error en precargarSiguientesPaginas:', error);
                         hideLoadingIndicator();
                    }
               }

               // Añadir esto después de la función precargarSiguientesPaginas
               window.addEventListener('resetCatalogo', function(event) {
                    console.log('Evento resetCatalogo recibido, recargando catálogo inicial');
                    
                    try {
                    // Verificar si hay elementos de galería para usar como plantilla
                    const existingItems = document.querySelectorAll('.gallery-item');
                    
                    if (existingItems.length === 0) {
                         console.log("No hay elementos de galería existentes. Recargando la página...");
                         window.location.reload(); // Solución nuclear: recargar la página
                         return;
                    }
                    
                    // Restablecer variables de seguimiento
                    if (window.allProducts) {
                         window.currentProductIndex = 0;
                    }
                    
                    // IMPORTANTE: Resetear la variable isLoading para el scroll
                    window.isLoading = false;
                    
                    // Cargar los productos iniciales con un pequeño retraso
                    setTimeout(() => {
                         try {
                         precargarSiguientesPaginas(0);
                         console.log("Catálogo recargado exitosamente");
                         
                         // IMPORTANTE: Asegurarse de que el scroll infinite esté funcionando
                         // Simular un pequeño scroll para activar el evento
                         setTimeout(() => {
                              window.scrollBy(0, 10);
                              console.log("Scroll infinito reactivado");
                         }, 1000);
                         
                         } catch (error) {
                         console.error("Error al recargar el catálogo:", error);
                         window.location.reload(); // Si hay error, recargar la página
                         }
                    }, 100);
                    
                    } catch (error) {
                    console.error("Error en el manejador de resetCatalogo:", error);
                    window.location.reload(); // Si hay error, recargar la página
                    }
                    });



               // Función auxiliar para cargar la imagen de un producto
               async function loadProductImage(element, codigo) {
               try {
                    const imgElement = element.querySelector('img');
                    if (!imgElement) return;
                    
                    // Intentar cargar desde catalogoImagenes
                    try {
                         const response = await fetch('./json/catalogo_imagenes.json');
                         
                         if (response.ok) {
                              const catalogoImagenes = await response.json();
                              
                              // Intentar con diferentes variantes del código
                              const variantes = [codigo, codigo.toLowerCase(), codigo.toUpperCase()];
                              let imageId = null;
                              
                              for (const variante of variantes) {
                                   if (catalogoImagenes.images && catalogoImagenes.images[variante]) {
                                   imageId = catalogoImagenes.images[variante];
                                   break;
                                   }
                              }
                              
                              if (imageId) {
                                   imgElement.src = `https://lh3.googleusercontent.com/d/${imageId}`;
                                   return;
                              }
                         }
                    } catch (error) {
                         console.log(`Error al cargar imagen de catálogo para ${codigo}:`, error);
                    }
                    
                    // Alternativa: usar imageLoader si está disponible
                    if (window.imageLoader) {
                         try {
                              const url = await window.imageLoader.getImageUrl(codigo, 'desktop');
                              if (url) {
                                   imgElement.src = url;
                              }
                         } catch (error) {
                              console.log(`Error al cargar imagen con imageLoader para ${codigo}:`, error);
                         }
                    }
               } catch (error) {
                    console.error(`Error general al cargar imagen para ${codigo}:`, error);
               }
               }

               // Funciones auxiliares para el indicador de carga
               function showLoadingIndicator() {
               let loadingIndicator = document.querySelector('.infinite-scroll-loading');
               
               if (!loadingIndicator) {
                    loadingIndicator = document.createElement('div');
                    loadingIndicator.className = 'infinite-scroll-loading';
                    loadingIndicator.innerHTML = `
                         <div class="loading-spinner">
                              <i class="fas fa-spinner fa-spin"></i>
                              <span>Cargando más productos...</span>
                         </div>
                    `;
                    loadingIndicator.style.textAlign = 'center';
                    loadingIndicator.style.padding = '20px';
                    loadingIndicator.style.color = '#666';
                    
                    const container = document.querySelector('.gallery-container');
                    container.parentNode.insertBefore(loadingIndicator, container.nextSibling);
               } else {
                    loadingIndicator.style.display = 'block';
               }
               }

               function hideLoadingIndicator() {
               const loadingIndicator = document.querySelector('.infinite-scroll-loading');
               if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
               }
               }

               // Agregar estilos para el indicador de carga y el precio
               function addInfiniteScrollStyles() {
               if (document.querySelector('#infinite-scroll-styles')) return;
               
               const style = document.createElement('style');
               style.id = 'infinite-scroll-styles';
               style.textContent = `
                    .loading-spinner {
                         display: flex;
                         align-items: center;
                         justify-content: center;
                         gap: 10px;
                         padding: 15px;
                    }
                    
                    .price-tag {
                         background-color: rgba(0, 0, 0, 0.7);
                         color: white;
                         padding: 3px 8px;
                         border-radius: 4px;
                         margin-left: 10px;
                         font-weight: bold;
                    }
               `;
               document.head.appendChild(style);
               }

               // Inicializar estilos cuando se carga la página
               document.addEventListener('DOMContentLoaded', function() {
               addInfiniteScrollStyles();
               });

               //--- fin agrego 19-3-25





               
               // 7. Scroll infinito
               let isLoading = false;
               window.addEventListener('scroll', debounce(async function() {
                    if (isLoading) return;

                    const lastItem = document.querySelector('.gallery-item:last-child');
                    if (!lastItem) return;

                    const lastItemRect = lastItem.getBoundingClientRect();

                    // Cambio aquí: de 1.5 a 3 veces la altura de la ventana
                    // Esto inicia la carga cuando el usuario está más lejos del final
                    if (lastItemRect.bottom < window.innerHeight * 3) {
                         isLoading = true;
                         // CAMBIO CLAVE: Verificar si hay una búsqueda activa
                         const searchInput = document.querySelector('input[type="text"]');
                         if (searchInput && searchInput.value.trim() !== '') {
                              console.log("[search-engine] Cargando más resultados de búsqueda por scroll");
                              await cargarMasResultadosBusqueda();
                         } else {
                              console.log("[catalogo] Cargando siguiente página del catálogo por scroll");
                              await precargarSiguientesPaginas();
                         }
                         
                         isLoading = false;
                         }
               }, 200));


               // Añadir esta función después de performSearch
                    async function cargarMasResultadosBusqueda() {
                    const loadMoreButton = document.getElementById('load-more-button');
                    if (loadMoreButton) {
                    loadMoreButton.click(); // Reutiliza la lógica existente del botón
                    }
                    }

              // 6. Sistemas principal y fallback
               const primarySystem = async () => {
                    try {
                         monitoringSystem.trackPerformance('loadTime', performance.now() - startTime);

                    if (!window.productManager || !window.imageLoader) {
                    throw new Error('Componentes no inicializados');
                    }

               await cargarGaleria();
               monitoringSystem.trackUsage('pageView', { page: 'catalogo' });

               } catch (error) {
               monitoringSystem.trackError(error, 'primarySystem');
               throw error;
               }
               };

               const fallbackSystem = async () => {
                    try {
                         await cargarImagenes();
                         monitoringSystem.trackUsage('pageView', { page: 'catalogo-fallback' });
                    } catch (error) {
                         monitoringSystem.trackError(error, 'fallbackSystem');
                         throw error;
                    }
               };

               // 7. Iniciar carga
               await fallbackManager.manageSystems(primarySystem, fallbackSystem);
                              // 8. Limpieza al cerrar
                              window.addEventListener('beforeunload', () => {
                                   if (window.imageLoader) {
                                        window.imageLoader.cleanup();
                                   }
                                   monitoringSystem.trackUsage('pageClose', {
                                        duration: performance.now() - startTime
                              });
                         });
                         


               } catch (error) {
               console.error('Error en inicialización:', error);
               // Si todo falla, intentar carga básica
               await cargarImagenes();
                }


                // ================================================
               // SISTEMA DE MÁRGENES - CÓDIGO COMPLETAMENTE MODULAR
               // ================================================

               // FUNCIÓN PRINCIPAL - Agregar al final del DOMContentLoaded existente
               function initializeMarginSystem() {
               console.log('🎯 Inicializando sistema de márgenes...');
               
               // 0. Restaurar estado después de recarga (si aplica)
               restoreMarginStateAfterReload();
               
               // 1. Cargar configuración del cliente
               loadMarginConfiguration();
               
               // 2. Crear UI del toggle
               createPriceToggleUI();
               
               // 3. Configurar interceptores
               setupPriceInterceptors();

               
               
               console.log('✅ Sistema de márgenes inicializado');
               }

               // ================================================
               // CONFIGURACIÓN DE MÁRGENES
               // ================================================

               function loadMarginConfiguration() {
                    try {
                         console.log('📋 Cargando configuración de márgenes...');
                         
                         // Obtener ID del cliente actual
                         const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
                         const clientId = clientData.account || clientData.id || clientData.cuenta;
                         
                         if (!clientId) {
                              console.log('⚠️ No se encontró ID de cliente');
                              setDefaultMarginConfig();
                              return;
                         }

                         // AGREGAR AQUÍ - Verificación de cambio de cliente
                         const lastClientId = localStorage.getItem('lastLoggedClientId');
                         if (lastClientId && lastClientId !== clientId) {
                         console.log('🔄 Detectado cambio de cliente, limpiando configuración anterior');
                         localStorage.removeItem('margenCliente');
                         localStorage.removeItem('precioModo');
                         localStorage.removeItem('margenTimestamp'); // AGREGAR ESTA LÍNEA
                         }

                         // Guardar el cliente actual para futuras verificaciones
                         localStorage.setItem('lastLoggedClientId', clientId);
                         
                         // Intentar cargar desde JSON de márgenes
                         fetch('./json/margenes_clientes.json')
                              .then(response => response.json())
                              .then(margenes => {
                                   console.log('📋 JSON completo cargado:', margenes);
                                   console.log('🔍 Buscando cliente:', clientId);
                                   console.log('🔍 Datos del cliente:', margenes[clientId]);
                                   if (margenes[clientId]) {
                                        console.log(`✅ Configuración encontrada para cliente ${clientId}`);
                                        console.log('📊 Margen del cliente:', margenes[clientId].margen);
                                        console.log('👁️ Modo del cliente:', margenes[clientId].mostrar);
                                        
                                        // Guardar en localStorage con prioridad sobre JSON
                                        // PRIORIDAD: localStorage primero, JSON como backup
                                        const currentMargen = localStorage.getItem('margenCliente');
                                        const currentModo = localStorage.getItem('precioModo');

                                        if (!currentMargen) {
                                        localStorage.setItem('margenCliente', margenes[clientId].margen || 0);
                                        }

                                        if (!currentModo) {
                                        localStorage.setItem('precioModo', margenes[clientId].mostrar || 'lista');
                                        }

                                        // Actualizar el input visual con el nuevo margen
                                        setTimeout(() => {
                                        const marginInput = document.getElementById('marginInput');
                                        if (marginInput) {
                                             marginInput.value = margenes[clientId].margen || 0;
                                             console.log('📱 Input actualizado con margen:', margenes[clientId].margen);
                                        }
                                        
                                        // También actualizar el toggle
                                        setInitialToggleState();
                                        // AGREGAR ESTA LÍNEA: Recalcular todos los precios
                                        recalculateAllVisiblePrices();

                                        }, 500);
                                   } else {
                                        console.log(`⚠️ No se encontró configuración para cliente ${clientId}`);
                                        setDefaultMarginConfig();
                                   }
                              })
                              .catch(error => {
                                   console.log('⚠️ Error cargando márgenes, usando valores por defecto:', error);
                                   setDefaultMarginConfig();
                              });
                              
                    } catch (error) {
                         console.error('❌ Error en loadMarginConfiguration:', error);
                         setDefaultMarginConfig();
                    }
               }

               function setDefaultMarginConfig() {
               if (!localStorage.getItem('margenCliente')) {
                    localStorage.setItem('margenCliente', '0');
               }
               if (!localStorage.getItem('precioModo')) {
                    localStorage.setItem('precioModo', 'lista');
               }
               }

               // ================================================
               // INTERFAZ DE USUARIO - TOGGLE
               // ================================================

               function createPriceToggleUI() {
               try {
                    console.log('🎨 Creando toggle de precios...');
                    
                    // Buscar el contenedor de la navbar
                    const navbar = document.querySelector('nav');
                    const inputContainer = document.querySelector('.input-container');
                    const iconos = document.querySelector('.iconos');
                    
                    if (!navbar || !inputContainer || !iconos) {
                         console.log('⚠️ No se encontraron elementos de navbar');
                         return;
                    }
                    
                    // Crear toggle container
                    const toggleContainer = document.createElement('div');
                    toggleContainer.className = 'price-toggle-container';
                    toggleContainer.innerHTML = `
                         <div class="price-toggle">
                              <span class="toggle-label">P.L</span>
                              <label class="toggle-switch">
                                   <input type="checkbox" id="priceToggle">
                                   <span class="slider"></span>
                              </label>
                              <span class="toggle-label">P.V</span>
                         </div>
                         <div class="margin-input-container" style="display: none;">
                              <input type="number" id="marginInput" placeholder="%" min="0" max="100" step="1">
                              <button id="marginSaveBtn">OK</button>
                         </div>
                    `;
                    
                    // Insertar entre input y iconos
                    navbar.insertBefore(toggleContainer, iconos);
                    
                    // Aplicar estilos
                    addToggleStyles();
                    
                    // Configurar eventos
                    setupToggleEvents();
                    
                    // Establecer estado inicial
                    setInitialToggleState();
                    
                    console.log('✅ Toggle de precios creado');
                    
               } catch (error) {
                    console.error('❌ Error en createPriceToggleUI:', error);
               }
               }

               function addToggleStyles() {
               if (document.querySelector('#price-toggle-styles')) return;
               
               const style = document.createElement('style');
               style.id = 'price-toggle-styles';
               style.textContent = `
                    .price-toggle-container {
                         display: flex;
                         align-items: center;
                         gap: 10px;
                         margin: 0 20px;
                    }


                    /* Media query específica para dispositivos móviles */
                    @media screen and (max-width: 768px) {
                    .price-toggle-container {
                         display: flex !important;
                         align-items: center !important;
                         gap: 5px !important;
                         margin: 0 10px !important;
                         flex-wrap: nowrap !important;
                         flex-shrink: 0 !important;
                    }
                    
                    .price-toggle {
                         
                         min-height: 35px !important;
                         display: flex !important;
                         align-items: center !important;
                    }
                    
                    .toggle-label {
                         font-size: 15px !important;
                    }
                    
                    .toggle-switch {
                         width: 30px !important;
                         height: 16px !important;
                    }
                    
                    .slider:before {
                         height: 12px !important;
                         width: 12px !important;
                    }
                    
                    input:checked + .slider:before {
                         transform: translateX(14px) !important;
                    }
                    
                    .margin-input-container {
                         padding: 3px 6px !important;
                         min-height: 35px !important;
                         display: flex !important;
                         align-items: center !important;
                    }
                    
                    #marginInput {
                         width: 35px !important;
                         font-size: 15px !important;
                    }
                    
                    #marginSaveBtn {
                         width: 23px !important;
                         height: 23px !important;
                         font-size: 11px !important;
                    }
                    }
                    
                    .price-toggle {
                         display: flex;
                         align-items: center;
                         gap: 8px;
                         background: white;
                         padding: 5px 10px;
                         border-radius: 20px;
                         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    }
                    
                    .toggle-label {
                         font-size: 12px;
                         font-weight: bold;
                         color: #666;
                    }
                    
                    .toggle-switch {
                         position: relative;
                         display: inline-block;
                         width: 40px;
                         height: 20px;
                    }
                    
                    .toggle-switch input {
                         opacity: 0;
                         width: 0;
                         height: 0;
                    }
                    
                    .slider {
                         position: absolute;
                         cursor: pointer;
                         top: 0;
                         left: 0;
                         right: 0;
                         bottom: 0;
                         background-color: #ccc;
                         transition: .4s;
                         border-radius: 20px;
                    }
                    
                    .slider:before {
                         position: absolute;
                         content: "";
                         height: 16px;
                         width: 16px;
                         left: 2px;
                         bottom: 2px;
                         background-color: white;
                         transition: .4s;
                         border-radius: 50%;
                    }
                    
                    input:checked + .slider {
                         background-color: #ff8c00;
                    }
                    
                    input:checked + .slider:before {
                         transform: translateX(20px);
                    }
                    
                    .margin-input-container {
                         display: flex;
                         align-items: center;
                         gap: 5px;
                         background: white;
                         padding: 3px 8px;
                         border-radius: 15px;
                         box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                         overflow: visible;         /* AGREGAR esta línea */
                    }
                    
                    #marginInput {
                         width: 60px;               /* MANTENER en 60px */
                         min-width: 60px;           /* Asegurar ancho mínimo */
                         min-height: 25px;          /* Asegurar altura mínima */
                         border: none;
                         outline: none;
                         text-align: center;
                         font-size: 12px;
                         padding: 0 2px;            /* Padding mínimo */
                         box-sizing: content-box;   /* No incluir padding en el ancho */
                         overflow: visible;         /* Permitir que el contenido sea visible */
                    }
                    
                    #marginSaveBtn {
                         background: #ff8c00;
                         color: white;
                         border: none;
                         border-radius: 50%;
                         width: 20px;
                         height: 20px;
                         cursor: pointer;
                         font-size: 10px;
                    }
                    
                    .price-tag.lista {
                         background-color: rgba(0, 0, 0, 0.7);
                         color: white !important;  /* Agregar !important para forzar el color */
                    }
                    
                    .price-tag.venta {
                         background-color: rgba(255, 140, 0, 0.9);
                         color: white;
                         border-radius: 10px;  /* NUEVA LÍNEA: esquinas redondeadas */
                    }
                    
                    .price-tag {
                         padding: 3px 8px;
                         border-radius: 10px;  /* Aumentar de 4px a 6px para más redondeo */
                         margin-left: 10px;
                         font-weight: bold;
                         transition: all 0.3s ease;
                    }

                    /* Reducir ancho del campo de búsqueda para dar espacio al toggle */
                    .input-container {
                    flex: 0.8 !important; /* Reducir de tamaño completo a 80% */
                    }

                    .input-container input[type="text"] {
                    width: 100% !important; /* Mantener responsive dentro del contenedor reducido */
                    }
               `;
               
               document.head.appendChild(style);
               }

               function setupToggleEvents() {
                    const toggle = document.getElementById('priceToggle');
                    const marginContainer = document.querySelector('.margin-input-container');
                    const marginInput = document.getElementById('marginInput');
                    const marginSaveBtn = document.getElementById('marginSaveBtn');
                    
                    if (!toggle) return;
                    
                    // Toggle entre P.L y P.V
                    toggle.addEventListener('change', function() {
                         const nuevoModo = this.checked ? 'venta' : 'lista';
                         localStorage.setItem('precioModo', nuevoModo);
                         
                         console.log(`🔄 Cambio a modo: ${nuevoModo}`);
                         
                         if (nuevoModo === 'venta') {
                              marginContainer.style.display = 'flex';
                              marginInput.value = localStorage.getItem('margenCliente') || '0';
                         } else {
                              marginContainer.style.display = 'none';
                         }
                         
                         // Recalcular todos los precios
                         recalculateAllVisiblePrices();

                         // Forzar procesamiento de elementos no procesados
                         setTimeout(() => {
                         const unprocessedElements = document.querySelectorAll('.price-tag:not([data-processed])');
                         if (unprocessedElements.length > 0) {
                              console.log(`Procesando ${unprocessedElements.length} elementos no interceptados`);
                              unprocessedElements.forEach(el => {
                                   const precio = parseInt(el.textContent.replace(/[^0-9]/g, ''));
                                   if (precio) {
                                        el.dataset.originalPrice = precio;
                                        el.dataset.processed = 'true';
                                   }
                              });
                              recalculateAllVisiblePrices();
                         }
                         }, 100);

                         

                         // NUEVA LÍNEA: Enfocar campo de búsqueda
                         focusSearchInput();
                    });
                    
                    // Guardar margen
                    if (marginSaveBtn) {
                         marginSaveBtn.addEventListener('click', function() {
                              const nuevoMargen = parseInt(marginInput.value) || 0;
                              
                              if (nuevoMargen >= 0 && nuevoMargen <= 100) {
                                   localStorage.setItem('margenCliente', nuevoMargen.toString());
                                   console.log(`💾 Margen guardado: ${nuevoMargen}%`);


                                   // 1. Cambiar el modo local a venta
                                        localStorage.setItem('precioModo', 'venta');

                                        // 2. Actualizar el toggle visualmente
                                        const toggle = document.getElementById('priceToggle');
                                        if (toggle) {
                                        toggle.checked = true; // Marcar como P.V
                                        }

                                        // 3. Mostrar el contenedor de margen
                                        const marginContainer = document.querySelector('.margin-input-container');
                                        if (marginContainer) {
                                        marginContainer.style.display = 'flex';
                                        }
                                   
                                   // Enviar a Google Form
                                   sendMarginToGoogleForm(nuevoMargen);
                                   
                                   // Recalcular precios
                                   recalculateAllVisiblePrices();
                                   
                                   // Feedback visual
                                   // Cambiar color del botón en lugar de símbolo
                                   marginSaveBtn.textContent = 'OK!';
                                   marginSaveBtn.style.backgroundColor = 'green';
                                   setTimeout(() => {
                                   marginSaveBtn.textContent = 'OK';
                                   marginSaveBtn.style.backgroundColor = '#ff8c00'; // Volver al naranja original
                                   }, 1000);

                                   // NUEVA LÍNEA: Enfocar campo de búsqueda
                                   focusSearchInput();
                              }
                         });
                    }
                    
                    // Enter en input de margen
                    if (marginInput) {
                         marginInput.addEventListener('keypress', function(e) {
                              if (e.key === 'Enter') {
                                   marginSaveBtn.click();
                              }
                         });
                    }
               }

               

               function setInitialToggleState() {
               const toggle = document.getElementById('priceToggle');
               const marginContainer = document.querySelector('.margin-input-container');
               const marginInput = document.getElementById('marginInput');
               
               if (!toggle) return;
               
               const modoActual = localStorage.getItem('precioModo') || 'lista';
               const margenActual = localStorage.getItem('margenCliente') || '0';
               
               // Establecer toggle
               toggle.checked = (modoActual === 'venta');
               
               // Mostrar/ocultar input de margen
               if (modoActual === 'venta') {
                    marginContainer.style.display = 'flex';
                    marginInput.value = margenActual;
               } else {
                    marginContainer.style.display = 'none';
               }
               
               console.log(`🎯 Estado inicial: ${modoActual}, margen: ${margenActual}%`);
               }

               // ================================================
               // CÁLCULO DE PRECIOS
               // ================================================

               function calculateDisplayPrice(precioOriginal, margen, modo) {
               if (modo === 'lista') {
                    return precioOriginal;
               } else if (modo === 'venta') {
                    return Math.round(precioOriginal * (1 + margen / 100));
               }
               return precioOriginal;
               }

               function recalculateAllVisiblePrices() {
                    const modoActual = localStorage.getItem('precioModo') || 'lista';
                    const margenActual = parseFloat(localStorage.getItem('margenCliente') || '0');
                    
                    // Obtener datos de productos desde cache_products_data
                    const productosRaw = JSON.parse(localStorage.getItem('cache_products_data') || '{}')?.value?.products || {};
                    
                    console.log(`🔄 Recalculando con cache_products_data - Modo: ${modoActual}, Margen: ${margenActual}%`);
                    
                    document.querySelectorAll('.price-tag').forEach(el => {
                         try {
                              const bottomRow = el.closest('.bottom-row');
                              let codigo = bottomRow?.querySelector('a')?.textContent || '';
                              codigo = codigo.trim();
                              
                              const producto = productosRaw[codigo];
                              if (producto && !isNaN(producto.precio)) {
                                   const precioOriginal = producto.precio;
                                   const precioFinal = modoActual === 'venta'
                                        ? Math.round(precioOriginal * (1 + margenActual / 100))
                                        : precioOriginal;
                                   
                                   el.textContent = `$${precioFinal.toLocaleString('es-AR')}`;
                                   el.className = `price-tag ${modoActual}`;
                                   el.dataset.originalPrice = precioOriginal;
                                   el.dataset.processed = 'true';
                                   
                                   console.log(`✅ ${codigo}: ${precioOriginal} → ${precioFinal}`);
                              }  else{
                                        // FALLBACK para elementos de búsqueda: usar data-original-price
                                        const precioOriginal = parseFloat(el.dataset.originalPrice);
                                        if (precioOriginal && !isNaN(precioOriginal)) {
                                             const precioFinal = modoActual === 'venta'
                                                  ? Math.round(precioOriginal * (1 + margenActual / 100))
                                                  : precioOriginal;
                                             
                                             el.textContent = `$${precioFinal.toLocaleString('es-AR')}`;
                                             el.className = `price-tag ${modoActual}`;
                                             el.dataset.processed = 'true';
                                             
                                             console.log(`🔄 Fallback: ${precioOriginal} → ${precioFinal} (${modoActual})`);
                                        } else {
                                                  console.log(`❌ No se encontró precio para ${codigo}`);
                                               }
                              }
                         } catch (error) {
                              console.log('⚠️ Error procesando elemento:', error);
                         }
                    });
                    
                    console.log('✅ Recalculado usando cache_products_data');
               }

               // INMEDIATAMENTE DESPUÉS DE DEFINIR LA FUNCIÓN:
               window.recalculateAllVisiblePrices = recalculateAllVisiblePrices;

               // ================================================
               // INTERCEPTORES DE CARGA DE PRECIOS
               // ================================================

               function setupPriceInterceptors() {
               console.log('🕵️ Configurando interceptores de precios...');
               
               // Interceptor para carga inicial
               interceptInitialPriceLoad();

               // NUEVO: Interceptor específico para precarga inicial
               interceptInitialPreload();
               
               // Interceptor para búsquedas
               interceptSearchPriceLoad();
               
               // NUEVO: Interceptor para botones de limpieza
               interceptCleanupActions();

               // AGREGAR al final de setupPriceInterceptors(), después de todos los otros interceptores:

               // Interceptor continuo para elementos que aparecen dinámicamente
               const continuousObserver = new MutationObserver(function(mutations) {
               let newPriceElements = [];
               
               mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                         if (node.nodeType === 1) {
                              // Buscar price-tags en el nuevo nodo
                              const priceElements = node.querySelectorAll ? 
                                   node.querySelectorAll('.price-tag:not([data-processed])') : [];
                              
                              newPriceElements.push(...priceElements);
                              
                              // Si el nodo mismo es un price-tag no procesado
                              if (node.classList && node.classList.contains('price-tag') && !node.dataset.processed) {
                                   newPriceElements.push(node);
                              }
                         }
                    });
               });
               
               if (newPriceElements.length > 0) {
                    console.log(`🔄 Interceptor continuo: ${newPriceElements.length} elementos nuevos detectados`);
                    setTimeout(() => {
                         processNewPriceElements(newPriceElements);
                    }, 100);
               }
               });

               // Observar todo el documento para capturar elementos dinámicos
               continuousObserver.observe(document.body, {
               childList: true,
               subtree: true
               });

               console.log('👁️ Interceptor continuo configurado para elementos dinámicos');
               
               console.log('✅ Interceptores configurados');
               }

               function interceptCleanupActions() {
               console.log('🧹 Configurando interceptores de limpieza...');
               
               // 1. Interceptar evento resetCatalogo
               window.addEventListener('resetCatalogo', function(event) {
                    console.log('🔄 Interceptado evento resetCatalogo');
                    
                    // Esperar a que se carguen los productos iniciales
                    setTimeout(() => {
                         console.log('🎯 Aplicando configuración de márgenes después de resetCatalogo');
                         recalculateAllVisiblePrices();
                    }, 1000); // Dar tiempo a que se carguen los productos
               });
               
               // 2. Interceptar botón X de búsqueda (cuando se cree dinámicamente)
               const searchContainer = document.querySelector('.input-container');
               if (searchContainer) {
                    // Usar MutationObserver para detectar cuando se crea el botón X
                    const observer = new MutationObserver(function(mutations) {
                         mutations.forEach(function(mutation) {
                              mutation.addedNodes.forEach(function(node) {
                                   if (node.classList && node.classList.contains('search-clear-btn')) {
                                   console.log('🧹 Interceptando botón X de búsqueda');
                                   
                                   // Guardar el evento original
                                   const originalClick = node.onclick;
                                   
                                   // Reemplazar con nuestro interceptor
                                   node.addEventListener('click', function(e) {
                                        console.log('🔄 Botón X clickeado - aplicando márgenes después');
                                        
                                        // Esperar a que se complete la limpieza
                                        setTimeout(() => {
                                             recalculateAllVisiblePrices();
                                        }, 500);
                                   });
                                   }
                              });
                         });
                    });
                    
                    observer.observe(searchContainer, { childList: true, subtree: true });
               }
               
               // 3. Interceptar tecla ESC
               document.addEventListener('keydown', function(e) {
                    if (e.keyCode === 27 || e.key === 'Escape') {
                         const searchInput = document.querySelector('input[type="text"]');
                         if (searchInput && searchInput === document.activeElement) {
                              console.log('🔄 Tecla ESC presionada en búsqueda');
                              
                              // Esperar a que se complete la limpieza
                              setTimeout(() => {
                                   recalculateAllVisiblePrices();
                              }, 500);
                         }
                    }
               });
               
               // 4. Interceptar el botón "Limpiar" del search-engine.js
               // Como se crea dinámicamente, usar MutationObserver
               const bodyObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                         mutation.addedNodes.forEach(function(node) {
                              if (node.nodeType === 1) { // Element node
                                   // Buscar el botón limpiar
                                   const limpiarBtn = node.id === 'boton-limpiar-busqueda' ? 
                                   node : node.querySelector ? node.querySelector('#boton-limpiar-busqueda') : null;
                                   
                                   if (limpiarBtn) {
                                   console.log('🧹 Interceptando botón "Limpiar" de search-engine');
                                   
                                   // Agregar nuestro interceptor al evento click
                                   limpiarBtn.addEventListener('click', function(e) {
                                        console.log('🔄 Botón "Limpiar" clickeado - esperando recarga...');
                                        
                                        // Este botón hace window.location.reload(), así que no podemos interceptar después
                                        // En su lugar, guardar el estado en localStorage antes de la recarga
                                        const modoActual = localStorage.getItem('precioModo') || 'lista';
                                        const margenActual = localStorage.getItem('margenCliente') || '0';
                                        
                                        localStorage.setItem('restoreMarginAfterReload', JSON.stringify({
                                             modo: modoActual,
                                             margen: margenActual,
                                             timestamp: Date.now()
                                        }));
                                        
                                        console.log('💾 Estado de márgenes guardado para restaurar después de recarga');
                                   });
                                   }
                              }
                         });
                    });
               });
               
               // Observar cambios en todo el documento
               bodyObserver.observe(document.body, { childList: true, subtree: true });
               
               console.log('🧹 Interceptores de limpieza configurados');
               }

               // NUEVA FUNCIÓN: Restaurar estado después de recarga de página
               function restoreMarginStateAfterReload() {
               try {
                    const savedState = localStorage.getItem('restoreMarginAfterReload');
                    
                    if (savedState) {
                         const state = JSON.parse(savedState);
                         const now = Date.now();
                         
                         // Solo restaurar si el guardado fue reciente (menos de 10 segundos)
                         if (now - state.timestamp < 10000) {
                              console.log('🔄 Restaurando estado de márgenes después de recarga');
                              
                              // Restaurar configuración
                              localStorage.setItem('precioModo', state.modo);
                              localStorage.setItem('margenCliente', state.margen);
                              
                              // Actualizar toggle UI cuando esté disponible
                              setTimeout(() => {
                                   setInitialToggleState();
                              }, 500);
                              
                              console.log(`✅ Estado restaurado: modo=${state.modo}, margen=${state.margen}%`);
                         }
                         
                         // Limpiar el estado guardado
                         localStorage.removeItem('restoreMarginAfterReload');
                    }
               } catch (error) {
                    console.log('⚠️ Error restaurando estado después de recarga:', error);
                    localStorage.removeItem('restoreMarginAfterReload');
               }
               }

               function interceptInitialPriceLoad() {
               // Observar cuando se agregan nuevos elementos price-tag
               const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                         mutation.addedNodes.forEach(function(node) {
                              if (node.nodeType === 1) { // Element node
                                   // Buscar price-tags en el nodo agregado
                                   const priceElements = node.querySelectorAll ? 
                                   node.querySelectorAll('.price-tag') : [];
                                   
                                   if (priceElements.length > 0) {
                                   console.log(`🎯 Detectados ${priceElements.length} nuevos precios en carga inicial`);
                                   setTimeout(() => {
                                        processNewPriceElements(priceElements);
                                   }, 100);
                                   }
                                   
                                   // Si el nodo mismo es un price-tag
                                   if (node.classList && node.classList.contains('price-tag')) {
                                   console.log('🎯 Detectado nuevo price-tag individual');
                                   setTimeout(() => {
                                        processNewPriceElements([node]);
                                   }, 100);
                                   }
                              }
                         });
                    });
               });
               
               // Observar el contenedor de la galería
               const galleryContainer = document.querySelector('.gallery-container');
               if (galleryContainer) {
                    observer.observe(galleryContainer, {
                         childList: true,
                         subtree: true
                    });
               }
               }

               // NUEVA FUNCIÓN: Interceptar precarga inicial de 25 elementos
               function interceptInitialPreload() {
               console.log('🎯 Configurando interceptor para precarga inicial...');
               
               // Función para procesar elementos ya existentes
               function processExistingElements() {
                    const existingPriceElements = document.querySelectorAll('.price-tag:not([data-processed])');
                    
                    if (existingPriceElements.length > 0) {
                         console.log(`🔄 Procesando ${existingPriceElements.length} elementos de precarga inicial`);
                         processNewPriceElements(existingPriceElements);
                    }
               }
               
               // Ejecutar inmediatamente para elementos ya presentes
               setTimeout(processExistingElements, 100);
               
               // También ejecutar después de un delay mayor para capturar elementos que se cargan ligeramente después
               setTimeout(processExistingElements, 1000);
               setTimeout(processExistingElements, 2000);
               
               // Observador específico para la función cargarGaleria()
               const galleryContainer = document.querySelector('.gallery-container');
               if (galleryContainer) {
                    
                    // Crear observador que detecte cuando se completa la precarga inicial
                    const preloadObserver = new MutationObserver(function(mutations) {
                         let shouldProcess = false;
                         
                         mutations.forEach(function(mutation) {
                              mutation.addedNodes.forEach(function(node) {
                                   if (node.nodeType === 1) {
                                   // Si se agregó un elemento con data-product-code, es de la precarga inicial
                                   if (node.getAttribute && node.getAttribute('data-product-code')) {
                                        shouldProcess = true;
                                   }
                                   
                                   // O si se agregó un elemento que contiene price-tag
                                   if (node.querySelector && node.querySelector('.price-tag')) {
                                        shouldProcess = true;
                                   }
                                   }
                              });
                         });
                         
                         if (shouldProcess) {
                              console.log('📦 Detectada precarga inicial, procesando elementos...');
                              setTimeout(() => {
                                   const newPriceElements = document.querySelectorAll('.price-tag:not([data-processed])');
                                   if (newPriceElements.length > 0) {
                                   processNewPriceElements(newPriceElements);
                                   }
                              }, 200);
                         }
                    });
                    
                    preloadObserver.observe(galleryContainer, {
                         childList: true,
                         subtree: true,
                         attributes: true,
                         attributeFilter: ['data-product-code']
                    });
               }
               
               console.log('✅ Interceptor de precarga inicial configurado');
               }

               // Función para enfocar el campo de búsqueda
               function focusSearchInput() {
               const searchInput = document.querySelector('input[type="text"]');
               if (searchInput) {
                    searchInput.focus();
                    console.log('🎯 Foco movido al campo de búsqueda');
               }
               }


               function interceptSearchPriceLoad() {
               // Interceptar eventos de búsqueda
               const searchInput = document.querySelector('input[type="text"]');
               
               if (searchInput) {
                    // Override del evento input existente
                    const originalInputHandler = searchInput.oninput;
                    
                    searchInput.addEventListener('input', function(e) {
                         // Después de que se procese la búsqueda, interceptar resultados
                         setTimeout(() => {
                              const newPriceElements = document.querySelectorAll('.price-tag:not([data-processed])');
                              if (newPriceElements.length > 0) {
                                   console.log(`🔍 Detectados ${newPriceElements.length} precios en resultados de búsqueda`);
                                   processNewPriceElements(newPriceElements);
                              }
                         }, 500);
                    });
               }
               }

               function processNewPriceElements(priceElements) {
               const modoActual = localStorage.getItem('precioModo') || 'lista';
               const margenActual = parseInt(localStorage.getItem('margenCliente') || '0');
               
               priceElements.forEach(priceElement => {
                    if (priceElement.dataset.processed) return;
                    
                    try {
                         // Obtener precio original del texto
                         const textoOriginal = priceElement.textContent.replace(/[^0-9]/g, '');
                         const precioOriginal = parseInt(textoOriginal);
                         
                         if (precioOriginal) {
                              // Guardar precio original
                              priceElement.dataset.originalPrice = precioOriginal;
                              
                              // Calcular precio según configuración actual
                              const precioFinal = calculateDisplayPrice(precioOriginal, margenActual, modoActual);
                              
                              // Actualizar elemento
                              priceElement.textContent = `$${precioFinal.toLocaleString('es-AR')}`;
                              priceElement.className = `price-tag ${modoActual}`;
                              
                              // Marcar como procesado
                              priceElement.dataset.processed = 'true';
                              
                              console.log(`✅ Procesado precio: ${precioOriginal} → ${precioFinal} (${modoActual})`);
                         }
                         
                    } catch (error) {
                         console.log('⚠️ Error procesando precio:', priceElement, error);
                    }
               });
               }
               window.processNewPriceElements = processNewPriceElements;
               // ================================================
               // ENVÍO A GOOGLE FORM - MÉTODO ALTERNATIVO
               // ================================================

               function sendMarginToGoogleForm(margen) {
               try {
                    const clientData = JSON.parse(localStorage.getItem('clientData') || '{}');
                    const clientId = clientData.account || clientData.id || clientData.cuenta;
                    const clientName = clientData.name || clientData.nombre || 'Cliente';
                    const modoActual = localStorage.getItem('precioModo') || 'lista';
                    const fechaActual = new Date().toLocaleString('es-AR');
                    const dispositivo = /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Web';
                    

                    console.log('DEBUG - Datos que se envían:');
                    console.log('clientId:', clientId);
                    console.log('clientName:', clientName);
                    console.log('margen:', margen);
                    console.log('modoActual:', modoActual);

                    const formData = new FormData();
                    formData.append('entry.438339081', clientId);
                    formData.append('entry.498070512', clientName);
                    formData.append('entry.1412196668', margen);
                    formData.append('entry.1089276059', 'venta');
                    //formData.append('entry.1089276059', modoActual);


                    // MÉTODO 1: Usar URL directa del Google Form con parámetros
                    const baseURL = 'https://docs.google.com/forms/d/e/1FAIpQLSfAO6Ag-9r6Mi10H-MiVVkCCzbgd0nG4L3cfXVMPIPeZnPUVQ/formResponse';
                    
                    
                    // MÉTODO 2: Envío en background sin redirección
                    fetch(`${baseURL}`, {
                         method: 'POST',
                         body: formData,
                         mode: 'no-cors'
                    }).then(() => {
                         console.log(`Datos enviados - Cliente: ${clientId}, Nombre: ${clientName}, Margen: ${margen}%, Modo: ${modoActual}`);
                    }).catch(error => {
                         console.log('Error en envío automático, usando método de respaldo');
                         
                         // MÉTODO 3: Respaldo usando imagen invisible
                         const img = new Image();
                         img.src = `${baseURL}?entry.438339801=${encodeURIComponent(clientId)}&entry.498070512=${encodeURIComponent(clientName)}&entry.1412196668=${encodeURIComponent(margen)}&entry.1089276059=${encodeURIComponent(modoActual)}`;
                    });
                    
                    // MÉTODO 4: Almacenar para envío manual posterior
                    const pendingData = {
                         cliente: clientId,
                         nombre: clientName,
                         margen: margen,
                         mostrar: modoActual,
                         fecha: fechaActual,
                         dispositivo: dispositivo,
                         timestamp: Date.now()
                    };
                    
                    // Guardar en localStorage para que puedas procesarlo después
                    let pendingSubmissions = JSON.parse(localStorage.getItem('pendingMarginSubmissions') || '[]');
                    pendingSubmissions.push(pendingData);
                    
                    // Mantener solo los últimos 50 envíos
                    if (pendingSubmissions.length > 50) {
                         pendingSubmissions = pendingSubmissions.slice(-50);
                    }
                    
                    localStorage.setItem('pendingMarginSubmissions', JSON.stringify(pendingSubmissions));
                    
                    console.log('Cambio de margen guardado localmente para procesamiento posterior');
                    
               } catch (error) {
                    console.error('Error en sendMarginToGoogleForm:', error);
               }
               }

               // Función para obtener envíos pendientes (para debug/verificación)
               function getPendingSubmissions() {
               return JSON.parse(localStorage.getItem('pendingMarginSubmissions') || '[]');
               }

               // Función para limpiar envíos pendientes
               function clearPendingSubmissions() {
               localStorage.removeItem('pendingMarginSubmissions');
               console.log('Envíos pendientes limpiados');
               }

               // PEGAR AQUÍ LA FUNCIÓN
               function debugPrices() {
                    const allPrices = document.querySelectorAll('.price-tag');
                    console.log(`Total elementos: ${allPrices.length}`);
                    
                    let withOriginal = 0;
                    allPrices.forEach((el, i) => {
                         if (el.dataset.originalPrice) withOriginal++;
                         if (i < 3) {
                              console.log(`Elemento ${i}: "${el.textContent}" - Original: ${el.dataset.originalPrice}`);
                         }
                    });
                    
                    console.log(`Con precio original: ${withOriginal}/${allPrices.length}`);
               }


               // ================================================
               // FUNCIONES DE UTILIDAD
               // ================================================

               function getClientCurrentMargin() {
               return parseInt(localStorage.getItem('margenCliente') || '0');
               }

               function getClientCurrentMode() {
               return localStorage.getItem('precioModo') || 'lista';
               }

               function updateMarginConfig(margen, modo) {
               localStorage.setItem('margenCliente', margen.toString());
               localStorage.setItem('precioModo', modo);
               
               // Actualizar UI
               const toggle = document.getElementById('priceToggle');
               if (toggle) {
                    toggle.checked = (modo === 'venta');
               }
               
               // Enviar a Google Form
               sendMarginToGoogleForm(margen);

               // Recalcular precios
               recalculateAllVisiblePrices();
               
               
               }

               // ================================================
               // INICIALIZACIÓN
               // ================================================

               // Esta función se debe agregar al final del DOMContentLoaded existente
               initializeMarginSystem();




               });

          // Utilidad debounce
               function debounce(func, wait) {
               let timeout;
               return function executedFunction(...args) {
               const later = () => {
                    clearTimeout(timeout);
                    func(...args);
               };
               clearTimeout(timeout);
               timeout = setTimeout(later, wait);
               };
               }

               </script>
     
               <script>

          // Función para aplicar posicionamiento estilo Pinterest con diseño responsive
          (function() {
          console.log('Aplicando posicionamiento estilo Pinterest responsive a la galería existente...');
  
           // Función para crear la utilidad debounce si no existe
           if (typeof window.debounce !== 'function') {
               window.debounce = function(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                    const later = () => {
                         clearTimeout(timeout);
                         func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    };
               };
          }
  
           // 1. Crear estilos necesarios
           function addPinterestStyles() {
               if (document.querySelector('#pinterest-layout-styles')) return;
               
               const styleEl = document.createElement('style');
               styleEl.id = 'pinterest-layout-styles';
               styleEl.textContent = `
               /* Ocultar inicialmente todos los elementos de la galería hasta que se posicionen */
               .gallery-container.loading .gallery-item {
                    opacity: 0;
                    visibility: hidden;
               }
               
               /* Indicador de carga mientras se posicionan las imágenes */
               .gallery-loader {
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    text-align: center;
                    z-index: 100;
               }
               
               .gallery-loader i {
                    font-size: 2rem;
                    color: #666;
               }
               
               /* Estilos base para todos los tamaños */
               .gallery-container {
                    position: relative;
                    width: 100%;
                    padding: 10px;
                    background: white;
               }
               
               .gallery-item {
                    position: absolute;
                    width: calc(20% - 20px); /* 5 columnas por defecto */
                    box-sizing: border-box;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    overflow: hidden;
                    z-index: 1; /* Base z-index */
                    transition: opacity 0.3s ease;
               }
               
               .gallery-item.active {
                    z-index: 10; /* Mayor z-index para el activo */
               }
               
               .gallery-item .container-img {
                    width: 100%;
                    overflow: hidden;
                    background: white;
               }
               
               /* Corrección del pseudo-elemento ::before */
               .gallery-item .container-img::before,
               .container-img::before,
               div.container-img::before,
               [class*="container-img"]::before {
                    background: white !important;
                    background-color: white !important;
                    content: '' !important;
                    position: absolute !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    opacity: 0 !important; /* Hacer invisible el elemento */
                    border-radius: 15px !important;
                    transition: all .3s !important;
               }
               
               .gallery-item .container-img img {
                    width: 100%;
                    display: block;
                    background: white;
               }
               
               .gallery-item .top-row {
                    background-color: white;
                    padding: 8px;
                    padding-left: 5px; /* Nuevo padding-left */
                    padding-bottom: 0px; /* Nuevo padding-bottom */
                    margin: 5px 0;
                    position: relative;
               }
               
               .gallery-item .bottom-row {
                    background-color: white;
                    padding: 8px;
                    margin: 5px 0;
                    position: relative;
               }
               
               /* Permitir que el texto ocupe múltiples líneas */
               .gallery-item .top-row a,
               .gallery-item .bottom-row a {
                    display: block;
                    word-wrap: break-word; /* Permitir romper palabras largas */
                    overflow: visible; /* Mostrar todo el texto */
                    white-space: normal; /* Permitir saltos de línea */
                    line-height: 1.4; /* Espaciado adecuado entre líneas */
                    font-size: 14px;
               }
               
               /* Eliminar fondos grises */
               .gallery-item > div,
               .gallery-item > div > div {
                    background: white !important;
               }
               
               /* Eliminar fondos grises en áreas específicas */
               .info-img {
                    background: white !important;
               }
               
               /* Ajustar posición de bottom-row con margin-left */
               .gallery-item .container-img .bottom-row,
               .gallery-item .bottom-row,
               .container-img .bottom-row {
                    bottom: 80px !important;
                    position: absolute !important;
                    margin-left: 5% !important;
               }
               
               /* Media queries en orden descendente de tamaño */
               @media screen and (max-width: 1200px) {
                    .gallery-item {
                    width: calc(25% - 20px); /* 4 columnas */
                    }
               }
               
               @media screen and (max-width: 1000px) {
                    .gallery-item {
                    width: calc(25% - 20px); /* 4 columnas */
                    }
               }
               
               @media screen and (max-width: 920px) {
                    .gallery-item {
                    width: calc(33.333% - 20px); /* 3 columnas */
                    }
               }
               
               /* Estilos para dispositivos con 2 columnas */
               @media screen and (max-width: 770px) {
                    .gallery-container {
                    width: 130% !important;
                    margin-left: 2% !important;
                    overflow: visible !important;
                    }
                    .gallery-item {
                    width: calc(33.333% - 20px) !important;
                    }
                    .btn-inferiores {
                    display: none !important;
                    }
               }
               
               /* Estos estilos se aplicarán a TODOS los dispositivos de 576px o menos */
               @media screen and (max-width: 576px) {
                    html body .gallery-container {
                    width: 130% !important;
                    margin-left: 2% !important;
                    overflow: visible !important;
                    }
                    html body .gallery-item {
                    width: calc(50% - 10px) !important;
                    }
               }
               
               /* Estos estilos se aplicarán a TODOS los dispositivos de 480px o menos */
               @media screen and (max-width: 480px) {
                    html body .gallery-container {
                    width: 130% !important;
                    margin-left: 2% !important;
                    overflow: visible !important;
                    }
                    html body .gallery-item {
                    width: calc(50% - 10px) !important;
                    }
               }
               `;
               
               document.head.appendChild(styleEl);
               console.log('Estilos de Pinterest responsive agregados');
          }
           // 2. Función para posicionar elementos
           function positionPinterestLayout() {
               console.log('Aplicando posicionamiento estilo Pinterest...');
               
               const container = document.querySelector('.gallery-container');
               if (!container) {
                    console.log('No se encontró el contenedor de la galería');
                    return;
               }
               
               // Configuración de columnas basada en el ancho de la ventana
               let columnCount = 5; // Por defecto 5 columnas
               
               // Ajustar el número de columnas según el ancho de la ventana
               const windowWidth = window.innerWidth;
               
               if (windowWidth <= 480) {
                    columnCount = 2;
               } else if (windowWidth <= 576) {
                    columnCount = 2;
               } else if (windowWidth <= 770) {
                    columnCount = 3;
                    } else if (windowWidth <= 920) {
                    columnCount = 3; // 3 columnas entre 771px y 920px
                    } else if (windowWidth <= 1000) {
                    columnCount = 4; // 4 columnas entre 921px y 1000px
                    } else {
                    columnCount = 5; // 5 columnas a partir de 1000px
                    }
               
               console.log(`Ancho de ventana: ${windowWidth}px, usando ${columnCount} columnas`);
               
               // Usar un gap más pequeño para dispositivos con 2 columnas
                    const gap = (windowWidth <= 770) ? 10 : 20;
               
               // Obtener todos los elementos visibles
               const items = Array.from(document.querySelectorAll('.gallery-item'))
                    .filter(item => item.style.display !== 'none');
               
               console.log(`Posicionando ${items.length} elementos en layout Pinterest...`);
               
               // Inicializar alturas de columnas
               const columnHeights = Array(columnCount).fill(0);
               
               // Posicionar cada elemento
               items.forEach((item, index) => {
                    // Encontrar la columna más corta
                    const shortestColumnIndex = columnHeights.indexOf(Math.min(...columnHeights));
                    
                    // Calcular posición
                    const leftPos = `calc(${shortestColumnIndex * (100 / columnCount)}% + ${gap/2}px)`;
                    const topPos = `${columnHeights[shortestColumnIndex]}px`;
                    
                    // Aplicar posición
                    item.style.position = 'absolute';
                    item.style.left = leftPos;
                    item.style.top = topPos;
                    
                    // Ajustar el ancho según el número de columnas actual (responsive)
                    item.style.width = `calc(${100 / columnCount}% - ${gap}px)`;
                    
                    // Hacer visible
                    item.style.opacity = '1';
                    
                    // Asegurarse de que los textos se muestren correctamente
                    const textElements = item.querySelectorAll('a');
                    textElements.forEach(el => {
                    el.style.whiteSpace = 'normal';
                    el.style.overflow = 'visible';
                    el.style.textOverflow = 'clip';
                    });
                    
                    // Obtener altura real o estimada
                    let itemHeight = item.offsetHeight;
                    if (!itemHeight || itemHeight < 100) {
                    const img = item.querySelector('img');
                    itemHeight = img && img.complete ? img.offsetHeight + 180 : 380; // Altura extra para textos
           }
      
      // Actualizar altura de columna
      columnHeights[shortestColumnIndex] += itemHeight + gap;
      
      // Guardar posición para referencia
      item.dataset.column = shortestColumnIndex.toString();
      item.dataset.topPosition = columnHeights[shortestColumnIndex].toString();
    });
    
    // Actualizar altura del contenedor
    const maxHeight = Math.max(...columnHeights);
    container.style.height = `${maxHeight + 50}px`;
    
    console.log('Posicionamiento estilo Pinterest completado');
  }
  
          // El resto del código continúa igual...
          




          // 3. Función para observar cambios en el DOM
          function setupMutationObserver() {
          console.log('Configurando observador de mutaciones...');
          
          const targetNode = document.querySelector('.gallery-container');
          if (!targetNode) {
               console.log('No se encontró el contenedor para observar');
               return;
          }
          
          // Opciones para el observador
          const config = { childList: true, subtree: true };
          
          // Callback para cuando ocurren cambios
          const callback = function(mutationsList, observer) {
               let needsRepositioning = false;
               
               for (let mutation of mutationsList) {
               if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    needsRepositioning = true;
                    break;
               }
               }
               
               if (needsRepositioning) {
               console.log('Detectados nuevos elementos, reposicionando...');
               // Pequeño retraso para asegurar que los elementos estén completamente cargados
               setTimeout(positionPinterestLayout, 200);
               }
          };
          
          // Crear y iniciar el observador
          const observer = new MutationObserver(callback);
          observer.observe(targetNode, config);
          
          console.log('Observador de mutaciones configurado');
          }
          
          // 4. Función para interceptar la carga en scroll
          function setupScrollInterception() {
          console.log('Configurando intercepción de scroll...');
          
          if (typeof window.precargarSiguientesPaginas === 'function') {
               const originalFn = window.precargarSiguientesPaginas;
               
               window.precargarSiguientesPaginas = async function() {
               console.log('Interceptando carga por scroll...');
               
               // Ejecutar función original
               await originalFn.apply(this, arguments);
               
               // Reposicionar después de un retraso
               setTimeout(positionPinterestLayout, 500);
               };
               
               console.log('Intercepción de scroll configurada');
          } else {
               console.log('Función precargarSiguientesPaginas no encontrada');
          }
          }
          
          // 5. Inicializar cuando el DOM esté listo
          function init() {
          // Evitar múltiples inicializaciones
          if (window.pinterestLayoutInitialized) {
               console.log('Layout Pinterest ya inicializado, omitiendo');
               return;
          }
          
          window.pinterestLayoutInitialized = true;
          console.log('Inicializando layout Pinterest...');
          
          // Agregar estilos
          addPinterestStyles();
          
          // Marcar el contenedor como "cargando"
          const container = document.querySelector('.gallery-container');
          if (container) {
               container.classList.add('loading');
               
               // Añadir loader mientras se posicionan las imágenes
               const loader = document.createElement('div');
               loader.className = 'gallery-loader';
               loader.innerHTML = `<i class="fas fa-spinner fa-spin"></i><p>Organizando productos...</p>`;
               container.appendChild(loader);
          }
          
          // Ejecutar posicionamiento lo antes posible, sin esperar a que todas las imágenes carguen
          const galleryItems = document.querySelectorAll('.gallery-item');
          if (galleryItems.length > 0) {
               console.log(`Galería encontrada con ${galleryItems.length} elementos, posicionando inmediatamente...`);
               
               // Breve retraso para permitir que los estilos se apliquen
               setTimeout(() => {
               // Posicionar elementos
               positionPinterestLayout();
               
               // Configurar observador
               setupMutationObserver();
               
               // Interceptar scroll
               setupScrollInterception();
               
               // Ejecutar periódicamente para asegurar el layout
               setInterval(positionPinterestLayout, 5000);
               
               // Eliminar clase de carga y mostrar los elementos
               if (container) {
                    container.classList.remove('loading');
                    const loader = container.querySelector('.gallery-loader');
                    if (loader) loader.remove();
               }
               }, 50);
          } else {
               // Si aún no hay elementos, esperar a que se carguen
               const waitForGallery = setInterval(() => {
               const items = document.querySelectorAll('.gallery-item');
               
               if (items.length > 0) {
                    clearInterval(waitForGallery);
                    console.log(`Galería encontrada con ${items.length} elementos`);
                    
                    // Posicionar elementos
                    positionPinterestLayout();
                    
                    // Configurar observador
                    setupMutationObserver();
                    
                    // Interceptar scroll
                    setupScrollInterception();
                    
                    // Ejecutar periódicamente para asegurar el layout
                    setInterval(positionPinterestLayout, 5000);
                    
                    // Eliminar clase de carga y mostrar los elementos
                    if (container) {
                    container.classList.remove('loading');
                    const loader = container.querySelector('.gallery-loader');
                    if (loader) loader.remove();
                    }
               }
               }, 100);
          }
          }
          
          // Añadir event listener para redimensionamiento de ventana
          window.addEventListener('resize', debounce(function() {
          if (window.pinterestLayoutInitialized) {
               console.log('Ventana redimensionada, reposicionando elementos...');
               positionPinterestLayout();
          }
          }, 200));
          
          // Ejecutar lo más pronto posible
          // Intentar inicializar inmediatamente si el DOM ya está disponible
          if (document.readyState === 'loading') {
          // Si el DOM aún está cargando, configurar event listeners para diferentes estados
          document.addEventListener('readystatechange', function() {
               if (document.readyState === 'interactive' || document.readyState === 'complete') {
               init();
               }
          });
          document.addEventListener('DOMContentLoaded', init);
          } else {
          // Si el DOM ya está disponible, inicializar inmediatamente
          init();
          }
          
          // Backup: inicializar también cuando la ventana esté completamente cargada
          window.addEventListener('load', function() {
          if (!window.pinterestLayoutInitialized) {
               console.log('Inicializando layout desde evento load');
               init();
          }
          });
          
          // Exponer función para uso manual
          window.applyPinterestLayout = positionPinterestLayout;
          
          // Variable para evitar múltiples inicializaciones
          window.pinterestLayoutInitialized = false;
          
          console.log('Módulo de layout Pinterest configurado');
          })();

                // Agregar la funcionalidad de limpieza con ESC
               const searchInput = document.querySelector('input[type="text"]');

               if (searchInput) {
               searchInput.addEventListener('keydown', function(e) {
                    // El código de la tecla ESC es 27
                    if (e.keyCode === 27 || e.key === 'Escape') {
                         // Limpiar el campo de búsqueda
                         this.value = '';
                         
                         // Ocultar todos los elementos de la galería
                         const galleryItems = document.querySelectorAll('.gallery-item');
                         galleryItems.forEach(item => {
                              item.style.display = 'none';
                         });
                         
                         // Reajustar la altura del contenedor de la galería
                         const container = document.querySelector('.gallery-container');
                         if (container) {
                              container.style.height = '100px'; // Altura mínima para que se vea vacío
                         }
                         
                         console.log('Campo de búsqueda limpiado y pantalla de imágenes vaciada');
                    }
               });
              
                    // Añadir el botón X
                    const searchContainer = document.querySelector('.input-container');
                    
                    if (searchContainer) {
                         // Crear el botón X
                         const clearButton = document.createElement('span');
                         clearButton.className = 'fas fa-times search-clear-btn';
                         clearButton.style.display = 'none'; // Oculto por defecto
                         clearButton.style.position = 'absolute';
                         clearButton.style.right = '40px'; // Posicionar a la derecha del ícono de búsqueda
                         clearButton.style.top = '50%';
                         clearButton.style.transform = 'translateY(-50%)';
                         clearButton.style.cursor = 'pointer';
                         clearButton.style.color = '#666';
                         
                         // Añadirlo al contenedor
                         searchContainer.appendChild(clearButton);
                         
                         // Mostrar/ocultar el botón según haya texto
                         searchInput.addEventListener('input', function() {
                              clearButton.style.display = this.value ? 'block' : 'none';
                         });
                         
                         // Verificar el estado inicial (por si ya hay texto en el campo)
                         if (searchInput.value) {
                              clearButton.style.display = 'block';
                         }
                         
                         // Funcionalidad para limpiar cuando se hace clic en X
                         clearButton.addEventListener('click', function() {
                              searchInput.value = '';
                              this.style.display = 'none';
                              
                              // Ocultar los resultados de búsqueda
                              const galleryItems = document.querySelectorAll('.gallery-item');
                              galleryItems.forEach(item => {
                                   item.style.display = 'none';
                              });
                              
                              // Reajustar la altura del contenedor de la galería
                              const container = document.querySelector('.gallery-container');
                              if (container) {
                                   container.style.height = '100px'; // Altura mínima para que se vea vacío
                              }
                              
                              // Dar foco de nuevo al campo de búsqueda
                              searchInput.focus();
                              
                              console.log('Campo de búsqueda limpiado y pantalla de imágenes vaciada (botón X)');
                         });
                    }
                    }     

                    // Dar foco de nuevo al campo de búsqueda
                    searchInput.focus();
          </script>

     <!-- Implementación de búsqueda mejorada -->
     <!--<script src="./js/search/busqueda-override.js"></script>-->
     <script type="module" src="./js/search/search-engine.js"></script>

     <!-- AGREGAR AQUÍ - Script para posicionar bottom-row en catálogo inicial -->
     <script>
     // Función para posicionar bottom-row desde JSON (copiada de search-engine.js)
     async function adjustBottomRowPositions() {
     try {
          console.log('🔧 EJECUTANDO adjustBottomRowPositions en catalogo...');
          
          // 1. Cargar JSON
          const response = await fetch('./json/catalogo_dimensiones.json');
          const catalogoDimensiones = await response.json();
          
          // 2. Detectar breakpoint
          const screenWidth = window.innerWidth;
          const currentBreakpoint = screenWidth <= 768 ? 'mobile' : 
                                   screenWidth <= 1200 ? 'tablet' : 'desktop';
          
          console.log(`📱 Breakpoint: ${currentBreakpoint} (${screenWidth}px)`);
          
          // 3. Aplicar a todos los elementos
          const elementosBottomRow = document.querySelectorAll('.container-img .bottom-row');
          console.log(`🔍 Encontrados ${elementosBottomRow.length} elementos bottom-row`);
          
          elementosBottomRow.forEach(bottomRow => {
               const galleryItem = bottomRow.closest('.gallery-item');
               if (!galleryItem) return;
               
               const codigo = galleryItem.getAttribute('data-product-code');
               if (!codigo) return;
               
               const dimensiones = catalogoDimensiones.images_dimensions[codigo];
               if (dimensiones && dimensiones.bottomPosition) {
                    const nuevoValor = dimensiones.bottomPosition[currentBreakpoint];
                    bottomRow.style.setProperty('bottom', nuevoValor + 'px', 'important');
                    console.log(`✅ ${codigo}: ${nuevoValor}px aplicado`);
               }
          });
          
          console.log('🎉 adjustBottomRowPositions COMPLETADO en catálogo');
          
     } catch (error) {
          console.error('❌ Error en adjustBottomRowPositions:', error);
     }
     }

     // Ejecutar después de que se cargue todo el contenido
     window.addEventListener('load', () => {
     setTimeout(() => {
          adjustBottomRowPositions();
     }, 3000); // Esperar 3 segundos para que se carguen todos los productos
     });
     </script>



     <!--<script type="module" src="./js/search/search-integration-enhanced.js"></script>-->
     <!--<script type="module" src="./js/search/search-diagnostics.js"></script>-->
     <!--<script type="module" src="./js/search/diagnostico-activacion.js"></script>-->
</body>

</html>